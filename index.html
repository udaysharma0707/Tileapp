<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tile Purchase Entry App</title>
  <link rel="manifest" href="manifest.json">
  <style>
    html,body { height:100%; margin:0; padding:0; }
    body {
      background-image: url('./background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      font-family: Arial, sans-serif;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    .container {
      width:100%;
      max-width:920px;
      background: rgba(255,255,255,0.98);
      border-radius:10px;
      padding:14px;
      box-sizing:border-box;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      position: relative;
    }

    h1{font-size:20px;margin:0 0 10px 0; display:flex; align-items:center; gap:8px;}
    .gear {
      margin-left:auto; cursor:pointer; font-size:18px; color:#2c7be5;
    }
    
    .q-label{display:block;margin-top:10px;font-weight:600}
    input[type="text"], input[type="number"], select, textarea {
      width:100%; padding:8px; font-size:15px; margin-top:6px; box-sizing:border-box;
      border:1px solid #ccc; border-radius:4px;
    }

    .upload-area {
            border: 3px dashed #2196F3;
            border-radius: 15px;
            padding: 40px 20px;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

    .upload-area:hover {
            border-color: #1976D2;
            background: #e3f2fd;
        }
        
        .upload-area.dragover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
    .upload-icon {
            font-size: 4rem;
            color: #2196F3;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
    .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 150px;
        }
        
        .btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
         .camera-btn {
            background: #4CAF50;
        }
        
        .camera-btn:hover {
            background: #45a049;
        }
        
        .preview-container {
            margin: 20px 0;
            display: none;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
     .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

    /* --- Voice-to-Text UI styles (paste inside the existing <style>) --- */
.voice-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
.voice-btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #2c7be5;
  background: #fff;
  color:#2c7be5;
  cursor:pointer;
  font-weight:700;
  box-shadow: 0 3px 8px rgba(44,123,229,0.12);
  transition: transform .12s ease, background .12s ease, color .12s ease;
}
.voice-btn:active { transform: translateY(1px); }
.voice-btn.listening {
  background: linear-gradient(90deg,#ff6767,#ffb86b);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 8px 20px rgba(255,120,90,0.18);
  animation: pulse 1.2s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 6px 18px rgba(255,120,90,0.12); }
  50% { box-shadow: 0 18px 34px rgba(255,120,90,0.18); }
  100% { box-shadow: 0 6px 18px rgba(255,120,90,0.12); }
}
.voice-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.voice-small { font-size:13px; color:#444; }
.voice-lang, .voice-mode { padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; }
.voice-status { font-size:13px; padding:6px 10px; border-radius:6px; background:#f6f8fb; border:1px solid #e8eefc; color:#333; }
.voice-confidence { font-weight:700; margin-left:6px; color:#2c7be5; }
.voice-note { font-size:12px; color:#666; }
.voice-btn .mic-icon { font-size:18px; display:inline-block; transform:translateY(-1px); }


  
    /* main item row and nested sublist */
    .item-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .item-row label { flex:1; display:flex; align-items:center; gap:8px; }
    .qty { width:110px; flex:0 0 110px; }
    .sublist { margin-left:28px; margin-top:6px; padding-left:6px; border-left:2px solid rgba(0,0,0,0.04); display:none; }
    .sub-item { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .sub-item label { flex:1; display:flex; align-items:center; gap:8px; }
    .checkbox-row { margin-top:6px; padding:0; }
    .cb { display:block; width:100%; padding:6px 0; box-sizing:border-box; }

    /* Photo Upload Styles (integrated from photo webapp) */
    .photo-section {
      margin-top: 20px;
      border-top: 2px solid #f0f0f0;
      padding-top: 20px;
    }
    
    .upload-area {
      border: 3px dashed #2196F3;
      border-radius: 15px;
      padding: 30px 20px;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9ff;
      text-align: center;
    }
    
    .upload-area:hover {
      border-color: #1976D2;
      background: #e3f2fd;
    }
    
    .upload-area.dragover {
      border-color: #4CAF50;
      background: #e8f5e8;
    }
    
    .upload-icon {
      font-size: 3rem;
      color: #2196F3;
      margin-bottom: 10px;
    }
    
    .upload-text {
      color: #666;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    
    .file-input {
      display: none;
    }
    
    .btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      min-width: 120px;
    }
    
    .btn:hover {
      background: #1976D2;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .camera-btn {
      background: #4CAF50;
    }
    
    .camera-btn:hover {
      background: #45a049;
    }
    
    .preview-container {
      margin: 20px 0;
      display: none;
      text-align: center;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 250px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      margin-bottom: 15px;
    }
    
    .status {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      display: none;
      margin: 20px 0;
      text-align: center;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2196F3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  /* ===== ULTRA-COMPACT SEARCH SYSTEM (TINY MOBILE CONTROLS) ===== */
.search-container {
  margin: 10px 0;
  border: 2px solid #e3f2fd;
  border-radius: 8px;
  padding: 10px;
  background: #f8f9ff;
}

.search-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 5px;
}

.search-input {
  flex: 1;
  padding: 8px 30px 8px 10px;
  font-size: 14px;
  border: 2px solid #2196F3;
  border-radius: 6px;
  background: white;
  box-sizing: border-box;
}

.search-input:focus {
  outline: none;
  border-color: #1976D2;
  box-shadow: 0 0 4px rgba(33, 150, 243, 0.3);
}

.search-clear-btn {
  position: absolute;
  right: 8px;
  background: none;
  border: none;
  font-size: 16px;
  color: #999;
  cursor: pointer;
  padding: 2px;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-clear-btn:hover {
  color: #666;
  background: #f0f0f0;
  border-radius: 50%;
}

.search-count {
  font-size: 12px;
  color: #666;
  font-weight: 500;
  min-width: 60px;
  white-space: nowrap;
}

.search-results {
  background: white;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.06);
}

.search-group {
  border-bottom: 1px solid #eee;
}

.search-group:last-child {
  border-bottom: none;
}

.search-group-header {
  background: #f5f5f5;
  padding: 6px 10px;
  font-weight: 600;
  font-size: 13px;
  color: #333;
  border-bottom: 1px solid #ddd;
}

.search-group-items {
  padding: 2px 0;
}

/* SINGLE LINE LAYOUT FOR SUB-ITEMS */
.search-result-item {
  display: flex;
  align-items: center;
  padding: 4px 8px;
  margin: 0;
  cursor: pointer;
  min-height: 36px; /* Reduced for compactness */
  border-bottom: 1px solid #f8f8f8;
  gap: 8px; /* Space between elements */
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background: #f0f8ff;
}

.search-result-item.focused {
  background: #e3f2fd;
  box-shadow: inset 2px 0 0 #2196F3;
}

.search-result-item.selected {
  background: #e8f5e8;
}

/* CHECKBOX AREA */
.search-result-checkbox {
  transform: scale(1.6);
  margin: 1;
  flex-shrink: 0;
}

/* TEXT AREA - TAKES AVAILABLE SPACE */
.search-result-text {
  flex: 1;
  font-size: 13px;
  line-height: 1.2;
  min-width: 0;
  word-break: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-right: 6px;
}

/* TINY QTY + UNIT CONTROLS IN ONE LINE */
.search-qty-unit {
  display: flex;
  align-items: center;
  gap: 3px;
  flex-shrink: 0;
}

/* LARGER QUANTITY INPUT - MORE COMFORTABLE */
.search-qty-input {
  width: 100px !important; /* Increased from 50px */
  height: 28px; /* Increased height */
  padding: 3px 5px; /* More padding */
  font-size: 12px; /* Larger font */
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: center;
  box-sizing: border-box;
  background: white;
}

.search-qty-input:disabled {
  background: #f8f8f8;
  color: #aaa;
}

.search-qty-input:focus {
  outline: none;
  border-color: #2196F3;
  box-shadow: 0 0 4px rgba(33, 150, 243, 0.3);
}

/* UNIT SELECT - PROPORTIONAL SIZE */
.search-unit-select {
  width: 70px !important; /* Increased from 60px */
  height: 28px; /* Match qty input height */
  padding: 2px 4px;
  font-size: 11px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: white;
  box-sizing: border-box;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 3px center;
  background-size: 12px;
  padding-right: 20px;
}

.search-unit-select:disabled {
  background-color: #f8f8f8;
  color: #aaa;
}

.search-unit-select:focus {
  outline: none;
  border-color: #2196F3;
  box-shadow: 0 0 4px rgba(33, 150, 243, 0.3);
}

/* CUSTOM UNIT INPUT */
.search-custom-unit {
  width: 100px !important; /* Increased from 60px */
  height: 28px; /* Match other inputs */
  padding: 3px 5px;
  font-size: 11px;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
  background: white;
}

.search-custom-unit:disabled {
  background: #f8f8f8;
  color: #aaa;
}

.search-custom-unit:focus {
  outline: none;
  border-color: #2196F3;
  box-shadow: 0 0 4px rgba(33, 150, 243, 0.3);
}


.search-highlight {
  background: #ffeb3b;
  padding: 1px 2px;
  border-radius: 2px;
  font-weight: 600;
}

.search-no-results {
  padding: 24px 12px;
  text-align: center;
}

.no-results-message {
  font-size: 14px;
  color: #666;
  margin-bottom: 12px;
}

.add-subitem-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  min-height: 36px;
}

.add-subitem-btn:hover {
  background: #45a049;
}

.add-subitem-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.add-subitem-modal-content {
  background: white;
  padding: 16px;
  border-radius: 6px;
  width: 90%;
  max-width: 320px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.3);
}

.add-subitem-modal h3 {
  margin: 0 0 12px 0;
  color: #333;
  font-size: 16px;
}

.add-subitem-form label {
  display: block;
  margin: 10px 0 3px 0;
  font-weight: 600;
  font-size: 12px;
}

.add-subitem-category,
.add-subitem-label {
  width: 100%;
  padding: 6px;
  border: 1px solid #ddd;
  border-radius: 3px;
  font-size: 13px;
  box-sizing: border-box;
}

.add-subitem-actions {
  display: flex;
  gap: 6px;
  margin-top: 12px;
}

.add-subitem-confirm {
  background: #4CAF50 !important;
  flex: 1;
  padding: 8px 10px;
  font-size: 12px;
}

.add-subitem-cancel {
  background: #999 !important;
  flex: 1;
  padding: 8px 10px;
  font-size: 12px;
}

/* Screen reader announcements */
#sr-announce {
  position: absolute !important;
  left: -10000px !important;
  width: 1px !important;
  height: 1px !important;
  overflow: hidden !important;
}

/* DESKTOP VERSION - EVEN LARGER */
@media (min-width: 769px) {
  .search-qty-input {
    width: 100px !important; /* Desktop: 75px */
    height: 30px;
    font-size: 13px;
    padding: 4px 6px;
  }
  
  .search-result-text {
    font-size: 14px;
  }
  
  .search-qty-input {
    width: 85px !important;
    height: 28px;
    font-size: 12px;
  }
  
  .search-unit-select {
    width: 100px !important; /* Desktop: 80px */
    height: 30px;
    font-size: 12px;
    padding: 3px 5px;
    padding-right: 22px;
  }
  search-custom-unit {
    width: 110px !important; /* Desktop: 85px */
    height: 30px;
    font-size: 12px;
    padding: 4px 6px;
  }
}

/* MOBILE - COMFORTABLE SIZE */
@media (max-width: 768px) {
  .search-qty-input {
    min-height: 32px; /* Touch-friendly */
    font-size: 14px; /* Prevent zoom on iOS */
  }
  
  .search-result-item {
    min-height: 36px;
    padding: 3px 6px;
  }
  
  .search-result-text {
    font-size: 13px;
  }
  
  .search-checkbox {
    transform: scale(1.2); /* Slightly larger for touch */
  }
  
  /* Keep tiny inputs but ensure they're tappable */
  .search-qty-input,
  .search-unit-select,
  .search-custom-unit {
    min-height: 26px; /* Ensure touch-friendly */
  }
}

/* VERY SMALL SCREENS - KEEP SINGLE LINE */
@media (max-width: 480px) {
  .search-result-item {
    gap: 4px; /* Tighter spacing */
  }
  
  .search-result-text {
    font-size: 12px;
  }
  
  .search-qty-input {
    width: 60px !important; /* Even smaller on tiny screens */
  }
  
 .search-unit-select {
    min-height: 32px;
    font-size: 14px;
  }
  
  .search-custom-unit {
    min-height: 32px;
    font-size: 14px;
  }
}

/* HIGH CONTRAST MODE */
@media (prefers-contrast: high) {
  .search-highlight {
    background: #000;
    color: #fff;
  }
}




    /* quantity + unit inline controls */
    .qty-unit {
      display:flex;
      gap:6px;
      align-items:center;
      min-width:240px;
      justify-content:flex-end;
    }
    .qty-unit input[type="number"] { width:90px; padding:6px; font-size:14px; }
    .qty-unit select { width:120px; padding:6px; font-size:14px; }
    .qty-unit .unit-custom { width:110px; padding:6px; font-size:14px; display:none; }

    /* payment inline controls */
    .mode-row { display:flex; align-items:center; gap:12px; margin-top:6px; }
    .mode-row .mode-label { flex:1; display:flex; align-items:center; gap:8px; }
    .mode-amount { width:160px; flex:0 0 160px; }
    .total-row { margin-top:8px; display:flex; gap:12px; align-items:center; }
    .total-row label { font-weight:600; }

    button{ margin-top:12px; padding:10px 14px; font-size:16px; border-radius:6px; border: none; background:#2c7be5; color:white; cursor:pointer; }
    button#clearBtn { background:#6c757d; }
    .offline-msg { margin-top:10px; color:#b71c1c; font-weight:700; font-size:15px; }
    .small{font-size:13px;color:#666;margin-top:6px}
    .form-actions { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }

    @media (max-width:920px){
      .container { padding:10px; }
    }
    @media (max-width:620px){
      .item-row { flex-direction:column; align-items:flex-start }
      .qty { width:100%; flex:0 0 auto }
      .sub-item { flex-direction:column; align-items:flex-start }
      .mode-row { flex-direction:column; align-items:stretch }
      .mode-amount { width:100%; flex:auto }
      .total-row { flex-direction:column; align-items:stretch }
      .qty-unit { width:100%; justify-content:flex-start; }
      .qty-unit input[type="number"], .qty-unit select, .qty-unit .unit-custom { width:40%; }
    }

    /* make touch targets larger for checkboxes (and slightly larger radios) */
    input[type="checkbox"] {
      transform: scale(1.45);
      margin-right: 10px;
      -webkit-transform: scale(1.45);
      -webkit-margin-end: 10px;
    }
    input[type="radio"] {
      transform: scale(1.25);
      margin-right: 8px;
      -webkit-transform: scale(1.25);
    }
    .cb input[type="checkbox"], .cb input[type="radio"] {
      vertical-align: middle;
    }

    /* editable label visuals */
    .editable { padding:2px 6px; border-radius:4px; cursor:text; display:inline-block; }
    .customize-mode .editable { background: #fffbe6; border:1px dashed #ffd966; }
    .editable[contenteditable="true"] { outline: 2px solid #2c7be5; background: #ffffff; }

    /* small modal panel for customization instructions & buttons */
    #customPanel {
      position: fixed;
      left: 50%;
      top: 90px;
      transform: translateX(-50%);
      width: 760px;
      max-width: calc(100% - 48px);
      background: white;
      border-radius:8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      padding:12px;
      z-index: 1200;
      display:none;
      max-height: calc(80vh);
      overflow: auto;
      box-sizing: border-box;
    }
    #customPanel .panel-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    #customPanel .panel-row .note { flex:1; font-size:14px; color:#333; }
    #customPanel .panel-actions { display:flex; gap:8px; }
    #customPanel .close-x { position:absolute; right:10px; top:8px; background:transparent; border:none; font-size:20px; cursor:pointer; }

    /* small top-right badge showing Customize mode on */
    .custom-mode-badge {
      position: absolute; right: 16px; top: 12px; padding:6px 8px; background:#fff4cc; border-radius:6px; color:#6a4f00; font-weight:700; display:none;
    }
    .customize-mode .custom-mode-badge { display:block; }

    /* prevent pointer interactions for inputs while editing (applied when customization active) */
    .customize-mode .no-pointer { pointer-events: none; opacity: 0.7; }

    /* MOBILE-SPECIFIC: make popup portrait-shaped and centered for small screens */
    @media (max-width: 600px) {
      #customPanel {
        width: 92vw;
        max-width: 420px;
        height: 70vh;
        max-height: 70vh;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.45);
        overflow: auto;
      }
      #customPanel .panel-row { flex-direction: column; align-items:stretch; gap:10px; }
      #customPanel .panel-actions { flex-wrap:wrap; justify-content:flex-end; }
      #customPanel .close-x { font-size:22px; right:6px; top:6px; }
    }

    /* delete button next to labels (hidden by default, shown in customize mode) */
    .del-btn {
      display: none;
      background: transparent;
      border: none;
      color: #b71c1c;
      font-weight: 700;
      cursor: pointer;
      padding: 2px 6px;
      margin-left: 6px;
      border-radius: 4px;
    }
    .customize-mode .del-btn { display: inline-block; }

    /* inline remove-circle used while customizing (generated by JS) */
    .remove-checkbox {
      display:inline-flex;
    }

    /* Purchased-from custom manager styling */
    #customVendorManager {
      border:1px dashed #cfcfcf;
      padding:8px;
      border-radius:6px;
      background:#fafafa;
      margin-top:8px;
    }
    #customVendorManager .vendor-list { max-height:160px; overflow:auto; margin-bottom:8px; }
    #customVendorManager .vendor-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px; border-radius:4px; background:white; margin-bottom:6px; border:1px solid #eee; }
    #customVendorManager .vendor-item button { background:#b71c1c; padding:6px 8px; border-radius:6px; border:none; font-weight:700; }
    #customVendorManager .vendor-actions { display:flex; gap:8px; align-items:center; }
    #customVendorManager input[type="text"] { margin-top:0; margin-bottom:0; }
    
    /* Unit management styling */
    .unit-item { display:flex; align-items:center; gap:8px; padding:6px; background:white; margin-bottom:6px; border:1px solid #eee; border-radius:4px; }
    .remove-unit { background:#ff6b6b; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }

  </style>
</head>
<body>
  <div class="container" id="appContainer">

  


<div id="appContent">

     <a class="sheet-link"
       href="https://docs.google.com/spreadsheets/d/1YyjZjRbePZ4fL40hKgJloSLJMzWZgW-6fFIvc-A7ELQ/edit"
       target="_blank" rel="noopener" aria-label="Open Google sheet">Google sheet</a>
    <h1>
      <span id="appTitle">Tile Purchase Entry</span>   
      <span class="gear" id="gearBtn" title="Customize form">⚙️</span>
    </h1>

    <div class="custom-mode-badge">Customize mode</div>

    <!-- Customize panel (hidden by default) -->
    <div id="customPanel" role="dialog" aria-modal="true" aria-label="Customize form">
      <button class="close-x" id="panelCloseX" title="Close (Esc)">❌</button>
      <strong>Customize form text</strong>
      <div style="margin-top:8px">Click any visible text label on the form to edit it directly. After editing, use <b>Apply Preview</b> to try changes locally or <b>Save (server)</b> to store the customization so it will persist next time the app loads.</div>
      <div class="panel-row">
        <div class="note">When customizing, form controls are temporarily disabled to avoid accidental clicks. Only text labels are editable.</div>
        <div class="panel-actions">
          <button id="loadDefaultBtn" type="button">Load Default</button>
          <button id="applyPreviewBtn" type="button">Apply Preview</button>
          <button id="saveServerBtn" type="button">Save (server)</button>
          <button id="cancelCustomBtn" type="button" style="background:#6c757d">Cancel</button>
        </div>
      </div>

      <!-- Manage Units of Measure section -->
      <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
        <strong>Manage Units of Measure (global)</strong>
        <div style="font-size:13px;color:#444;margin-top:6px">
          Add custom units that will be available in all unit dropdowns throughout the form.
        </div>

        <div class="panel-row" style="margin-top:8px; align-items:center;">
          <input id="newUnitInput" type="text" placeholder="Enter new unit name" style="flex:1;">
          <button id="addUnitBtn" type="button" style="margin-left:8px;">Add Unit</button>
        </div>

        <div id="unitList" style="margin-top:8px; max-height:160px; overflow:auto;">
          <!-- Custom units will be listed here dynamically -->
        </div>
      </div>

      <!-- Add / Remove sub-item controls -->
      <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
        <strong>Add / Remove Sub-items</strong>
        <div style="font-size:13px;color:#444;margin-top:6px">Add a new checkbox sub-item to a main category. While in Customize mode you'll see a red ❌ next to each sub-item label to remove it.</div>

        <div class="panel-row" style="margin-top:8px; align-items:center;">
          <select id="addCategorySelect" style="width:40%; padding:8px; font-size:14px;">
            <option value="floor">Floor Tiles</option>
            <option value="wall">Wall Tiles</option>
            <option value="san">Sanitaryware</option>
            <option value="acc">extraparts</option>
            <option value="mode">Mode of payment</option>
          </select>
          <input id="addSubLabelInput" type="text" placeholder="New sub-item label (e.g. 'Large format tiles')" style="flex:1; margin-left:8px;">
          <button id="addSubBtn" type="button" style="margin-left:8px;">Add Sub-item</button>
        </div>
        <div class="panel-row" style="margin-top:8px;">
          <div class="note">Note: IDs of dynamically added items start with <code>sub_</code> (e.g. <code>sub_floor_custom1</code>). New payment modes will be created with a checkbox named <code>modeOfPayment</code> and an amount input (data-mode-amount) so your submission logic picks them up.</div>
        </div>
      </div>
    </div>

    <!-- Photo Upload Section -->
    <div class="photo-section">
      <h2>📷 Photo Upload (Optional)</h2>
      
      <div class="upload-area" id="uploadArea">
          <div class="upload-icon">📷</div>
          <div class="upload-text">
              Click to select a photo or drag & drop here
          </div>
          <button class="btn" onclick="document.getElementById('fileInput').click()">
              Choose from Gallery
          </button>
          <button class="btn camera-btn" onclick="openCamera()">
              Take Photo
          </button>
      </div>
      
      <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
      <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
      
      <div class="preview-container" id="previewContainer">
          <img id="previewImage" class="preview-image" alt="Preview">
          <br>
          <button class="btn" onclick="resetPhotoForm()">Cancel Photo</button>
      </div>
      
      <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Processing...</p>
      </div>
      
      <div id="photoStatus"></div>
    </div>

    <!-- Purchased items with inline qty and nested subitems -->
    <label class="q-label">1. <span id="qPurchasedLabel">Purchased what (check items and enter quantity for specific sub-items)</span></label>
    <div class="checkbox-row" id="purchasedList">

      <!-- FLOOR TILES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_floor" value="Floor Tiles">
          <span class="editable" data-config-id="p_floor_label" id="label_p_floor">Floor Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_floor">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_vitrified" value="Vitrified tiles">
            <span class="editable" data-config-id="sub_floor_vitrified_label" id="label_sub_floor_vitrified">Vitrified tiles (most popular for homes/offices)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_vitrified" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_vitrified" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_vitrified" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_ceramic" value="Ceramic tiles">
            <span class="editable" data-config-id="sub_floor_ceramic_label" id="label_sub_floor_ceramic">Ceramic tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_ceramic" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_ceramic" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_ceramic" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_porcelain" value="Porcelain tiles">
            <span class="editable" data-config-id="sub_floor_porcelain_label" id="label_sub_floor_porcelain">Porcelain tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_porcelain" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_porcelain" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_porcelain" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_marble" value="Marble finish tiles">
            <span class="editable" data-config-id="sub_floor_marble_label" id="label_sub_floor_marble">Marble finish tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_marble" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_marble" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_marble" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_granite" value="Granite finish tiles">
            <span class="editable" data-config-id="sub_floor_granite_label" id="label_sub_floor_granite">Granite finish tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_granite" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_granite" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_granite" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
      </div>

      <!-- WALL TILES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_wall" value="Wall Tiles">
          <span class="editable" data-config-id="p_wall_label" id="label_p_wall">Wall Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_wall">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_kitchen" value="Kitchen wall tiles (backsplash)">
            <span class="editable" data-config-id="sub_wall_kitchen_label" id="label_sub_wall_kitchen">Kitchen wall tiles (backsplash)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_kitchen" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_kitchen" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_wall_kitchen" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_bath" value="Bathroom wall tiles (glazed/anti-skid)">
            <span class="editable" data-config-id="sub_wall_bath_label" id="label_sub_wall_bath">Bathroom wall tiles (glazed/anti-skid)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_bath" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_bath" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_wall_bath" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_decor" value="Decorative/Designer wall tiles">
            <span class="editable" data-config-id="sub_wall_decor_label" id="label_sub_wall_decor">Decorative / designer wall tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_decor" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_decor" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_wall_decor" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
      </div>

      <!-- SANITARYWARE -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_san" value="Sanitaryware">
          <span class="editable" data-config-id="p_san_label" id="label_p_san">Sanitaryware</span>
        </label>
      </div>
      <div class="sublist" id="sublist_san">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_wash" value="Washbasins">
            <span class="editable" data-config-id="sub_san_wash_label" id="label_sub_san_wash">Washbasins</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_wash" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_wash" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_san_wash" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_wc" value="WC">
            <span class="editable" data-config-id="sub_san_wc_label" id="label_sub_san_wc">WC</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_wc" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_wc" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_san_wc" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_urinal" value="Urinals">
            <span class="editable" data-config-id="sub_san_urinal_label" id="label_sub_san_urinal">Urinals</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_urinal" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_urinal" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_san_urinal" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
      </div>

      <!-- extraparts -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_acc" value="extraparts">
          <span class="editable" data-config-id="p_acc_label" id="label_p_acc">extraparts</span>
        </label>
      </div>
      <div class="sublist" id="sublist_acc">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_grout" value="Tile grout & adhesives">
            <span class="editable" data-config-id="sub_acc_grout_label" id="label_sub_acc_grout">Tile grout & adhesives</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_grout" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_grout" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_grout" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_spacers" value="Spacers">
            <span class="editable" data-config-id="sub_acc_spacers_label" id="label_sub_acc_spacers">Spacers</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_spacers" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_spacers" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_spacers" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_sealants" value="Sealants">
            <span class="editable" data-config-id="sub_acc_sealants_label" id="label_sub_acc_sealants">Sealants</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_sealants" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_sealants" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_sealants" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_chem" value="Chemicals">
            <span class="editable" data-config-id="sub_acc_chem_label" id="label_sub_acc_chem">Chemicals</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_chem" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_chem" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_chem" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_skirting" value="Skirting & border tiles">
            <span class="editable" data-config-id="sub_acc_skirting_label" id="label_sub_acc_skirting">Skirting & border tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_skirting" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_skirting" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_skirting" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_mosaic" value="Mosaic tiles for decoration">
            <span class="editable" data-config-id="sub_acc_mosaic_label" id="label_sub_acc_mosaic">Mosaic tiles for decoration</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">❌</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_mosaic" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_mosaic" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_mosaic" class="unit-custom" placeholder="Custom unit" style="display:none;">
          </div>
        </div>
      </div>

      <!-- OTHERS (main) -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_other" value="Others">
          <span class="editable" data-config-id="p_other_label" id="label_p_other">Others</span>
        </label>
        <div class="qty-unit">
          <input type="number" min="0" step="1" id="q_other" class="qty" placeholder="Quantity" disabled>
          <select id="unit_other" class="unit-select" disabled>
            <option value="Boxes">Boxes</option>
            <option value="Pieces">Pieces</option>
            <option value="Kg">Kg</option>
          </select>
          <input type="text" id="unit_custom_other" class="unit-custom" placeholder="Custom unit" style="display:none;">
        </div>
      </div>
      <div style="margin-top:6px; margin-left:6px;">
        <input id="purchasedOtherText" type="text" placeholder="If Others — specify (e.g. 'Grout, Adhesive')">
      </div>
    </div>

    <!-- Purchased from -->
    <label class="q-label">Purchased from</label>
    <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
      <select id="purchasedFromSelect" style="flex:1; padding:8px; font-size:15px;">
        <option value="Delhi Tiles Company">Delhi Tiles Company</option>
        <option value="Mumbai Tiles Company">Mumbai Tiles Company</option>
        <option value="Mumbai Marble Company">Mumbai Marble Company</option>
        <option value="Customised">Customised</option>
        <option value="Other">Other</option>
      </select>
      <input id="purchasedFrom" type="text" placeholder="If Other — specify vendor name" style="flex:1; display:none;">
    </div>

    <!-- custom vendor manager -->
    <div id="customVendorManager" style="display:none;">
      <div style="font-weight:700; margin-bottom:6px;">Manage custom vendors</div>
      <div class="vendor-list" id="vendorList"></div>
      <div class="vendor-actions">
        <input id="newVendorInput" type="text" placeholder="Add new vendor name" style="flex:1;">
        <button id="addVendorBtn" type="button">Add</button>
      </div>
      <div style="font-size:12px;color:#555;margin-top:8px">Fixed options (Delhi/Mumbai/Mumbai Marble/Other) cannot be removed. Use this panel to add vendors specific to your shop. Click Save (server) to persist changes to the system.</div>
    </div>

    <!-- Mode of payment -->
    <label class="q-label">Mode of payment (check modes and enter amounts for each)</label>
    <div class="checkbox-row" id="modes">
      <div class="mode-row" data-original="true">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Cash" id="mode_cash"> <span class="editable" data-config-id="mode_cash_label" id="label_mode_cash">Cash</span>
          <button class="del-btn" title="Remove mode" aria-label="Remove">❌</button>
        </label>
        <input type="number" min="0" step="0.01" id="amt_cash" class="mode-amount" placeholder="Cash Rs." disabled data-mode-amount="Cash">
      </div>
      <div class="mode-row" data-original="true">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Online" id="mode_online"> <span class="editable" data-config-id="mode_online_label" id="label_mode_online">Online</span>
          <button class="del-btn" title="Remove mode" aria-label="Remove">❌</button>
        </label>
        <input type="number" min="0" step="0.01" id="amt_online" class="mode-amount" placeholder="Online Rs." disabled data-mode-amount="Online">
      </div>
      <div class="mode-row" data-original="true">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Credit" id="mode_credit"> <span class="editable" data-config-id="mode_credit_label" id="label_mode_credit">Credit</span>
          <button class="del-btn" title="Remove mode" aria-label="Remove">❌</button>
        </label>
        <input type="number" min="0" step="0.01" id="amt_credit" class="mode-amount" placeholder="Credit Rs." disabled data-mode-amount="Credit">
      </div>
    </div>

    <!-- Total -->
    <label class="q-label">Payment paid (₹)</label>
    <input id="paymentPaid" type="number" min="0" step="0.01" placeholder="Total amount (optional)" >

    <label class="q-label">Any other information</label>
    <textarea id="otherInfo" rows="2" placeholder="Optional additional information"></textarea>

  <!-- Voice-to-Text UI: paste right after the otherInfo textarea -->
<div class="voice-row" id="voiceRow">
  <button id="voiceBtn" class="voice-btn" aria-pressed="false" title="Click to start voice input">
    <span class="mic-icon">🎤</span>
    <span id="voiceBtnLabel">Start voice</span>
  </button>

  <div class="voice-controls" aria-hidden="false">
    <select id="voiceLang" class="voice-lang" title="Select language">
      <option value="en-US">English (US)</option>
      <option value="hi-IN">Hindi (India)</option>
    </select>

    <label class="voice-mode voice-small">
      <input type="checkbox" id="voiceContinuous"> Continuous
    </label>

    <button id="voiceStopBtn" class="voice-btn" title="Stop listening" style="background:#f1f1f1;color:#333;border:1px solid #ccc;">Stop</button>
    <button id="voiceClearBtn" class="voice-btn" title="Clear last transcript" style="background:#fff4f4;color:#b71c1c;border:1px solid #ffb3b3;">Clear</button>

    <div id="voiceStatus" class="voice-status" aria-live="polite">Idle</div>
    <div id="voiceConfidence" class="voice-confidence" aria-hidden="true" style="display:none">0%</div>
  </div>
  <div class="voice-note" style="width:100%; margin-top:6px">Tip: say <em>"stop recording"</em> to stop; interim text appears as you speak.</div>
</div>





  

    <div class="form-actions">
      <button id="submitBtn" type="button">Submit</button>
      <button id="clearBtn" type="button">Clear</button>

      <div style="margin-left:auto;font-weight:600; display:flex; gap:8px; align-items:center;">
        <div>Online:</div>
        <div id="status">online</div>
      </div>
    </div>

    <div id="msg" style="display:none"></div>
    <div id="offlineNotice" class="offline-msg" style="display:none">Connect to internet</div>
    <div class="small" style="margin-top:6px">Status: <span id="status-duplicate" style="display:inline"></span></div>
  </div>

  <script src="app.js"></script>

  <script>

    // --- Config / server endpoint detection ---
    const SERVER_ENDPOINT = window.ENDPOINT || "https://script.google.com/macros/s/AKfycbwsKGlbmcbrw3cm_jqKyhXJXup1P_mIodLoIXR8ZvmVUEQNSA9yympNYBRulM9r4VOfhA/exec";
    const SERVER_TOKEN = window.SHARED_TOKEN || "shopSecret2025";


    // Replace with your Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwsKGlbmcbrw3cm_jqKyhXJXup1P_mIodLoIXR8ZvmVUEQNSA9yympNYBRulM9r4VOfhA/exec';

    let selectedFile = null;
    let selectedImage = null;

    // Drag and drop functionality
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            handleFile(files[0]);
        }
    });

    function openCamera() {
        document.getElementById('cameraInput').click();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            handleFile(file);
        }
    }

    function handleFile(file) {
        selectedFile = file;
        
        // Compress and create preview
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set max dimensions to avoid large uploads
                const maxWidth = 1920;
                const maxHeight = 1080;
                let { width, height } = img;
                
                // Calculate new dimensions
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);
                selectedImage = canvas.toDataURL('image/jpeg', 0.7);
                
                // Show preview
                document.getElementById('previewImage').src = selectedImage;
                document.getElementById('previewContainer').style.display = 'block';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Photo upload function (integrated with main submit)
    async function uploadPhotoToServer() {
        if (!selectedImage) {
            return null; // No photo to upload
        }
        
        showLoading(true);
        
        try {
            // Use form submission approach for photo upload
            return await uploadViaFormSubmission();
        } catch (error) {
            console.error('Photo upload error:', error);
            return null;
        } finally {
            showLoading(false);
        }
    }

    function uploadViaFormSubmission() {
        return new Promise((resolve, reject) => {
            // Create a hidden iframe for form submission
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'upload_iframe_' + Date.now();
            document.body.appendChild(iframe);
            
            // Create a form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = SCRIPT_URL;
            form.target = iframe.name;
            form.enctype = 'multipart/form-data';
            
            // Create hidden input for image data
            const imageInput = document.createElement('input');
            imageInput.type = 'hidden';
            imageInput.name = 'imageData';
            imageInput.value = selectedImage;
            
            const fileNameInput = document.createElement('input');
            fileNameInput.type = 'hidden';
            fileNameInput.name = 'fileName';
            fileNameInput.value = selectedFile ? selectedFile.name : 'camera_photo_' + Date.now() + '.jpg';
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'upload';
            
            form.appendChild(imageInput);
            form.appendChild(fileNameInput);
            form.appendChild(actionInput);
            document.body.appendChild(form);
            
            // Handle iframe load (response)
            iframe.onload = function() {
                try {
                    // Try to read the response (may fail due to cross-origin)
                    const response = iframe.contentDocument.body.textContent;
                    const result = JSON.parse(response);
                    
                    if (result.success) {
                        resolve(result.shortName || 'Photo uploaded');
                    } else {
                        reject(new Error(result.error || 'Upload failed'));
                    }
                } catch (e) {
                    // Cross-origin restriction, assume success after delay
                    resolve('Photo uploaded successfully');
                }
                
                // Cleanup
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                    if (document.body.contains(iframe)) {
                        document.body.removeChild(iframe);
                    }
                }, 1000);
            };
            
            // Submit the form
            form.submit();
            
            // Set a timeout for cleanup in case iframe doesn't load
            setTimeout(() => {
                if (document.body.contains(form)) {
                    resolve('Photo upload completed');
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }
            }, 10000); // 10 second timeout
        });
    }

    function resetPhotoForm() {
        selectedFile = null;
        selectedImage = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('cameraInput').value = '';
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('photoStatus').innerHTML = '';
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function showPhotoStatus(message, type) {
        const statusDiv = document.getElementById('photoStatus');
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // Network status handling
    window.addEventListener('online', () => {
        showPhotoStatus('Back online! You can upload photos now.', 'success');
    });

    window.addEventListener('offline', () => {
        showPhotoStatus('You\'re offline. Photos will be uploaded when connection returns.', 'error');
    });

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        });
    }

    // JSONP helper
    function jsonpCall(url, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
        window[cbName] = function(data) {
          try { resolve(data); } finally { try { delete window[cbName]; } catch(e){} }
        };
        const full = url + (url.indexOf('?') === -1 ? '?' : '&') + 'callback=' + cbName;
        const script = document.createElement('script');
        script.src = full;
        script.onerror = function(){ reject(new Error('JSONP load error')); try{ delete window[cbName]; }catch(e){} };
        document.body.appendChild(script);
        setTimeout(() => { try{ delete window[cbName]; }catch(e){} reject(new Error('JSONP timeout')); }, timeoutMs);
      });
    }


    


    // ----------------- Unit Management Functions -----------------
    function loadGlobalUnits() {
      try {
        const stored = localStorage.getItem('globalUnits_v1');
        return stored ? JSON.parse(stored) : [];
      } catch(e) {
        console.error('Error loading global units:', e);
        return [];
      }
    }

    function saveGlobalUnits(units) {
      try {
        localStorage.setItem('globalUnits_v1', JSON.stringify(units));
      } catch(e) {
        console.error('Error saving global units:', e);
      }
    }

    // Function to load unit preferences for each product
    function loadUnitPreferences() {
      try {
        const stored = localStorage.getItem('unitPreferences_v1');
        return stored ? JSON.parse(stored) : {};
      } catch(e) {
        console.error('Error loading unit preferences:', e);
        return {};
      }
    }

    // Function to save unit preferences for each product
    function saveUnitPreferences(preferences) {
      try {
        localStorage.setItem('unitPreferences_v1', JSON.stringify(preferences));
      } catch(e) {
        console.error('Error saving unit preferences:', e);
      }
    }

    // Function to save unit preference for a specific product
    function saveUnitPreference(productId, unitValue) {
      const preferences = loadUnitPreferences();
      preferences[productId] = unitValue;
      saveUnitPreferences(preferences);
    }

    function renderUnitList() {
      const unitList = document.getElementById('unitList');
      const units = loadGlobalUnits();

      unitList.innerHTML = '';

      if (units.length === 0) {
        unitList.innerHTML = '<div style="color:#666;font-size:13px">No custom units added yet.</div>';
        return;
      }

      units.forEach((unit) => {
        const div = document.createElement('div');
        div.className = 'unit-item';

        const span = document.createElement('span');
        span.style.flex = '1';
        span.textContent = unit;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-unit';
        removeBtn.dataset.unit = unit;
        removeBtn.textContent = 'Remove';

        div.appendChild(span);
        div.appendChild(removeBtn);
        unitList.appendChild(div);
      });
    }

    function addGlobalUnit(unit) {
      if (!unit || !unit.trim()) return;
      unit = unit.trim();
      
      const units = loadGlobalUnits();
      if (units.includes(unit)) {
        alert('Unit already exists!');
        return;
      }
      
      units.push(unit);
      saveGlobalUnits(units);
      renderUnitList();
      rebuildAllUnitSelects();
      showTempMessage('Added unit: ' + unit);
    }

    function removeGlobalUnit(unit) {
      if (!confirm(`Remove unit "${unit}"? This will remove it from all dropdowns.`)) return;
      
      const units = loadGlobalUnits().filter((u) => u !== unit);
      saveGlobalUnits(units);
      renderUnitList();
      rebuildAllUnitSelects();
      showTempMessage('Removed unit: ' + unit);
    }

    // Function to rebuild all unit select dropdowns with preferences
    function rebuildAllUnitSelects() {
      const units = loadGlobalUnits();
      const defaultUnits = ['Boxes', 'Pieces', 'Kg'];
      const preferences = loadUnitPreferences();
      
      document.querySelectorAll('.unit-select').forEach(select => {
        const selectId = select.id;
        const currentVal = select.value;
        
        // Clear and rebuild options
        select.innerHTML = '';
        
        // Add default options
        defaultUnits.forEach(unit => {
          const option = document.createElement('option');
          option.value = unit;
          option.textContent = unit;
          select.appendChild(option);
        });
        
        // Add global units
        units.forEach(unit => {
          const option = document.createElement('option');
          option.value = unit;
          option.textContent = unit;
          select.appendChild(option);
        });
        
        // Restore saved preference if available
        if (selectId && preferences[selectId]) {
          const preferredUnit = preferences[selectId];
          const allOptions = Array.from(select.options).map(opt => opt.value);
          if (allOptions.includes(preferredUnit)) {
            select.value = preferredUnit;
          } else {
            // If preferred unit not found, add it as custom option
            const tempOption = document.createElement('option');
            tempOption.value = preferredUnit;
            tempOption.textContent = preferredUnit + ' (custom)';
            select.appendChild(tempOption);
            select.value = preferredUnit;
          }
        } else if (currentVal) {
          // Restore current selection if no preference saved
          const allOptions = Array.from(select.options).map(opt => opt.value);
          if (allOptions.includes(currentVal)) {
            select.value = currentVal;
          }
        }
      });
    }

    function showTempMessage(text) {
      const m = document.getElementById('msg');
      if (!m) return;
      m.textContent = text; 
      m.style.display = 'block';
      setTimeout(() => { 
        if (m && navigator.onLine) m.style.display = 'none'; 
      }, 2500);
    }

    // --- customization logic ---
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('appContainer');
      const gear = document.getElementById('gearBtn');
      const customPanel = document.getElementById('customPanel');
      const applyPreviewBtn = document.getElementById('applyPreviewBtn');
      const saveServerBtn = document.getElementById('saveServerBtn');
      const cancelCustomBtn = document.getElementById('cancelCustomBtn');
      const loadDefaultBtn = document.getElementById('loadDefaultBtn');
      const panelCloseX = document.getElementById('panelCloseX');
      const addCategorySelect = document.getElementById('addCategorySelect');
      const addSubLabelInput = document.getElementById('addSubLabelInput');
      const addSubBtn = document.getElementById('addSubBtn');
      const newUnitInput = document.getElementById('newUnitInput');
      const addUnitBtn = document.getElementById('addUnitBtn');
      const unitList = document.getElementById('unitList');

      // Initialize unit management
      renderUnitList();
      rebuildAllUnitSelects();

      // Add Unit button event listener
      if (addUnitBtn && newUnitInput) {
        addUnitBtn.addEventListener('click', function() {
          addGlobalUnit(newUnitInput.value);
          newUnitInput.value = '';
        });
        
        newUnitInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            addGlobalUnit(newUnitInput.value);
            newUnitInput.value = '';
          }
        });
      }

      // Delegated event listener for Remove Unit buttons
      if (unitList) {
        unitList.addEventListener('click', function(event) {
          const target = event.target;
          if (target.classList.contains('remove-unit')) {
            const unit = target.dataset.unit;
            removeGlobalUnit(unit);
          }
        });
      }

      let customizeMode = false;
      let editingSession = false;

      function registerEditable(el) {
        if (!el) return;
        el.setAttribute('contenteditable','false');
        el.addEventListener('click', function(ev) {
          if (!customizeMode) return;
          if (editingSession) return;
          alert('Click "Apply Preview" in the customization panel to start editing labels.');
        });
        el.addEventListener('blur', function() {
          if (el.getAttribute('data-editing')) {
            el.contentEditable = "false";
            el.removeAttribute('data-editing');
          }
        });
        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            el.blur();
          }
        });
      }

      Array.from(document.querySelectorAll('.editable')).forEach(registerEditable);

      function setCustomizeMode(on) {
        customizeMode = !!on;
        container.classList.toggle('customize-mode', customizeMode);

        const interactive = container.querySelectorAll('input, textarea, button');
        interactive.forEach(el => {
          if (el.id === 'gearBtn' || el.closest('#customPanel')) return;
          if (customizeMode) {
            el.classList.add('no-pointer');
          } else {
            el.classList.remove('no-pointer');
          }
        });

        if (customizeMode) {
          customPanel.style.display = 'block';
          addRemoveButtons();
        } else {
          customPanel.style.display = 'none';
          endEditingSession();
          hideRemoveButtons();
        }
      }

      gear.addEventListener('click', function() {
        if (!customizeMode) {
          setCustomizeMode(true);
        } else {
          setCustomizeMode(false);
        }
      });

      function startEditingSession() {
        editingSession = true;
        Array.from(document.querySelectorAll('.editable')).forEach(el => {
          el.contentEditable = "true";
          el.classList.add('editing');
          el.classList.remove('no-pointer');
        });
        customPanel.style.display = 'none';
        const first = document.querySelector('.editable');
        if (first) {
          first.focus();
          try {
            if (document.createRange && window.getSelection) {
              const range = document.createRange();
              range.selectNodeContents(first);
              range.collapse(false);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          } catch (e){}
        }
      }

      function endEditingSession() {
        editingSession = false;
        Array.from(document.querySelectorAll('.editable')).forEach(el => {
          try { el.contentEditable = "false"; } catch(e){}
          el.classList.remove('editing');
        });
      }

      applyPreviewBtn.addEventListener('click', function() {
        if (!customizeMode) setCustomizeMode(true);
        startEditingSession();
        alert('Preview: labels are now editable inline. Click any label to edit. When done click Save (server) to persist or Cancel to exit.');
      });

      loadDefaultBtn.addEventListener('click', function(){
        if (!confirm('Reload page to restore defaults? Unsaved edits will be lost.')) return;
        window.location.reload();
      });

      cancelCustomBtn.addEventListener('click', function() {
        if (!confirm('Exit customization mode? Unsaved edits will be lost.')) {
          return;
        }
        endEditingSession();
        setCustomizeMode(false);
      });

      panelCloseX.addEventListener('click', function() {
        if (editingSession) {
          if (!confirm('Editing in progress. Close panel but keep edit mode? (Choose Cancel in panel to abort edits)')) {
            return;
          }
        }
        customPanel.style.display = 'none';
      });

      document.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') {
          if (customPanel.style.display === 'block') {
            customPanel.style.display = 'none';
            return;
          }
          if (editingSession) {
            if (confirm('Exit edit mode? Unsaved changes remain only locally.')) {
              endEditingSession();
              setCustomizeMode(false);
            }
          }
        }
      });

      function makeRemoveButton() {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'remove-checkbox';
        b.title = 'Remove this item';
        b.textContent = '❌';
        b.style.marginLeft = '8px';
        b.style.background = '#ff6b6b';
        b.style.color = '#fff';
        b.style.border = 'none';
        b.style.borderRadius = '50%';
        b.style.width = '26px';
        b.style.height = '26px';
        b.style.lineHeight = '20px';
        b.style.padding = '0';
        b.style.cursor = 'pointer';
        b.style.fontWeight = '700';
        b.style.display = 'inline-flex';
        b.style.alignItems = 'center';
        b.style.justifyContent = 'center';
        b.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
        return b;
      }

      function addRemoveButtons() {
        hideRemoveButtons();
        document.querySelectorAll('.item-row').forEach(function(row) {
          if (row.querySelector('.remove-checkbox')) return;
          const btn = makeRemoveButton();
          btn.setAttribute('data-remove-role','main');
          row.appendChild(btn);
        });
        document.querySelectorAll('.sub-item').forEach(function(si) {
          if (si.querySelector('.remove-checkbox')) return;
          const btn = makeRemoveButton();
          btn.setAttribute('data-remove-role','sub');
          si.appendChild(btn);
        });
        document.querySelectorAll('.mode-row').forEach(function(mr) {
          if (mr.querySelector('.remove-checkbox')) return;
          const btn = makeRemoveButton();
          btn.setAttribute('data-remove-role','mode');
          mr.appendChild(btn);
        });
      }

      function hideRemoveButtons() {
        document.querySelectorAll('.remove-checkbox').forEach(function(b){ b.remove(); });
      }

      function removeWrapperForButton(btn) {
        if (!btn) return;
        const subItem = btn.closest('.sub-item');
        const itemRow = btn.closest('.item-row');
        const modeRow = btn.closest('.mode-row');

        if (subItem) {
          if (!confirm('Remove this sub-item? This cannot be undone.')) return;
          subItem.remove();
        } else if (itemRow) {
          if (!confirm('Remove this main item and its sub-items? This cannot be undone.')) return;
          try {
            const cb = itemRow.querySelector('input[type="checkbox"].purchased, input[type="checkbox"]');
            if (cb && cb.id) {
              const parts = cb.id.split('_');
              const suffix = parts.length > 1 ? parts.slice(1).join('_') : cb.id;
              const sublistId = 'sublist_' + suffix;
              const sublist = document.getElementById(sublistId);
              if (sublist) sublist.remove();
            }
          } catch(e){}
          itemRow.remove();
        } else if (modeRow) {
          if (!confirm('Remove this payment mode? This cannot be undone.')) return;
          modeRow.remove();
        } else {
          const parent = btn.parentElement;
          if (parent) parent.remove();
        }
        bindSubitemHandlers();
        setupMainToSubBindings();
      }

      container.addEventListener('click', function(ev) {
        const btn = ev && ev.target && ev.target.closest && ev.target.closest('.remove-checkbox');
        if (!btn) return;
        if (!customizeMode) {
          alert('Enable Customize mode to remove items.');
          return;
        }
        ev.stopPropagation(); ev.preventDefault();
        removeWrapperForButton(btn);
      });

      function bindSubitemHandlers() {
        document.querySelectorAll('.subitem').forEach(function(sb){
          const suffix = sb.id.slice(4);
          const qtyId = 'q' + sb.id.slice(3);
          const qtyEl = document.getElementById(qtyId);
          const unitEl = document.getElementById('unit_' + suffix);
          const unitCustomEl = document.getElementById('unit_custom_' + suffix);

          if (sb._custom_qty_handler) {
            sb.removeEventListener('change', sb._custom_qty_handler);
            sb._custom_qty_handler = null;
          }

          const handler = function() {
            const enabled = !!sb.checked;
            if (qtyEl) {
              qtyEl.disabled = !enabled;
              if (!enabled) qtyEl.value = '';
            }
            if (unitEl) {
              unitEl.disabled = !enabled;
              if (!enabled) { unitEl.selectedIndex = 0; }
            }
            if (unitCustomEl) {
              unitCustomEl.disabled = !enabled;
              if (!enabled) { unitCustomEl.style.display = 'none'; unitCustomEl.value = ''; }
            }

            // Apply saved unit preference when enabling
            if (enabled && unitEl) {
              const preferences = loadUnitPreferences();
              const savedUnit = preferences[unitEl.id];
              if (savedUnit) {
                const opts = Array.from(unitEl.options).map(o => o.value);
                if (opts.indexOf(savedUnit) !== -1) {
                  unitEl.value = savedUnit;
                  if (unitCustomEl) unitCustomEl.style.display = 'none';
                } else if (savedUnit) {
                  // Create temporary custom option
                  const tempOption = document.createElement('option');
                  tempOption.value = savedUnit;
                  tempOption.textContent = savedUnit + ' (custom)';
                  unitEl.appendChild(tempOption);
                  unitEl.value = savedUnit;
                  if (unitCustomEl) { unitCustomEl.style.display = ''; unitCustomEl.value = savedUnit; }
                }
              } else if (unitEl.value === 'Custom' && unitCustomEl) {
                unitCustomEl.style.display = '';
              }
            }
          };
          sb._custom_qty_handler = handler;
          sb.addEventListener('change', handler);
          if (qtyEl) qtyEl.disabled = !sb.checked;

          // Unit change handler with preference saving
          if (unitEl) {
            if (unitEl._unit_change_bound) {
              unitEl.removeEventListener('change', unitEl._unit_change_bound);
            }
            const unitChange = function() {
              const v = unitEl.value;
              if (unitCustomEl) {
                if (v === 'Custom') {
                  unitCustomEl.style.display = '';
                  unitCustomEl.disabled = false;
                  unitCustomEl.focus && unitCustomEl.focus();
                } else {
                  unitCustomEl.style.display = 'none';
                  unitCustomEl.value = '';
                  unitCustomEl.disabled = true;
                }
              }
              
              // Save unit preference when changed
              if (sb.checked) {
                const finalValue = v === 'Custom' && unitCustomEl && unitCustomEl.value.trim() 
                  ? unitCustomEl.value.trim() 
                  : v;
                saveUnitPreference(unitEl.id, finalValue);
              }
            };
            unitEl._unit_change_bound = unitChange;
            unitEl.addEventListener('change', unitChange);
            if (unitEl) unitEl.disabled = !sb.checked;
            if (unitEl && unitEl.value === 'Custom' && unitCustomEl) unitCustomEl.style.display = '';
          }

          // Custom unit text input with preference saving
          if (unitCustomEl) {
            if (unitCustomEl._custom_input_bound) {
              unitCustomEl.removeEventListener('input', unitCustomEl._custom_input_bound);
            }
            const customInputHandler = function() {
              if (sb.checked && unitEl && unitEl.value === 'Custom') {
                saveUnitPreference(unitEl.id, unitCustomEl.value.trim());
              }
            };
            unitCustomEl._custom_input_bound = customInputHandler;
            unitCustomEl.addEventListener('input', customInputHandler);
            unitCustomEl.disabled = !sb.checked;
          }

          if (sb.checked) {
            handler();
          } else {
            if (qtyEl) qtyEl.disabled = true;
            if (unitEl) unitEl.disabled = true;
            if (unitCustomEl) { unitCustomEl.disabled = true; unitCustomEl.style.display = 'none'; }
          }
        });

        // Handle "Others" main item
        const otherMain = document.getElementById('p_other');
        const otherQty = document.getElementById('q_other');
        const otherUnit = document.getElementById('unit_other');
        const otherUnitCustom = document.getElementById('unit_custom_other');
        if (otherMain && otherQty) {
          if (otherMain._custom_other_handler) otherMain.removeEventListener('change', otherMain._custom_other_handler);
          const oh = function() {
            const enabled = otherMain.checked;
            otherQty.disabled = !enabled;
            if (!enabled) otherQty.value = '';
            if (otherUnit) {
              otherUnit.disabled = !enabled;
              if (!enabled) otherUnit.selectedIndex = 0;
            }
            if (otherUnitCustom) {
              otherUnitCustom.disabled = !enabled;
              if (!enabled) { otherUnitCustom.style.display = 'none'; otherUnitCustom.value = ''; }
            }

            if (enabled && otherUnit) {
              const preferences = loadUnitPreferences();
              const savedUnit = preferences[otherUnit.id];
              if (savedUnit) {
                const opts = Array.from(otherUnit.options).map(o => o.value);
                if (opts.indexOf(savedUnit) !== -1) {
                  otherUnit.value = savedUnit;
                  if (otherUnitCustom) otherUnitCustom.style.display = 'none';
                } else if (savedUnit) {
                  const tempOption = document.createElement('option');
                  tempOption.value = savedUnit;
                  tempOption.textContent = savedUnit + ' (custom)';
                  otherUnit.appendChild(tempOption);
                  otherUnit.value = savedUnit;
                  if (otherUnitCustom) { otherUnitCustom.style.display = ''; otherUnitCustom.value = savedUnit; }
                }
              } else if (otherUnit.value === 'Custom' && otherUnitCustom) {
                otherUnitCustom.style.display = '';
              }
            }
          };
          otherMain._custom_other_handler = oh;
          otherMain.addEventListener('change', oh);

          // Unit change handler for Others
          if (otherUnit) {
            if (otherUnit._unit_change_bound) {
              otherUnit.removeEventListener('change', otherUnit._unit_change_bound);
            }
            const otherUnitChange = function() {
              const v = otherUnit.value;
              if (otherUnitCustom) {
                if (v === 'Custom') {
                  otherUnitCustom.style.display = '';
                  otherUnitCustom.disabled = false;
                  otherUnitCustom.focus && otherUnitCustom.focus();
                } else {
                  otherUnitCustom.style.display = 'none';
                  otherUnitCustom.value = '';
                  otherUnitCustom.disabled = true;
                }
              }
              
              if (otherMain.checked) {
                const finalValue = v === 'Custom' && otherUnitCustom && otherUnitCustom.value.trim() 
                  ? otherUnitCustom.value.trim() 
                  : v;
                saveUnitPreference(otherUnit.id, finalValue);
              }
            };
            otherUnit._unit_change_bound = otherUnitChange;
            otherUnit.addEventListener('change', otherUnitChange);
          }

          if (otherUnitCustom) {
            if (otherUnitCustom._custom_input_bound) {
              otherUnitCustom.removeEventListener('input', otherUnitCustom._custom_input_bound);
            }
            const otherCustomInputHandler = function() {
              if (otherMain.checked && otherUnit && otherUnit.value === 'Custom') {
                saveUnitPreference(otherUnit.id, otherUnitCustom.value.trim());
              }
            };
            otherUnitCustom._custom_input_bound = otherCustomInputHandler;
            otherUnitCustom.addEventListener('input', otherCustomInputHandler);
          }

          oh();
        }
      }

      function setupMainToSubBindings() {
        const mainToSub = {
          'p_floor': 'sublist_floor',
          'p_wall': 'sublist_wall',
          'p_san':  'sublist_san',
          'p_acc':  'sublist_acc'
        };
        Object.keys(mainToSub).forEach(mainId => {
          const mainCb = document.getElementById(mainId);
          const subDiv = document.getElementById(mainToSub[mainId]);
          if (!mainCb || !subDiv) return;
          if (mainCb._custom_main_toggle) mainCb.removeEventListener('change', mainCb._custom_main_toggle);
          const update = function() {
            subDiv.style.display = mainCb.checked ? 'block' : 'none';
            if (!mainCb.checked) {
              subDiv.querySelectorAll('.subitem').forEach(sb => { sb.checked = false; });
              subDiv.querySelectorAll('.subqty').forEach(q => { q.value=''; q.disabled = true; });
              subDiv.querySelectorAll('.unit-select').forEach(u => { u.selectedIndex = 0; u.disabled = true; });
              subDiv.querySelectorAll('.unit-custom').forEach(uc => { uc.value=''; uc.style.display='none'; uc.disabled = true; });
            }
          };
          mainCb._custom_main_toggle = update;
          mainCb.addEventListener('change', update);
          update();
        });
      }

      function bindModeToggle(modeCheckbox) {
        if (!modeCheckbox) return;
        if (modeCheckbox._boundModeToggle) return;
        modeCheckbox._boundModeToggle = true;
        const parent = modeCheckbox.closest('.mode-row');
        if (!parent) return;
        const amtInput = parent.querySelector('input[type="number"].mode-amount');
        modeCheckbox.addEventListener('change', function() {
          if (amtInput) {
            amtInput.disabled = !modeCheckbox.checked;
            if (!modeCheckbox.checked) amtInput.value = '';
          }
        });
        if (amtInput) amtInput.disabled = !modeCheckbox.checked;
      }

      // Run initial binds
      bindSubitemHandlers();
      setupMainToSubBindings();
      document.querySelectorAll('input[name="modeOfPayment"]').forEach(bindModeToggle);

      // Add subitem functionality
      if (addSubBtn) {
        addSubBtn.addEventListener('click', function() {
          const cat = addCategorySelect && addCategorySelect.value ? addCategorySelect.value : 'floor';
          const rawLabel = (addSubLabelInput && addSubLabelInput.value) ? addSubLabelInput.value.trim() : '';
          if (!rawLabel) { alert('Enter a label for the new sub-item.'); return; }
          const slug = rawLabel.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
          let baseId = (cat === 'mode') ? 'mode_' + (slug || Date.now()) : 'sub_' + cat + (slug ? '_' + slug : '');
          let candidate = baseId;
          let i = 1;
          while (document.getElementById(candidate)) {
            candidate = baseId + '_' + i;
            i++;
          }
          const elementId = candidate;

          if (cat === 'mode') {
            const modeDiv = document.createElement('div');
            modeDiv.className = 'mode-row';
            modeDiv.setAttribute('data-generated','true');

            const labelEl = document.createElement('label');
            labelEl.className = 'mode-label';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.name = 'modeOfPayment';
            cb.value = rawLabel;
            cb.id = elementId;

            const span = document.createElement('span');
            span.className = 'editable';
            const cfgId = elementId + '_label';
            span.setAttribute('data-config-id', cfgId);
            span.id = 'label_' + elementId;
            span.textContent = rawLabel;

            const delBtn = document.createElement('button');
            delBtn.className = 'del-btn';
            delBtn.type = 'button';
            delBtn.title = 'Remove mode';
            delBtn.setAttribute('aria-label','Remove');
            delBtn.textContent = '❌';

            labelEl.appendChild(cb);
            labelEl.appendChild(span);
            labelEl.appendChild(delBtn);

            const amt = document.createElement('input');
            amt.type = 'number';
            amt.min = '0';
            amt.step = '0.01';
            amt.placeholder = rawLabel + ' Rs.';
            amt.className = 'mode-amount';
            amt.id = 'amt_' + elementId;
            amt.disabled = true;
            amt.setAttribute('data-mode-amount', rawLabel);

            modeDiv.appendChild(labelEl);
            modeDiv.appendChild(amt);

            const modesContainer = document.getElementById('modes');
            if (!modesContainer) { alert('Modes container not found'); return; }
            modesContainer.appendChild(modeDiv);

            registerEditable(span);
            bindModeToggle(cb);
            bindSubitemHandlers();
            if (addSubLabelInput) addSubLabelInput.value = '';
            showTempMessage('Added payment mode: ' + rawLabel);
            return;
          }

          // Non-mode subitem
          const subId = elementId;
          const suffix = subId.slice(4);
          const qtyId = 'q' + subId.slice(3);

          const subDiv = document.createElement('div');
          subDiv.className = 'sub-item';
          subDiv.setAttribute('data-generated','true');

          const labelEl = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'subitem';
          cb.id = subId;
          cb.value = rawLabel;

          const span = document.createElement('span');
          span.className = 'editable';
          span.setAttribute('data-config-id', subId + '_label');
          span.id = 'label_' + subId;
          span.textContent = rawLabel;

          const delBtn = document.createElement('button');
          delBtn.className = 'del-btn';
          delBtn.type = 'button';
          delBtn.title = 'Remove sub-item';
          delBtn.setAttribute('aria-label','Remove');
          delBtn.textContent = '❌';

          labelEl.appendChild(cb);
          labelEl.appendChild(span);
          labelEl.appendChild(delBtn);

          const qtyUnitDiv = document.createElement('div');
          qtyUnitDiv.className = 'qty-unit';

          const qty = document.createElement('input');
          qty.type = 'number';
          qty.min = '0';
          qty.step = '1';
          qty.placeholder = 'Quantity';
          qty.className = 'subqty qty';
          qty.id = qtyId;
          qty.disabled = true;

          const unitSel = document.createElement('select');
          unitSel.id = 'unit_' + suffix;
          unitSel.className = 'unit-select';
          unitSel.disabled = true;
          
          const defaultUnits = ['Boxes','Pieces','Kg'];
          defaultUnits.forEach(unit => {
            const o = document.createElement('option'); 
            o.value = unit; 
            o.textContent = unit; 
            unitSel.appendChild(o);
          });
          
          const globalUnits = loadGlobalUnits();
          globalUnits.forEach(unit => {
            const o = document.createElement('option'); 
            o.value = unit; 
            o.textContent = unit; 
            unitSel.appendChild(o);
          });

          const unitCustom = document.createElement('input');
          unitCustom.type = 'text';
          unitCustom.id = 'unit_custom_' + suffix;
          unitCustom.className = 'unit-custom';
          unitCustom.placeholder = 'Custom unit';
          unitCustom.style.display = 'none';
          unitCustom.disabled = true;

          qtyUnitDiv.appendChild(qty);
          qtyUnitDiv.appendChild(unitSel);
          qtyUnitDiv.appendChild(unitCustom);

          subDiv.appendChild(labelEl);
          subDiv.appendChild(qtyUnitDiv);

          const map = { floor: 'sublist_floor', wall: 'sublist_wall', san: 'sublist_san', acc: 'sublist_acc' };
          const target = document.getElementById(map[cat] || 'sublist_floor');
          if (!target) {
            alert('Could not find category container. Aborting.');
            return;
          }
          target.appendChild(subDiv);

          registerEditable(span);
          bindSubitemHandlers();
          if (addSubLabelInput) addSubLabelInput.value = '';
          showTempMessage('Added: ' + rawLabel);
        });
      }


      // Config save/load functions
      function buildConfigObject() {
        const cfg = { title: '', labels: {}, structure: { mainItems: [], modes: [] }, globalUnits: loadGlobalUnits() };

        cfg.title = (document.getElementById('appTitle')||{textContent:''}).textContent.trim();
        Array.from(document.querySelectorAll('.editable')).forEach(el => {
          const key = el.getAttribute('data-config-id') || el.id || null;
          if (key) cfg.labels[key] = el.textContent.trim();
        });

        const purchasedList = document.getElementById('purchasedList');
        if (purchasedList) {
          const itemRows = Array.from(purchasedList.querySelectorAll('.item-row'));
          itemRows.forEach(row => {
            const cb = row.querySelector('input[type="checkbox"]');
            if (!cb || !cb.id) return;
            const mainId = cb.id;
            const labelEl = row.querySelector('[data-config-id="' + mainId + '_label"]') || row.querySelector('#label_' + mainId) || row.querySelector('.editable');
            const labelText = labelEl ? (labelEl.textContent || "").trim() : (cb.value || "");
            let sublistId = null;
            const suffixParts = mainId.split('_');
            const suffix = suffixParts.length > 1 ? suffixParts.slice(1).join('_') : mainId;
            const candidateId = 'sublist_' + suffix;
            if (document.getElementById(candidateId)) sublistId = candidateId;
            else {
              const next = row.nextElementSibling;
              if (next && next.classList && next.classList.contains('sublist')) sublistId = next.id || null;
            }

            const mainObj = { id: mainId, label: labelText, sublistId: sublistId, subitems: [] };
            if (mainObj.sublistId) {
              const sl = document.getElementById(mainObj.sublistId);
              if (sl) {
                const subs = Array.from(sl.querySelectorAll('.sub-item'));
                subs.forEach(si => {
                  const subCb = si.querySelector('input[type="checkbox"].subitem') || si.querySelector('input[type="checkbox"]');
                  if (!subCb || !subCb.id) return;
                  const subId = subCb.id;
                  const lab = si.querySelector('[data-config-id="' + subId + '_label"]') || si.querySelector('#label_' + subId) || si.querySelector('.editable');
                  const subLabel = lab ? (lab.textContent || "").trim() : (subCb.value || "");
                  mainObj.subitems.push({ id: subId, label: subLabel });
                });
              }
            }
            cfg.structure.mainItems.push(mainObj);
          });
        }

        const modesContainer = document.getElementById('modes');
        if (modesContainer) {
          const modeRows = Array.from(modesContainer.querySelectorAll('.mode-row'));
          modeRows.forEach(mr => {
            const cb = mr.querySelector('input[type="checkbox"], input[type="radio"]');
            if (!cb) return;
            const id = cb.id || ('mode_' + Math.random().toString(36).slice(2,8));
            const lab = mr.querySelector('[data-config-id="' + id + '_label"]') || mr.querySelector('#label_' + id) || mr.querySelector('.editable');
            const labelText = lab ? (lab.textContent || "").trim() : (cb.value || "");
            const amt = mr.querySelector('input[type="number"].mode-amount');
            const amountInputId = amt ? (amt.id || null) : null;
            const amountAttrName = amt ? (amt.getAttribute('data-mode-amount') || "") : "";
            cfg.structure.modes.push({ id: id, label: labelText, amountInputId: amountInputId, amountAttrName: amountAttrName });
          });
        }

        try {
          const sel = document.getElementById('purchasedFromSelect');
          const txt = document.getElementById('purchasedFrom');
          const fixed = ['Delhi Tiles Company','Mumbai Tiles Company','Mumbai Marble Company','Customised','Other'];
          const items = [];
          if (sel && sel.options) {
            for (let i=0;i<sel.options.length;i++){
              const o = sel.options[i];
              if (fixed.indexOf(o.value) === -1) items.push(o.value);
            }
          }
          const selectedValue = (sel && sel.value === 'Other') ? (txt ? txt.value : '') : (sel ? sel.value : '');
          cfg.purchasedFromCustom = { items: items, selected: selectedValue };
        } catch(e){}

        return cfg;
      }

// Save server: send config including structure via JSONP action=saveConfig
      saveServerBtn.addEventListener('click', async function(){
        // finish any inline editing first
        endEditingSession();
        const cfg = buildConfigObject();
        const cfgStr = JSON.stringify(cfg);
        const url = SERVER_ENDPOINT + '?action=saveConfig&token=' + encodeURIComponent(SERVER_TOKEN) + '&config=' + encodeURIComponent(cfgStr);
        try {
          saveServerBtn.disabled = true; saveServerBtn.textContent = 'Saving...';
          const resp = await jsonpCall(url, 20000);
          saveServerBtn.disabled = false; saveServerBtn.textContent = 'Save (server)';
          if (resp && resp.success) {
            alert('Customization saved on server.');
            setCustomizeMode(false);
            // also persist locally (so dropdown updates instantly survive reloads before server sync)
            try { localStorage.setItem('purchasedFromCustom', JSON.stringify(cfg.purchasedFromCustom || {})); } catch(e){}
          } else {
            console.error('save resp', resp);
            alert('Save failed. Server returned error. Check console.');
          }
        } catch (err) {
          console.error('save err', err);
          alert('Save to server failed. Please ensure ENDPOINT & SHARED_TOKEN in app.js are correct and you are online.');
          saveServerBtn.disabled = false; saveServerBtn.textContent = 'Save (server)';
        }
      });

      // On load: try to fetch saved config and apply
      (async function tryLoadConfig(){
        try {
          const url = SERVER_ENDPOINT + '?action=getConfig&token=' + encodeURIComponent(SERVER_TOKEN);

          const resp = await jsonpCall(url, 15000);
          if (resp && resp.success && resp.config) {
            applyConfigObject(resp.config);
          } else {
            // no config found or error; fallback to localStorage for purchasedFromCustom
            try {
              const local = localStorage.getItem('purchasedFromCustom');
              if (local) {
                const parsed = JSON.parse(local);
                if (parsed && parsed.items) applyPurchasedFromConfig(parsed.items, parsed.selected || '');
              }
            } catch(e){}
          }
        } catch (e) {
          console.warn('Could not load config:', e);
          // fallback to localStorage as above
          try {
            const local = localStorage.getItem('purchasedFromCustom');
            if (local) {
              const parsed = JSON.parse(local);
              if (parsed && parsed.items) applyPurchasedFromConfig(parsed.items, parsed.selected || '');
            }
          } catch(e){}
        }
      })();




















      
     

            function applyConfigObject(cfg) {
        if (!cfg) return;

        if (cfg.title) {
          const titleEl = document.getElementById('appTitle');
          if (titleEl) titleEl.textContent = cfg.title;
        }

        if (cfg.labels) {
          Object.keys(cfg.labels).forEach(key => {
            const el = document.querySelector('[data-config-id="' + key + '"]') || document.getElementById(key);
            if (el) el.textContent = cfg.labels[key];
          });
        }

        if (cfg.globalUnits) {
          saveGlobalUnits(cfg.globalUnits);
          renderUnitList();
          rebuildAllUnitSelects();
        }

        if (cfg.purchasedFromCustom && cfg.purchasedFromCustom.items) {
          saveCustomVendors(cfg.purchasedFromCustom.items);
          rebuildVendorSelect();
          renderVendorList();
        }

        if (!cfg.structure) return;

        // Rebuild structure
        const purchasedList = document.getElementById('purchasedList');

        function findItemRowByMainId(mainId) {
          const allRows = Array.from(purchasedList.querySelectorAll('.item-row'));
          return allRows.find(row => {
            const cb = row.querySelector('input[type="checkbox"]');
            return cb && cb.id === mainId;
          });
        }

        function createMainItem(main) {
          const row = document.createElement('div');
          row.className = 'item-row';
          row.setAttribute('data-generated', 'true');

          const label = document.createElement('label');
          label.className = 'cb';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'purchased';
          cb.id = main.id;
          cb.value = main.label || main.id;

          const span = document.createElement('span');
          span.className = 'editable';
          span.setAttribute('data-config-id', main.id + '_label');
          span.id = 'label_' + main.id;
          span.textContent = main.label || main.id;

          label.appendChild(cb);
          label.appendChild(span);
          row.appendChild(label);

          const otherRow = Array.from(purchasedList.querySelectorAll('.item-row')).find(r => {
            const ch = r.querySelector('input[type="checkbox"]');
            return ch && ch.id === 'p_other';
          });
          if (otherRow) purchasedList.insertBefore(row, otherRow);
          else purchasedList.appendChild(row);

          registerEditable(span);
          return row;
        }

        function ensureSublist(main) {
          let sublistId = main.sublistId || ('sublist_' + (main.id.split('_').slice(1).join('_') || main.id));
          let sl = document.getElementById(sublistId);
          if (!sl) {
            sl = document.createElement('div');
            sl.className = 'sublist';
            sl.id = sublistId;
            const row = findItemRowByMainId(main.id) || createMainItem(main);
            row.insertAdjacentElement('afterend', sl);
          }
          return sl;
        }

        if (cfg.structure.mainItems) {
          cfg.structure.mainItems.forEach(main => {
            const existing = findItemRowByMainId(main.id);
            if (!existing) {
              createMainItem(main);
            }

            const sl = ensureSublist(main);

            if (main.subitems) {
              main.subitems.forEach(sub => {
                const existingSubitem = document.getElementById(sub.id);
                if (!existingSubitem) {
                  const suffix = sub.id.slice(4);
                  const qtyId = 'q' + sub.id.slice(3);

                  const subDiv = document.createElement('div');
                  subDiv.className = 'sub-item';
                  subDiv.setAttribute('data-generated', 'true');

                  const labelEl = document.createElement('label');
                  const cb = document.createElement('input');
                  cb.type = 'checkbox';
                  cb.className = 'subitem';
                  cb.id = sub.id;
                  cb.value = sub.label || sub.id;

                  const span = document.createElement('span');
                  span.className = 'editable';
                  span.setAttribute('data-config-id', sub.id + '_label');
                  span.id = 'label_' + sub.id;
                  span.textContent = sub.label || sub.id;

                  const delBtn = document.createElement('button');
                  delBtn.className = 'del-btn';
                  delBtn.type = 'button';
                  delBtn.title = 'Remove sub-item';
                  delBtn.setAttribute('aria-label', 'Remove');
                  delBtn.textContent = '❌';

                  labelEl.appendChild(cb);
                  labelEl.appendChild(span);
                  labelEl.appendChild(delBtn);

                  const qtyUnitDiv = document.createElement('div');
                  qtyUnitDiv.className = 'qty-unit';

                  const qty = document.createElement('input');
                  qty.type = 'number';
                  qty.min = '0';
                  qty.step = '1';
                  qty.placeholder = 'Quantity';
                  qty.className = 'subqty qty';
                  qty.id = qtyId;
                  qty.disabled = true;

                  const unitSel = document.createElement('select');
                  unitSel.id = 'unit_' + suffix;
                  unitSel.className = 'unit-select';
                  unitSel.disabled = true;
                  
                  const defaultUnits = ['Boxes','Pieces','Kg'];
                  defaultUnits.forEach(unit => {
                    const o = document.createElement('option'); 
                    o.value = unit; 
                    o.textContent = unit; 
                    unitSel.appendChild(o);
                  });
                  
                  const globalUnits = loadGlobalUnits();
                  globalUnits.forEach(unit => {
                    const o = document.createElement('option'); 
                    o.value = unit; 
                    o.textContent = unit; 
                    unitSel.appendChild(o);
                  });

                  const unitCustom = document.createElement('input');
                  unitCustom.type = 'text';
                  unitCustom.id = 'unit_custom_' + suffix;
                  unitCustom.className = 'unit-custom';
                  unitCustom.placeholder = 'Custom unit';
                  unitCustom.style.display = 'none';
                  unitCustom.disabled = true;

                  qtyUnitDiv.appendChild(qty);
                  qtyUnitDiv.appendChild(unitSel);
                  qtyUnitDiv.appendChild(unitCustom);

                  subDiv.appendChild(labelEl);
                  subDiv.appendChild(qtyUnitDiv);

                  sl.appendChild(subDiv);

                  registerEditable(span);
                }
              });
            }
          });
        }

        if (cfg.structure.modes) {
          const modesContainer = document.getElementById('modes');
          cfg.structure.modes.forEach(mode => {
            const existing = document.getElementById(mode.id);
            if (existing) return;

            const modeDiv = document.createElement('div');
            modeDiv.className = 'mode-row';
            modeDiv.setAttribute('data-generated', 'true');

            const labelEl = document.createElement('label');
            labelEl.className = 'mode-label';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.name = 'modeOfPayment';
            cb.value = mode.label || mode.id;
            cb.id = mode.id;

            const span = document.createElement('span');
            span.className = 'editable';
            span.setAttribute('data-config-id', mode.id + '_label');
            span.id = 'label_' + mode.id;
            span.textContent = mode.label || mode.id;

            const delBtn = document.createElement('button');
            delBtn.className = 'del-btn';
            delBtn.type = 'button';
            delBtn.title = 'Remove mode';
            delBtn.setAttribute('aria-label', 'Remove');
            delBtn.textContent = '❌';

            labelEl.appendChild(cb);
            labelEl.appendChild(span);
            labelEl.appendChild(delBtn);

            const amt = document.createElement('input');
            amt.type = 'number';
            amt.min = '0';
            amt.step = '0.01';
            amt.placeholder = (mode.label || mode.id) + ' Rs.';
            amt.className = 'mode-amount';
            amt.id = mode.amountInputId || ('amt_' + mode.id);
            amt.disabled = true;
            amt.setAttribute('data-mode-amount', mode.amountAttrName || mode.label || mode.id);

            modeDiv.appendChild(labelEl);
            modeDiv.appendChild(amt);

            modesContainer.appendChild(modeDiv);

            registerEditable(span);
            bindModeToggle(cb);
          });
        }

        // Re-bind handlers after structural changes
        bindSubitemHandlers();
        setupMainToSubBindings();
        document.querySelectorAll('input[name="modeOfPayment"]').forEach(bindModeToggle);
      }

      // Save server
      saveServerBtn.addEventListener('click', async function() {
        const cfg = buildConfigObject();
        
        try {
          saveServerBtn.disabled = true;
          saveServerBtn.textContent = 'Saving...';
          
          const submitData = {
            action: 'saveConfig',
            token: SERVER_TOKEN,
            config: JSON.stringify(cfg)
          };
          
          const url = SERVER_ENDPOINT + '?' + Object.keys(submitData).map(k => 
            encodeURIComponent(k) + '=' + encodeURIComponent(submitData[k])
          ).join('&');
          
          const response = await jsonpCall(url, 30000);
          
          if (response && response.success) {
            alert('Configuration saved successfully!');
            setCustomizeMode(false);
          } else {
            throw new Error(response ? response.error || 'Unknown server error' : 'No response from server');
          }
          
        } catch (error) {
          console.error('Save error:', error);
          alert('Failed to save configuration: ' + error.message);
        } finally {
          saveServerBtn.disabled = false;
          saveServerBtn.textContent = 'Save (server)';
        }
      });

      const purchasedFromSelect = document.getElementById('purchasedFromSelect');
      const purchasedFromText = document.getElementById('purchasedFrom');
      const customVendorManager = document.getElementById('customVendorManager');
      const vendorList = document.getElementById('vendorList');
      const addVendorBtn = document.getElementById('addVendorBtn');
      const newVendorInput = document.getElementById('newVendorInput');

      if (purchasedFromSelect && purchasedFromText) {
        purchasedFromSelect.addEventListener('change', function() {
          const isOther = this.value === 'Other';
          const isCustomised = this.value === 'Customised';
          
          purchasedFromText.style.display = isOther ? 'block' : 'none';
          customVendorManager.style.display = isCustomised ? 'block' : 'none';
          
          if (!isOther) purchasedFromText.value = '';
        });
        
        purchasedFromSelect.dispatchEvent(new Event('change'));
      }

      function getCustomVendors() {
        try {
          const stored = localStorage.getItem('purchasedFromCustom');
          const parsed = stored ? JSON.parse(stored) : {};
          return parsed.items || [];
        } catch(e) {
          console.error('Error loading custom vendors:', e);
          return [];
        }
      }

      function saveCustomVendors(vendors) {
        try {
          localStorage.setItem('purchasedFromCustom', JSON.stringify({ items: vendors }));
        } catch(e) {
          console.error('Error saving custom vendors:', e);
        }
      }

      function rebuildVendorSelect() {
        if (!purchasedFromSelect) return;
        
        const currentValue = purchasedFromSelect.value;
        const fixedOptions = ['Delhi Tiles Company', 'Mumbai Tiles Company', 'Mumbai Marble Company', 'Customised', 'Other'];
        const customVendors = getCustomVendors();
        
        // Clear current options
        purchasedFromSelect.innerHTML = '';
        
        // Add fixed options
        fixedOptions.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          purchasedFromSelect.appendChild(opt);
        });
        
        // Add custom vendors before "Customised"
        const customisedOption = Array.from(purchasedFromSelect.options).find(opt => opt.value === 'Customised');
        customVendors.forEach(vendor => {
          const opt = document.createElement('option');
          opt.value = vendor;
          opt.textContent = vendor;
          if (customisedOption) {
            purchasedFromSelect.insertBefore(opt, customisedOption);
          } else {
            purchasedFromSelect.appendChild(opt);
          }
        });
        
        // Restore selection if it exists
        const allValues = Array.from(purchasedFromSelect.options).map(opt => opt.value);
        if (allValues.includes(currentValue)) {
          purchasedFromSelect.value = currentValue;
        }
      }

      function renderVendorList() {
        if (!vendorList) return;
        
        const vendors = getCustomVendors();
        vendorList.innerHTML = '';
        
        if (vendors.length === 0) {
          vendorList.innerHTML = '<div style="color:#666;font-size:13px">No custom vendors added yet.</div>';
          return;
        }
        
        vendors.forEach(vendor => {
          const div = document.createElement('div');
          div.className = 'vendor-item';
          
          const span = document.createElement('span');
          span.textContent = vendor;
          span.style.flex = '1';
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.dataset.vendor = vendor;
          removeBtn.style.background = '#dc3545';
          removeBtn.style.color = 'white';
          removeBtn.style.border = 'none';
          removeBtn.style.padding = '4px 8px';
          removeBtn.style.borderRadius = '4px';
          removeBtn.style.cursor = 'pointer';
          
          div.appendChild(span);
          div.appendChild(removeBtn);
          vendorList.appendChild(div);
        });
      }

      function addCustomVendor(vendorName) {
        if (!vendorName || !vendorName.trim()) return;
        vendorName = vendorName.trim();
        
        const vendors = getCustomVendors();
        if (vendors.includes(vendorName)) {
          alert('Vendor already exists!');
          return;
        }
        
        vendors.push(vendorName);
        saveCustomVendors(vendors);
        rebuildVendorSelect();
        renderVendorList();
        showTempMessage('Added vendor: ' + vendorName);
      }

      function removeCustomVendor(vendorName) {
        if (!confirm(`Remove vendor "${vendorName}"?`)) return;
        
        const vendors = getCustomVendors().filter(v => v !== vendorName);
        saveCustomVendors(vendors);
        rebuildVendorSelect();
        renderVendorList();
        showTempMessage('Removed vendor: ' + vendorName);
      }

      // Initialize vendor management
      rebuildVendorSelect();
      renderVendorList();

      if (addVendorBtn && newVendorInput) {
        addVendorBtn.addEventListener('click', function() {
          addCustomVendor(newVendorInput.value);
          newVendorInput.value = '';
        });
        
        newVendorInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            addCustomVendor(newVendorInput.value);
            newVendorInput.value = '';
          }
        });
      }

      if (vendorList) {
        vendorList.addEventListener('click', function(event) {
          if (event.target.dataset.vendor) {
            removeCustomVendor(event.target.dataset.vendor);
          }
        });
      }

      // Load saved configuration on startup
      async function loadServerConfig() {
        try {
          const url = SERVER_ENDPOINT + '?action=loadConfig&token=' + encodeURIComponent(SERVER_TOKEN);
          const response = await jsonpCall(url, 15000);
          
          if (response && response.success && response.config) {
            const cfg = JSON.parse(response.config);
            applyConfigObject(cfg);
            console.log('Configuration loaded from server');
          }
        } catch (error) {
          console.log('Could not load server config (using defaults):', error.message);
        }
      }

      // Load config when page loads
      loadServerConfig();
    });

    // --- Network Status Management ---
    function updateOnlineStatus() {
      const statusEls = [document.getElementById('status'), document.getElementById('status-duplicate')];
      const offlineNotice = document.getElementById('offlineNotice');
      
      statusEls.forEach(el => {
        if (el) el.textContent = navigator.onLine ? 'online' : 'offline';
      });
      
      if (offlineNotice) {
        offlineNotice.style.display = navigator.onLine ? 'none' : 'block';
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

   // --- MOBILE-FRIENDLY Main Submission Logic (handles both photo + manual entries) ---
async function submitMainForm(e) {
  if (e && e.preventDefault) e.preventDefault();

  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn) { 
    submitBtn.disabled = true; 
    submitBtn.dataset.origText = submitBtn.dataset.origText || submitBtn.textContent; 
    submitBtn.textContent = 'Submitting...'; 
  }
  
  // Show loading indicator
  if (typeof showLoading === 'function') showLoading(true);

  try {
    // 1) Collect form data first
    const data = collectFormData ? collectFormData() : {};
    console.log('Collected form data:', data);

    // 2) Handle photo if selected
    if (selectedFile && !selectedImage) {
      // Wait briefly for FileReader to finish if needed
      const start = Date.now();
      while (!selectedImage && (Date.now() - start) < 2000) {
        await new Promise(r => setTimeout(r, 100));
      }
    }

    // 3) Add photo info to data
    if (selectedImage) {
      data.photoLink = selectedFile && selectedFile.name ? selectedFile.name : ('photo_' + Date.now());
      if (typeof showPhotoStatus === 'function') {
        showPhotoStatus('Including photo in submission...', 'success');
      }
      console.log('Photo will be included:', data.photoLink);
    } else {
      data.photoLink = '';
    }

    // 4) Ensure clientId exists
    const cid = window.clientId || (window.clientId = ('c-' + Date.now()));
    data.clientId = cid;

    // 5) Use mobile-friendly direct submission instead of iframe
    const result = await submitDirectMobileFriendly(data);
    
    if (result.success) {
      if (typeof showTempMessage === 'function') showTempMessage('Entry submitted successfully!');
      if (typeof clearForm === 'function') clearForm();
      if (typeof resetPhotoForm === 'function') resetPhotoForm();
    } else {
      throw new Error(result.error || 'Submission failed');
    }

  } catch (error) {
    console.error('Submission error:', error);
    if (typeof showTempMessage === 'function') {
      showTempMessage('Error: ' + (error.message || 'Unknown error'));
    }
  } finally {
    // Always restore button state
    if (submitBtn) { 
      submitBtn.disabled = false; 
      submitBtn.textContent = submitBtn.dataset.origText || 'Submit'; 
    }
    if (typeof showLoading === 'function') showLoading(false);
  }
}

// --- Mobile-friendly direct submission (no iframe) ---
async function submitDirectMobileFriendly(data) {
  return new Promise((resolve, reject) => {
    // Create FormData for proper mobile handling
    const formData = new FormData();
    
    // Add all form fields
    formData.append('token', SERVER_TOKEN || 'shopSecret2025');
    formData.append('action', 'submit');
    formData.append('purchased', data.purchased || '');
    formData.append('purchasedFrom', data.purchasedFrom || '');
    formData.append('paymentModes', data.paymentModes || '');
    formData.append('paymentPaid', data.paymentPaid || '');
    formData.append('otherInfo', data.otherInfo || '');
    formData.append('photoLink', data.photoLink || '');
    formData.append('clientId', data.clientId || '');

    // Add photo data if present
    if (selectedImage) {
      formData.append('imageData', selectedImage);
      formData.append('fileName', selectedFile && selectedFile.name ? selectedFile.name : ('camera_' + Date.now() + '.jpg'));
      console.log('Photo data included in submission');
    }

    console.log('Submitting form data directly (mobile-friendly)');

    // Use fetch with proper error handling for mobile
    fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData,
      mode: 'no-cors', // Important for mobile cross-origin requests
    })
    .then(response => {
      // With no-cors mode, we can't read the response, but we know the request was sent
      console.log('Form submitted successfully (no-cors mode)');
      resolve({ success: true });
    })
    .catch(error => {
      console.error('Direct fetch failed, trying fallback method:', error);
      // Fallback to the iframe method as a last resort
      submitUnifiedDataFallback(data).then(resolve).catch(reject);
    });
  });
}

function collectFormData() {
      const data = {};
      
      // Collect purchased items with quantities and units
      const purchased = [];
      const purchasedCheckboxes = document.querySelectorAll('input.purchased:checked');
      
      purchasedCheckboxes.forEach(cb => {
        const value = cb.value;
        
        // Check if this is the "Others" checkbox
        if (cb.id === 'p_other') {
          const qtyEl = document.getElementById('q_other');
          const unitEl = document.getElementById('unit_other');
          const unitCustomEl = document.getElementById('unit_custom_other');
          const otherTextEl = document.getElementById('purchasedOtherText');
          
          let qty = qtyEl && qtyEl.value ? qtyEl.value : '';
          let unit = '';
          
          if (unitEl && unitEl.value) {
            if (unitEl.value === 'Custom' && unitCustomEl && unitCustomEl.value.trim()) {
              unit = unitCustomEl.value.trim();
            } else {
              unit = unitEl.value;
            }
          }
          
          let description = otherTextEl && otherTextEl.value ? otherTextEl.value.trim() : 'Others';
          
          if (qty && unit) {
            purchased.push(`${qty} ${unit} ${description}`);
          } else if (description) {
            purchased.push(description);
          } else {
            purchased.push(value);
          }
        } else {
          // Handle main category with subitems
          const sublistId = getSublistId(cb.id);
          if (sublistId) {
            const sublist = document.getElementById(sublistId);
            if (sublist) {
              const checkedSubs = sublist.querySelectorAll('input.subitem:checked');
              if (checkedSubs.length > 0) {
                checkedSubs.forEach(subCb => {
                  const subValue = subCb.value;
                  const subSuffix = subCb.id.slice(4); // Remove 'sub_' prefix
                  const qtyEl = document.getElementById('q_' + subSuffix);
                  const unitEl = document.getElementById('unit_' + subSuffix);
                  const unitCustomEl = document.getElementById('unit_custom_' + subSuffix);
                  
                  let qty = qtyEl && qtyEl.value ? qtyEl.value : '';
                  let unit = '';
                  
                  if (unitEl && unitEl.value) {
                    if (unitEl.value === 'Custom' && unitCustomEl && unitCustomEl.value.trim()) {
                      unit = unitCustomEl.value.trim();
                    } else {
                      unit = unitEl.value;
                    }
                  }
                  
                  if (qty && unit) {
                    purchased.push(`${qty} ${unit} ${subValue}`);
                  } else {
                    purchased.push(subValue);
                  }
                });
              } else {
                purchased.push(value);
              }
            } else {
              purchased.push(value);
            }
          } else {
            purchased.push(value);
          }
        }
      });
      
      data.purchased = purchased.join(', ');
      
      // Purchased from
      const purchasedFromSelect = document.getElementById('purchasedFromSelect');
      const purchasedFromText = document.getElementById('purchasedFrom');
      
      if (purchasedFromSelect) {
        if (purchasedFromSelect.value === 'Other' && purchasedFromText && purchasedFromText.value.trim()) {
          data.purchasedFrom = purchasedFromText.value.trim();
        } else {
          data.purchasedFrom = purchasedFromSelect.value;
        }
      }
      
      // Payment modes and amounts
      const paymentModes = [];
      const modeCheckboxes = document.querySelectorAll('input[name="modeOfPayment"]:checked');
      
      modeCheckboxes.forEach(cb => {
        const mode = cb.value;
        const amountInput = document.querySelector(`input[data-mode-amount="${mode}"]`);
        let amount = amountInput && amountInput.value ? amountInput.value : '';
        
        if (amount) {
          paymentModes.push(`${mode}: ₹${amount}`);
        } else {
          paymentModes.push(mode);
        }
      });
      
      data.paymentModes = paymentModes.join(', ');
      
      // Total payment
      const paymentPaidEl = document.getElementById('paymentPaid');
      data.paymentPaid = paymentPaidEl && paymentPaidEl.value ? paymentPaidEl.value : '';
      
      // Other information
      const otherInfoEl = document.getElementById('otherInfo');
      data.otherInfo = otherInfoEl && otherInfoEl.value ? otherInfoEl.value.trim() : '';
      
      return data;
    }

    function getSublistId(mainCheckboxId) {
      const mapping = {
        'p_floor': 'sublist_floor',
        'p_wall': 'sublist_wall',
        'p_san': 'sublist_san',
        'p_acc': 'sublist_acc'
      };
      return mapping[mainCheckboxId] || null;
    }

    async function submitFormData(formData) {
      const submitData = {
        action: 'submit',
        token: SERVER_TOKEN,
        purchased: formData.purchased || '',
        purchasedFrom: formData.purchasedFrom || '',
        paymentModes: formData.paymentModes || '',
        paymentPaid: formData.paymentPaid || '',
        otherInfo: formData.otherInfo || '',
        photoLink: formData.photoLink || ''
      };
      
      const url = SERVER_ENDPOINT + '?' + Object.keys(submitData).map(k => 
        encodeURIComponent(k) + '=' + encodeURIComponent(submitData[k])
      ).join('&');
      
      return await jsonpCall(url, 30000);
    }

    function clearForm() {
      // Clear all checkboxes
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.dispatchEvent(new Event('change'));
      });
      
      // Clear all text inputs and number inputs
      document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
        if (input.id !== 'newUnitInput' && input.id !== 'newVendorInput' && 
            input.id !== 'addSubLabelInput') {
          input.value = '';
        }
      });
      
      // Reset selects to first option
      document.querySelectorAll('select').forEach(select => {
        if (select.id !== 'addCategorySelect') {
          select.selectedIndex = 0;
          select.dispatchEvent(new Event('change'));
        }
      });
      
      // Hide custom unit inputs
      document.querySelectorAll('.unit-custom').forEach(uc => {
        uc.style.display = 'none';
        uc.value = '';
      });
    }

  // MOBILE-FRIENDLY Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  const submitBtn = document.getElementById('submitBtn');
  const clearBtn = document.getElementById('clearBtn');
  
  if (submitBtn) {
    // Remove any existing listeners by cloning the button
    const newSubmitBtn = submitBtn.cloneNode(true);
    submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
    
    // Add ONLY ONE mobile-friendly submit handler
    newSubmitBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Submit button clicked - bypassing validation...');
      
      // Disable button immediately
      newSubmitBtn.disabled = true;
      newSubmitBtn.textContent = 'Submitting...';
      
      // Call submission function with a small delay to bypass any popups
      setTimeout(() => {
        mobileSubmitFunction();
      }, 200); // Delay ensures popup doesn't block submission
    });
  }
  
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      if (confirm('Clear all form data?')) {
        clearForm();
        resetPhotoForm();
      }
    });
  }
  
  // Trigger change events to set initial states
  document.querySelectorAll('.purchased').forEach(cb => {
    cb.dispatchEvent(new Event('change'));
  });
  
  document.querySelectorAll('.subitem').forEach(cb => {
    cb.dispatchEvent(new Event('change'));
  });
  
  document.querySelectorAll('input[name="modeOfPayment"]').forEach(cb => {
    cb.dispatchEvent(new Event('change'));
  });
});

// Mobile-friendly submission function with FAST button restoration
async function mobileSubmitFunction() {
  const submitBtn = document.getElementById('submitBtn');
  
  try {
    console.log('Starting mobile-friendly submission...');
    
    // Collect form data without strict validation
    const data = collectFormDataMobile();

    console.log('Collected form data:', data);

    // Handle photo if selected
    if (selectedFile && !selectedImage) {
      const start = Date.now();
      while (!selectedImage && (Date.now() - start) < 2000) {
        await new Promise(r => setTimeout(r, 100));
      }
    }

    // Add photo info to data
    if (selectedImage) {
      data.photoLink = selectedFile && selectedFile.name ? selectedFile.name : ('photo_' + Date.now());
      console.log('Photo will be included:', data.photoLink);
    } else {
      data.photoLink = '';
    }

    // Ensure clientId exists
    const cid = window.clientId || (window.clientId = ('c-' + Date.now()));
    data.clientId = cid;

    // FIRE AND FORGET: Submit in background and restore button immediately
    submitDirectMobileFriendlyBackground(data);
    
    // Restore button state immediately (after 1-2 seconds)
    setTimeout(() => {
      if (submitBtn) { 
        submitBtn.disabled = false; 
        submitBtn.textContent = 'Submit'; 
      }
      alert('Entry submitted successfully!');
      if (typeof clearForm === 'function') clearForm();
      if (typeof resetPhotoForm === 'function') resetPhotoForm();
    }, 1500); // Button restores in 1.5 seconds

  } catch (error) {
    console.error('Mobile submission error:', error);
    // Restore button even on error
    setTimeout(() => {
      if (submitBtn) { 
        submitBtn.disabled = false; 
        submitBtn.textContent = 'Submit'; 
      }
      alert('Error: ' + (error.message || 'Unknown error'));
    }, 1000);
  }
}


// Mobile-friendly data collection with PROPER subitem handling
function collectFormDataMobile() {
  const data = {};
  const purchased = [];
  
  // Collect checked main items
  const purchasedCheckboxes = document.querySelectorAll('input.purchased:checked');
  
  if (purchasedCheckboxes.length === 0) {
    // Fallback for mobile - always allow some entry
    const otherText = document.getElementById('purchasedOtherText');
    if (otherText && otherText.value.trim()) {
      purchased.push(otherText.value.trim());
    } else if (selectedImage) {
      purchased.push('Photo entry - see attached image');
    } else {
      purchased.push('Entry from mobile device');
    }
  } else {
    // Process each main category for subitems
    purchasedCheckboxes.forEach(cb => {
      const value = cb.value || 'Item';
      
      // Handle "Others" category specially
      if (cb.id === 'p_other') {
        const qtyEl = document.getElementById('q_other');
        const unitEl = document.getElementById('unit_other');
        const unitCustomEl = document.getElementById('unit_custom_other');
        const otherTextEl = document.getElementById('purchasedOtherText');
        
        let qty = qtyEl && qtyEl.value ? qtyEl.value : '';
        let unit = '';
        
        if (unitEl && unitEl.value) {
          if (unitEl.value === 'Custom' && unitCustomEl && unitCustomEl.value.trim()) {
            unit = unitCustomEl.value.trim();
          } else {
            unit = unitEl.value;
          }
        }
        
        let description = otherTextEl && otherTextEl.value ? otherTextEl.value.trim() : 'Others';
        
        if (qty && unit) {
          purchased.push(`${qty} ${unit} ${description}`);
        } else if (description) {
          purchased.push(description);
        } else {
          purchased.push(value);
        }
      } else {
        // Handle main categories with subitems (Floor Tiles, Wall Tiles, etc.)
        const sublistId = getSublistIdMobile(cb.id);
        if (sublistId) {
          const sublist = document.getElementById(sublistId);
          if (sublist) {
            const checkedSubs = sublist.querySelectorAll('input.subitem:checked');
            if (checkedSubs.length > 0) {
              // Process each checked subitem with quantities
              checkedSubs.forEach(subCb => {
                const subValue = subCb.value || '';
                const subSuffix = subCb.id.slice(4); // Remove 'sub_' prefix
                const qtyEl = document.getElementById('q_' + subSuffix);
                const unitEl = document.getElementById('unit_' + subSuffix);
                const unitCustomEl = document.getElementById('unit_custom_' + subSuffix);
                
                let qty = qtyEl && qtyEl.value ? qtyEl.value : '';
                let unit = '';
                
                if (unitEl && unitEl.value) {
                  if (unitEl.value === 'Custom' && unitCustomEl && unitCustomEl.value.trim()) {
                    unit = unitCustomEl.value.trim();
                  } else {
                    unit = unitEl.value;
                  }
                }
                
                if (qty && unit) {
                  purchased.push(`${qty} ${unit} ${subValue}`);
                } else {
                  purchased.push(subValue);
                }
              });
            } else {
              // Main category checked but no subitems - just add main category
              purchased.push(value);
            }
          } else {
            purchased.push(value);
          }
        } else {
          purchased.push(value);
        }
      }
    });
  }
  
  data.purchased = purchased.join(', ');

// Add this helper function right after the collectFormDataMobile function:
function getSublistIdMobile(mainCheckboxId) {
  const mapping = {
    'p_floor': 'sublist_floor',
    'p_wall': 'sublist_wall',
    'p_san': 'sublist_san',
    'p_acc': 'sublist_acc'
  };
  return mapping[mainCheckboxId] || null;
}

  
  // Collect other fields
  const purchasedFromSelect = document.getElementById('purchasedFromSelect');
  const purchasedFromText = document.getElementById('purchasedFrom');
  if (purchasedFromSelect) {
    if (purchasedFromSelect.value === 'Other' && purchasedFromText && purchasedFromText.value.trim()) {
      data.purchasedFrom = purchasedFromText.value.trim();
    } else {
      data.purchasedFrom = purchasedFromSelect.value || '';
    }
  }
  
  const paymentPaidEl = document.getElementById('paymentPaid');
  data.paymentPaid = paymentPaidEl && paymentPaidEl.value ? paymentPaidEl.value : '';
  
  const otherInfoEl = document.getElementById('otherInfo');
  data.otherInfo = otherInfoEl && otherInfoEl.value ? otherInfoEl.value.trim() : '';
  
  // Collect payment modes
  const paymentModes = [];
  const modeCheckboxes = document.querySelectorAll('input[name="modeOfPayment"]:checked');
  modeCheckboxes.forEach(cb => {
    const mode = cb.value || '';
    const amountInput = document.querySelector(`input[data-mode-amount="${mode}"]`);
    const amount = amountInput && amountInput.value ? amountInput.value : '';
    if (amount) {
      paymentModes.push(`${mode}: ₹${amount}`);
    } else {
      paymentModes.push(mode);
    }
  });
  data.paymentModes = paymentModes.join(', ');
  
  return data;
}

// Background submission - FIRE AND FORGET (doesn't wait for response)
function submitDirectMobileFriendlyBackground(data) {
  // Create FormData for mobile compatibility
  const formData = new FormData();
  
  // Add all form fields
  formData.append('token', SERVER_TOKEN || 'shopSecret2025');
  formData.append('action', 'submit');
  formData.append('purchased', data.purchased || '');
  formData.append('purchasedFrom', data.purchasedFrom || '');
  formData.append('paymentModes', data.paymentModes || '');
  formData.append('paymentPaid', data.paymentPaid || '');
  formData.append('otherInfo', data.otherInfo || '');
  formData.append('photoLink', data.photoLink || '');
  formData.append('clientId', data.clientId || '');

  // Add photo data if present
  if (selectedImage) {
    formData.append('imageData', selectedImage);
    formData.append('fileName', selectedFile && selectedFile.name ? selectedFile.name : ('mobile_photo_' + Date.now() + '.jpg'));
  }

  console.log('Submitting form data in background...');

  // FIRE AND FORGET: Send request but don't wait for response
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: formData,
    mode: 'no-cors',
  })
  .then(() => {
    console.log('Background submission sent successfully');
  })
  .catch(error => {
    console.log('Background submission sent (error ignored for mobile):', error);
  });
  
  // Don't return a promise - this is fire-and-forget
}








    


    // ===== ENHANCED SUB-ITEM SEARCH SYSTEM WITH CUSTOMIZATION SUPPORT =====
class SubItemSearch {
  constructor() {
    this.searchInput = null;
    this.searchResults = null;
    this.originalPurchasedList = null;
    this.cachedSubItems = [];
    this.searchTimeout = null;
    this.reindexTimeout = null;
    this.focusedIndex = -1;
    this.isSearchActive = false;
    this.mutationObserver = null;
    
    this.init();
  }
  
  init() {
    this.createSearchUI();
    this.cacheSubItems();
    this.bindEvents();
    this.setupMutationObserver();
    this.setupEditableListeners();
  }
  
  createSearchUI() {
    const purchasedList = document.getElementById('purchasedList');
    if (!purchasedList) return;
    
    // Create search container
    const searchContainer = document.createElement('div');
    searchContainer.className = 'search-container';
    searchContainer.innerHTML = `
      <div class="search-input-wrapper">
        <input type="text" 
               id="subItemSearch" 
               class="search-input" 
               placeholder='Search sub-items (e.g. "porcelain", "grout")'
               autocomplete="off">
        <button class="search-clear-btn" id="searchClearBtn" type="button">×</button>
        <div class="search-count" id="searchCount"></div>
      </div>
      <div class="search-results" id="searchResults" style="display: none;"></div>
    `;
    
    // Insert before purchased list
    purchasedList.parentNode.insertBefore(searchContainer, purchasedList);
    
    this.searchInput = document.getElementById('subItemSearch');
    this.searchResults = document.getElementById('searchResults');
    this.searchCount = document.getElementById('searchCount');
    this.originalPurchasedList = purchasedList;
  }
  
  cacheSubItems() {
    this.cachedSubItems = [];
    const subItems = document.querySelectorAll('.sub-item');
    
    subItems.forEach(subItem => {
      const checkbox = subItem.querySelector('.subitem');
      const labelEl = subItem.querySelector('.editable');
      const parentRow = subItem.closest('.sublist').previousElementSibling;
      const parentLabel = parentRow ? parentRow.querySelector('.editable') : null;
      
      if (checkbox && labelEl && parentLabel) {
        this.cachedSubItems.push({
          node: subItem,
          checkbox: checkbox,
          labelEl: labelEl,
          textLower: labelEl.textContent.toLowerCase(),
          parentId: parentRow.querySelector('.purchased').id,
          parentLabel: parentLabel.textContent,
          qtyInput: this.getQtyInput(checkbox.id),
          unitSelect: this.getUnitSelect(checkbox.id),
          customUnitInput: this.getCustomUnitInput(checkbox.id)
        });
      }
    });
    
    // Update current search if active
    if (this.isSearchActive && this.searchInput && this.searchInput.value.trim()) {
      this.performSearch(this.searchInput.value);
    }
  }
  
 // Replace existing methods in class SubItemSearch with these:

getSuffixFromCheckboxId(checkboxId) {
  // supports ids like "sub_san_wash" or "subsan_wash" etc.
  return checkboxId.replace(/^sub_?/, '');
}

getQtyInput(checkboxId) {
  const suffix = this.getSuffixFromCheckboxId(checkboxId);
  return document.getElementById('q_' + suffix);
}

getUnitSelect(checkboxId) {
  const suffix = this.getSuffixFromCheckboxId(checkboxId);
  return document.getElementById('unit_' + suffix);
}

getCustomUnitInput(checkboxId) {
  const suffix = this.getSuffixFromCheckboxId(checkboxId);
  return document.getElementById('unit_custom_' + suffix);
}

  
  setupMutationObserver() {
    if (!window.MutationObserver) return;
    
    this.mutationObserver = new MutationObserver((mutations) => {
      let shouldReindex = false;
      
      mutations.forEach(mutation => {
        // Check for added/removed sub-items
        if (mutation.type === 'childList') {
          const hasSubItems = Array.from(mutation.addedNodes).some(node => 
            node.nodeType === Node.ELEMENT_NODE && 
            (node.classList.contains('sub-item') || node.querySelector('.sub-item'))
          );
          const removedSubItems = Array.from(mutation.removedNodes).some(node => 
            node.nodeType === Node.ELEMENT_NODE && 
            (node.classList.contains('sub-item') || node.querySelector('.sub-item'))
          );
          
          if (hasSubItems || removedSubItems) {
            shouldReindex = true;
          }
        }
      });
      
      if (shouldReindex) {
        this.debouncedReindex();
        this.announceChange('Items updated');
      }
    });
    
    // Observe the purchased list for changes
    const purchasedList = document.getElementById('purchasedList');
    if (purchasedList) {
      this.mutationObserver.observe(purchasedList, {
        childList: true,
        subtree: true
      });
    }
  }
  
  setupEditableListeners() {
    // Listen for changes to editable labels
    document.addEventListener('blur', (e) => {
      if (e.target.classList.contains('editable')) {
        this.debouncedReindex();
      }
    }, true);
    
    document.addEventListener('input', (e) => {
      if (e.target.classList.contains('editable')) {
        this.debouncedReindex();
      }
    }, true);
  }
  
  debouncedReindex() {
    clearTimeout(this.reindexTimeout);
    this.reindexTimeout = setTimeout(() => {
      this.cacheSubItems();
    }, 300);
  }
  
  bindEvents() {
    if (!this.searchInput) return;
    
    // Search input with debounce
    this.searchInput.addEventListener('input', (e) => {
      clearTimeout(this.searchTimeout);
      this.searchTimeout = setTimeout(() => {
        this.performSearch(e.target.value);
      }, 250);
    });
    
    // Clear button
    document.getElementById('searchClearBtn').addEventListener('click', () => {
      this.clearSearch();
    });
    
    // Keyboard navigation
    this.searchInput.addEventListener('keydown', (e) => {
      this.handleKeydown(e);
    });
    
    // Click outside to maintain focus
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        this.focusedIndex = -1;
        this.updateFocusStyles();
      }
    });
  }
  
  performSearch(query) {
    const trimmedQuery = query.trim();
    
    if (!trimmedQuery) {
      this.clearSearch();
      return;
    }
    
    const queryLower = trimmedQuery.toLowerCase();
    const matches = this.cachedSubItems.filter(item => 
      item.textLower.includes(queryLower)
    );
    
    this.displayResults(matches, trimmedQuery);
    this.announceResults(matches.length);
  }
  
  displayResults(matches, originalQuery) {
    if (matches.length === 0) {
      this.showNoResults(originalQuery);
      return;
    }
    
    // Group by parent
    const grouped = this.groupByParent(matches);
    const resultsHTML = this.buildResultsHTML(grouped, originalQuery);
    
    this.searchResults.innerHTML = resultsHTML;
    this.searchResults.style.display = 'block';
    this.originalPurchasedList.style.display = 'none';
    this.isSearchActive = true;
    this.focusedIndex = -1;
    
    this.updateSearchCount(matches.length);
    this.bindResultEvents();
    this.setupQtyUnitControls();
  }
  
  groupByParent(matches) {
    const grouped = {};
    matches.forEach(match => {
      if (!grouped[match.parentId]) {
        grouped[match.parentId] = {
          parentLabel: match.parentLabel,
          items: []
        };
      }
      grouped[match.parentId].items.push(match);
    });
    return grouped;
  }
  
  buildResultsHTML(grouped, query) {
    let html = '<div class="search-results-content">';
    
    Object.keys(grouped).forEach(parentId => {
      const group = grouped[parentId];
      html += `
        <div class="search-group">
          <div class="search-group-header">${this.escapeHtml(group.parentLabel)}</div>
          <div class="search-group-items">
      `;
      
      group.items.forEach((item, index) => {
        const highlighted = this.highlightMatch(item.labelEl.textContent, query);
        const isChecked = item.checkbox.checked ? 'checked' : '';
        const isDisabled = !item.checkbox.checked ? 'disabled' : '';
        const qtyValue = item.qtyInput ? item.qtyInput.value : '';
        const unitValue = item.unitSelect ? item.unitSelect.value : 'Boxes';
        const customUnitValue = item.customUnitInput ? item.customUnitInput.value : '';
        const customUnitVisible = unitValue === 'Custom' ? 'style="display:block"' : 'style="display:none"';
        
        // Get current unit options
        const unitOptions = this.getUnitOptions(item.unitSelect);
        
        html += `
          <div class="search-result-item" data-checkbox-id="${item.checkbox.id}">
            <div class="search-result-main">
              <label class="search-result-label">
                <input type="checkbox" class="search-result-checkbox" ${isChecked}>
                <span class="search-result-text">${highlighted}</span>
              </label>
            </div>
            <div class="search-result-controls">
              <div class="search-qty-unit">
                <input type="number" 
                       class="search-qty-input" 
                       min="0" 
                       step="1" 
                       placeholder="Qty" 
                       value="${qtyValue}"
                       ${isDisabled}
                       data-original-id="${item.qtyInput ? item.qtyInput.id : ''}">
                <select class="search-unit-select" 
                        ${isDisabled}
                        data-original-id="${item.unitSelect ? item.unitSelect.id : ''}">
                  ${unitOptions}
                </select>
                <input type="text" 
                       class="search-custom-unit" 
                       placeholder="Custom unit" 
                       value="${customUnitValue}"
                       ${customUnitVisible}
                       ${isDisabled}
                       data-original-id="${item.customUnitInput ? item.customUnitInput.id : ''}">
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
    });
    
    html += '</div>';
    return html;
  }
  
  getUnitOptions(originalSelect) {
    if (!originalSelect) {
      return `
        <option value="Boxes">Boxes</option>
        <option value="Pieces">Pieces</option>
        <option value="Kg">Kg</option>
        <option value="Custom">Custom</option>
      `;
    }
    
    let options = '';
    Array.from(originalSelect.options).forEach(option => {
      const selected = option.selected ? 'selected' : '';
      options += `<option value="${option.value}" ${selected}>${option.text}</option>`;
    });
    
    return options;
  }
  
  setupQtyUnitControls() {
    const qtyInputs = this.searchResults.querySelectorAll('.search-qty-input');
    const unitSelects = this.searchResults.querySelectorAll('.search-unit-select');
    const customUnits = this.searchResults.querySelectorAll('.search-custom-unit');
    
    // Sync qty inputs
    qtyInputs.forEach(input => {
      input.addEventListener('input', (e) => {
        const originalId = e.target.dataset.originalId;
        const originalInput = document.getElementById(originalId);
        if (originalInput) {
          originalInput.value = e.target.value;
          originalInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
      
      input.addEventListener('change', (e) => {
        const originalId = e.target.dataset.originalId;
        const originalInput = document.getElementById(originalId);
        if (originalInput) {
          originalInput.value = e.target.value;
          originalInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });
    
    // Sync unit selects
    unitSelects.forEach(select => {
      select.addEventListener('change', (e) => {
        const originalId = e.target.dataset.originalId;
        const originalSelect = document.getElementById(originalId);
        const customUnit = e.target.parentNode.querySelector('.search-custom-unit');
        
        if (originalSelect) {
          originalSelect.value = e.target.value;
          originalSelect.dispatchEvent(new Event('change', { bubbles: true }));
          
          // Handle custom unit visibility
          if (e.target.value === 'Custom') {
            customUnit.style.display = 'block';
            customUnit.disabled = false;
            // Focus custom unit on mobile after a brief delay
            setTimeout(() => {
              if (window.innerWidth <= 768) {
                customUnit.focus();
              }
            }, 100);
          } else {
            customUnit.style.display = 'none';
            customUnit.disabled = true;
          }
          
          // Save unit preference
          this.saveUnitPreference(originalId, e.target.value);
        }
      });
    });
    
    // Sync custom unit inputs
    customUnits.forEach(input => {
      input.addEventListener('input', (e) => {
        const originalId = e.target.dataset.originalId;
        const originalInput = document.getElementById(originalId);
        if (originalInput) {
          originalInput.value = e.target.value;
          originalInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
      
      input.addEventListener('change', (e) => {
        const originalId = e.target.dataset.originalId;
        const originalInput = document.getElementById(originalId);
        if (originalInput) {
          originalInput.value = e.target.value;
          originalInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });
  }
  
  saveUnitPreference(originalId, unitValue) {
    if (typeof saveUnitPref === 'function') {
      saveUnitPref(originalId, unitValue);
    } else {
      // Fallback unit preference saving
      try {
        const prefs = JSON.parse(localStorage.getItem('unitPreferences') || '{}');
        prefs[originalId] = unitValue;
        localStorage.setItem('unitPreferences', JSON.stringify(prefs));
      } catch (e) {
        console.warn('Could not save unit preference:', e);
      }
    }
  }
  
  showNoResults(query) {
    this.searchResults.innerHTML = `
      <div class="search-no-results">
        <div class="no-results-message">No sub-items found for "${this.escapeHtml(query)}"</div>
        <button class="add-subitem-btn" data-query="${this.escapeHtml(query)}">
          Add sub-item: "${this.escapeHtml(query)}"
        </button>
      </div>
    `;
    this.searchResults.style.display = 'block';
    this.originalPurchasedList.style.display = 'none';
    this.isSearchActive = true;
    this.updateSearchCount(0);
    this.bindAddSubitemEvent();
  }
  
  bindResultEvents() {
    const resultItems = this.searchResults.querySelectorAll('.search-result-item');
    
    resultItems.forEach((item, index) => {
      const label = item.querySelector('.search-result-label');
      
      // Click/touch events on the label area
      label.addEventListener('click', (e) => {
        e.preventDefault();
        this.toggleResult(item);
      });
      
      // Touch-friendly tap
      label.addEventListener('touchend', (e) => {
        e.preventDefault();
        this.toggleResult(item);
      });
      
      // Store index for keyboard navigation
      item.dataset.resultIndex = index;
    });
  }
  
  bindAddSubitemEvent() {
    const addBtn = this.searchResults.querySelector('.add-subitem-btn');
    if (addBtn) {
      addBtn.addEventListener('click', (e) => {
        this.showAddSubitemModal(e.target.dataset.query);
      });
    }
  }
  
  toggleResult(resultItem) {
    const checkboxId = resultItem.dataset.checkboxId;
    const originalCheckbox = document.getElementById(checkboxId);
    const resultCheckbox = resultItem.querySelector('.search-result-checkbox');
    const qtyInput = resultItem.querySelector('.search-qty-input');
    const unitSelect = resultItem.querySelector('.search-unit-select');
    const customUnit = resultItem.querySelector('.search-custom-unit');
    
    if (originalCheckbox && resultCheckbox) {
      // Toggle original checkbox
      originalCheckbox.checked = !originalCheckbox.checked;
      resultCheckbox.checked = originalCheckbox.checked;
      
      // Trigger change event on original checkbox
      originalCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
      
      // Update controls state
      const isEnabled = originalCheckbox.checked;
      if (qtyInput) qtyInput.disabled = !isEnabled;
      if (unitSelect) unitSelect.disabled = !isEnabled;
      if (customUnit && unitSelect.value !== 'Custom') customUnit.disabled = !isEnabled;
      
      // Update visual feedback
      resultItem.classList.toggle('selected', originalCheckbox.checked);
      
      // If checked, ensure parent main category is visible/expanded
      if (originalCheckbox.checked) {
        this.ensureParentExpanded(checkboxId);
        
        // Focus qty input on mobile for better UX
        if (window.innerWidth <= 768 && qtyInput && !qtyInput.disabled) {
          setTimeout(() => {
            qtyInput.focus();
            qtyInput.select();
          }, 150);
        }
      }
    }
  }
  
  ensureParentExpanded(checkboxId) {
    const originalSubitem = document.getElementById(checkboxId);
    if (!originalSubitem) return;
    
    const sublist = originalSubitem.closest('.sublist');
    const parentRow = sublist ? sublist.previousElementSibling : null;
    const parentCheckbox = parentRow ? parentRow.querySelector('.purchased') : null;
    
    if (parentCheckbox && sublist) {
      if (!parentCheckbox.checked) {
        parentCheckbox.checked = true;
        parentCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
      }
      sublist.style.display = 'block';
    }
  }
  
  handleKeydown(e) {
    if (!this.isSearchActive) return;
    
    const resultItems = Array.from(this.searchResults.querySelectorAll('.search-result-item'));
    
    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        this.focusedIndex = Math.min(this.focusedIndex + 1, resultItems.length - 1);
        this.updateFocusStyles();
        this.scrollToFocused();
        break;
        
      case 'ArrowUp':
        e.preventDefault();
        this.focusedIndex = Math.max(this.focusedIndex - 1, -1);
        this.updateFocusStyles();
        this.scrollToFocused();
        break;
        
      case 'Enter':
        e.preventDefault();
        if (this.focusedIndex >= 0 && resultItems[this.focusedIndex]) {
          this.toggleResult(resultItems[this.focusedIndex]);
          // Focus qty input after toggle
          const qtyInput = resultItems[this.focusedIndex].querySelector('.search-qty-input');
          if (qtyInput && !qtyInput.disabled) {
            setTimeout(() => {
              qtyInput.focus();
              qtyInput.select();
            }, 100);
          }
        }
        break;
        
      case 'Escape':
        e.preventDefault();
        this.clearSearch();
        this.searchInput.focus();
        break;
    }
  }
  
  updateFocusStyles() {
    const resultItems = this.searchResults.querySelectorAll('.search-result-item');
    resultItems.forEach((item, index) => {
      item.classList.toggle('focused', index === this.focusedIndex);
    });
  }
  
  scrollToFocused() {
    const focusedItem = this.searchResults.querySelector('.search-result-item.focused');
    if (focusedItem) {
      focusedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
  
  showAddSubitemModal(query) {
    const modal = document.createElement('div');
    modal.className = 'add-subitem-modal';
    modal.innerHTML = `
      <div class="add-subitem-modal-content">
        <h3>Add New Sub-item</h3>
        <div class="add-subitem-form">
          <label>Category:</label>
          <select class="add-subitem-category">
            <option value="floor">Floor Tiles</option>
            <option value="wall">Wall Tiles</option>
            <option value="san">Sanitaryware</option>
            <option value="acc">Accessories</option>
          </select>
          
          <label>Sub-item name:</label>
          <input type="text" class="add-subitem-label" value="${this.escapeHtml(query)}">
          
          <div class="add-subitem-actions">
            <button class="btn add-subitem-confirm">Add Sub-item</button>
            <button class="btn add-subitem-cancel">Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Focus input
    const labelInput = modal.querySelector('.add-subitem-label');
    labelInput.focus();
    labelInput.select();
    
    // Bind events
    modal.querySelector('.add-subitem-confirm').addEventListener('click', () => {
      this.createNewSubitem(
        modal.querySelector('.add-subitem-category').value,
        modal.querySelector('.add-subitem-label').value
      );
      document.body.removeChild(modal);
    });
    
    modal.querySelector('.add-subitem-cancel').addEventListener('click', () => {
      document.body.removeChild(modal);
    });
    
    // Close on outside click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });
  }
  
  createNewSubitem(category, label) {
    if (!label.trim()) return;
    
    const trimmedLabel = label.trim();
    const slug = trimmedLabel.toLowerCase().replace(/[^a-z0-9]/g, '');
    const baseId = `sub${category}${slug}`;
    
    // Find unique ID
    let elementId = baseId;
    let i = 1;
    while (document.getElementById(elementId)) {
      elementId = `${baseId}${i}`;
      i++;
    }
    
    // Get target sublist
    const sublistId = `sublist${category}`;
    const sublist = document.getElementById(sublistId);
    if (!sublist) {
      alert('Could not find category container');
      return;
    }
    
    // Create sub-item element
    const suffix = elementId.slice(3); // Remove 'sub' prefix
    const qtyId = `q${suffix}`;
    const unitId = `unit${suffix}`;
    const customUnitId = `unitcustom${suffix}`;
    
    const subDiv = document.createElement('div');
    subDiv.className = 'sub-item';
    subDiv.setAttribute('data-generated', 'true');
    
    subDiv.innerHTML = `
      <label>
        <input type="checkbox" class="subitem" id="${elementId}" value="${trimmedLabel}">
        <span class="editable" data-config-id="${elementId}label" id="label${elementId}">${trimmedLabel}</span>
        <button class="del-btn" type="button" title="Remove sub-item" aria-label="Remove">×</button>
      </label>
      <div class="qty-unit">
        <input type="number" min="0" step="1" id="${qtyId}" class="subqty qty" placeholder="Quantity" disabled>
        <select id="${unitId}" class="unit-select" disabled>
          <option value="Boxes">Boxes</option>
          <option value="Pieces">Pieces</option>
          <option value="Kg">Kg</option>
          <option value="Custom">Custom</option>
        </select>
        <input type="text" id="${customUnitId}" class="unit-custom" placeholder="Custom unit" style="display:none" disabled>
      </div>
    `;
    
    // Add to sublist
    sublist.appendChild(subDiv);
    
    // Re-register handlers and cache
    if (typeof bindSubitemHandlers === 'function') {
      bindSubitemHandlers();
    }
    if (typeof registerEditable === 'function') {
      registerEditable(subDiv.querySelector('.editable'));
    }
    
    // Auto-check the new item
    const newCheckbox = document.getElementById(elementId);
    if (newCheckbox) {
      newCheckbox.checked = true;
      newCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    // Cache will be updated automatically by MutationObserver
    // Announce the addition
    this.announceChange(`New item added: ${trimmedLabel}`);
    
    // Show success message
    if (typeof showTempMessage === 'function') {
      showTempMessage(`Added "${trimmedLabel}" to ${category} category`);
    }
  }
  
  clearSearch() {
    this.searchInput.value = '';
    this.searchResults.style.display = 'none';
    this.originalPurchasedList.style.display = 'block';
    this.isSearchActive = false;
    this.focusedIndex = -1;
    this.updateSearchCount(0);
  }
  
  updateSearchCount(count) {
    if (count === 0) {
      this.searchCount.textContent = '';
    } else {
      this.searchCount.textContent = `${count} result${count === 1 ? '' : 's'}`;
    }
  }
  
  announceResults(count) {
    // Screen reader announcement
    const announcement = `${count} result${count === 1 ? '' : 's'} found`;
    this.announceChange(announcement);
  }
  
  announceChange(message) {
    // Screen reader announcement
    const srAnnounce = document.getElementById('sr-announce') || document.createElement('div');
    srAnnounce.id = 'sr-announce';
    srAnnounce.setAttribute('aria-live', 'polite');
    srAnnounce.style.cssText = 'position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden;';
    srAnnounce.textContent = message;
    document.body.appendChild(srAnnounce);
  }
  
  highlightMatch(text, query) {
    const index = text.toLowerCase().indexOf(query.toLowerCase());
    if (index === -1) return this.escapeHtml(text);
    
    const before = text.substring(0, index);
    const match = text.substring(index, index + query.length);
    const after = text.substring(index + query.length);
    
    return `${this.escapeHtml(before)}<mark class="search-highlight">${this.escapeHtml(match)}</mark>${this.escapeHtml(after)}`;
  }
  
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Public methods for external integration
  reindexSubItems() {
    this.cacheSubItems();
  }
  
  refresh() {
    this.cacheSubItems();
  }
  
  destroy() {
    if (this.mutationObserver) {
      this.mutationObserver.disconnect();
    }
    clearTimeout(this.searchTimeout);
    clearTimeout(this.reindexTimeout);
  }
}

// Initialize search system after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Wait a bit for existing initialization to complete
  setTimeout(() => {
    window.subItemSearch = new SubItemSearch();
    
    // Expose public reindex function
    window.reindexSubItems = function() {
      if (window.subItemSearch) {
        window.subItemSearch.reindexSubItems();
      }
    };
  }, 500);
});

// Hook into existing add subitem functionality to refresh search cache
if (typeof addSubBtn !== 'undefined' && addSubBtn) {
  const originalAddSubClick = addSubBtn.onclick;
  addSubBtn.onclick = function() {
    if (originalAddSubClick) originalAddSubClick();
    setTimeout(() => {
      if (window.subItemSearch) window.subItemSearch.refresh();
    }, 100);
  };
}


/* Voice-to-Text functionality using Web Speech API (vanilla JS) */
/* Paste this block near the end of index.html (before </body>) */

(function(){
  // cross-browser SpeechRecognition
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const voiceBtn = document.getElementById('voiceBtn');
  const voiceBtnLabel = document.getElementById('voiceBtnLabel');
  const voiceStopBtn = document.getElementById('voiceStopBtn');
  const voiceClearBtn = document.getElementById('voiceClearBtn');
  const voiceLangSelect = document.getElementById('voiceLang');
  const voiceContinuousCheckbox = document.getElementById('voiceContinuous');
  const voiceStatus = document.getElementById('voiceStatus');
  const voiceConfidence = document.getElementById('voiceConfidence');
  const otherInfo = document.getElementById('otherInfo'); // target textarea

  if (!otherInfo) {
    console.warn('Voice-to-text: target #otherInfo not found (check where you pasted the HTML).');
  }

  if (!SpeechRecognition) {
    // Unsupported
    voiceStatus.textContent = 'SpeechRecognition not supported in this browser';
    voiceBtn.disabled = true;
    voiceStopBtn.disabled = true;
    voiceClearBtn.disabled = false;
    // Show an alert on click explaining fallback
    voiceBtn.addEventListener('click', () => {
      alert('Sorry — your browser does not support the Web Speech API. Use Chrome/Edge (Chromium) or Safari (if available) for voice input.');
    });
    return;
  }

  let recognition = null;
  let listening = false;
  let lastInterim = '';
  let lastFinal = '';

  function createRecognition() {
    const r = new SpeechRecognition();
    r.lang = voiceLangSelect.value || 'en-US';
    r.interimResults = true; // show interim results
    r.maxAlternatives = 3;
    r.continuous = !!voiceContinuousCheckbox.checked; // continuous vs single
    return r;
  }

  function updateUIListening(isListening) {
    listening = !!isListening;
    voiceBtn.setAttribute('aria-pressed', listening ? 'true' : 'false');
    voiceBtn.classList.toggle('listening', listening);
    voiceBtnLabel.textContent = listening ? 'Listening…' : 'Start voice';
    voiceStatus.textContent = listening ? 'Listening — speak now' : 'Idle';
    // Make Stop button available only while listening
    voiceStopBtn.disabled = !listening;
  }

  function startListening() {
    if (listening) return;
    try {
      recognition = createRecognition();

      recognition.onstart = () => {
        updateUIListening(true);
        voiceConfidence.style.display = 'none';
      };

      recognition.onerror = (evt) => {
        console.error('recognition error', evt);
        if (evt.error === 'not-allowed' || evt.error === 'permission-denied') {
          voiceStatus.textContent = 'Microphone permission denied. Please allow access.';
        } else {
          voiceStatus.textContent = 'Error: ' + (evt.error || 'unknown');
        }
        updateUIListening(false);
        recognition && recognition.stop();
      };

      recognition.onend = () => {
        // If continuous = true, onend may fire between interim, so only mark idle when not listening
        updateUIListening(false);
      };

      recognition.onresult = (event) => {
        // event.results is a ResultList; iterate to get final vs interim
        let interim = '';
        let finalTranscript = '';
        let lastConf = 0;

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const res = event.results[i];
          const text = res[0].transcript;
          lastConf = res[0].confidence || lastConf;
          if (res.isFinal) {
            finalTranscript += text;
          } else {
            interim += text;
          }
        }

        // Show interim while speaking
        if (interim) {
          lastInterim = interim;
          if (otherInfo) {
            // Append interim visually but don't overwrite confirmed final text
            otherInfo.value = (lastFinal ? (lastFinal + ' ') : '') + interim;
          }
        }

        // Commit final text
        if (finalTranscript) {
          lastFinal = (lastFinal ? (lastFinal + ' ') : '') + finalTranscript.trim();
          if (otherInfo) {
            otherInfo.value = lastFinal;
          }
          // Show confidence for the most recent final result
          voiceConfidence.style.display = 'inline-block';
          voiceConfidence.textContent = Math.round(lastConf * 100) + '%';
          // voice command: stop recording
          if (finalTranscript.toLowerCase().includes('stop recording')) {
            stopListening();
            // remove the spoken command phrase from the transcription
            if (otherInfo) {
              otherInfo.value = otherInfo.value.replace(/stop recording/ig, '').trim();
            }
          }
        }

        // If not continuous and we got a final result, stop
        if (!voiceContinuousCheckbox.checked && event.results[event.results.length - 1].isFinal) {
          recognition.stop();
          updateUIListening(false);
        }
      };

      recognition.start();
      voiceStatus.textContent = 'Starting...';
    } catch (err) {
      console.error('startListening error', err);
      voiceStatus.textContent = 'Start failed: ' + (err.message || err);
      updateUIListening(false);
    }
  }

  function stopListening() {
    if (!listening) return;
    if (recognition) {
      try {
        recognition.stop();
      } catch (e) { /* ignore */ }
    }
    updateUIListening(false);
  }

  function clearTranscript() {
    lastInterim = '';
    lastFinal = '';
    if (otherInfo) otherInfo.value = '';
    voiceConfidence.style.display = 'none';
    voiceStatus.textContent = 'Cleared';
  }

  // Bind UI
  voiceBtn.addEventListener('click', function(e){
    e.preventDefault();
    if (!listening) startListening();
    else stopListening();
  });

  voiceStopBtn.addEventListener('click', function(e){
    e.preventDefault();
    stopListening();
  });

  voiceClearBtn.addEventListener('click', function(e){
    e.preventDefault();
    clearTranscript();
  });

  voiceLangSelect.addEventListener('change', function(){
    // If currently listening restart recognition with new language
    if (listening) {
      stopListening();
      setTimeout(startListening, 250);
    }
  });

  voiceContinuousCheckbox.addEventListener('change', function(){
    if (listening) {
      // restart recognition to apply new continuous flag
      stopListening();
      setTimeout(startListening, 250);
    }
  });

  // Keyboard accessibility: press Enter on mic button
  voiceBtn.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      voiceBtn.click();
    }
  });

  // On page unload, stop recognition to cleanup resources
  window.addEventListener('beforeunload', () => {
    if (recognition && listening) {
      try { recognition.abort(); } catch(e) {}
    }
  });

  // Announce readiness
  voiceStatus.textContent = 'Ready';
  voiceStopBtn.disabled = true;

})();





  </script>
</div> <!-- Close appContent div -->
   

</body>
</html>






















