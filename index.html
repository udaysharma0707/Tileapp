<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tile Purchase Entry</title>
  <link rel="manifest" href="manifest.json">
  <style>
    html,body { height:100%; margin:0; padding:0; }
    body {
      background-image: url('./background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      font-family: Arial, sans-serif;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    .container {
      width:100%;
      max-width:920px;
      background: rgba(255,255,255,0.98);
      border-radius:10px;
      padding:14px;
      box-sizing:border-box;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      position: relative;
    }
    h1{font-size:20px;margin:0 0 10px 0; display:flex; align-items:center; gap:8px;}
    .gear {
      margin-left:auto; cursor:pointer; font-size:18px; color:#2c7be5;
    }
    .q-label{display:block;margin-top:10px;font-weight:600}
    input[type="text"], input[type="number"], select, textarea {
      width:100%; padding:8px; font-size:15px; margin-top:6px; box-sizing:border-box;
      border:1px solid #ccc; border-radius:4px;
    }
    /* main item row and nested sublist */
    .item-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .item-row label { flex:1; display:flex; align-items:center; gap:8px; }
    .qty { width:110px; flex:0 0 110px; }
    .sublist { margin-left:28px; margin-top:6px; padding-left:6px; border-left:2px solid rgba(0,0,0,0.04); display:none; }
    .sub-item { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .sub-item label { flex:1; display:flex; align-items:center; gap:8px; }
    .checkbox-row { margin-top:6px; padding:0; }
    .cb { display:block; width:100%; padding:6px 0; box-sizing:border-box; }

    /* quantity + unit inline controls */
    .qty-unit {
      display:flex;
      gap:6px;
      align-items:center;
      min-width:280px;
      justify-content:flex-end;
    }
    .qty-unit input[type="number"] { width:90px; padding:6px; font-size:14px; }
    .qty-unit select { width:120px; padding:6px; font-size:14px; }
    .qty-unit .unit-custom { width:110px; padding:6px; font-size:14px; display:none; }
    .unit-lock {
      display:inline-flex;
      align-items:center;
      gap:4px;
      margin-left:6px;
    }
    .unit-lock input[type="checkbox"] { transform: scale(1.25); margin:0; }

    /* payment inline controls */
    .mode-row { display:flex; align-items:center; gap:12px; margin-top:6px; }
    .mode-row .mode-label { flex:1; display:flex; align-items:center; gap:8px; }
    .mode-amount { width:160px; flex:0 0 160px; }
    .total-row { margin-top:8px; display:flex; gap:12px; align-items:center; }
    .total-row label { font-weight:600; }

    button{ margin-top:12px; padding:10px 14px; font-size:16px; border-radius:6px; border: none; background:#2c7be5; color:white; cursor:pointer; }
    button#clearBtn { background:#6c757d; }
    .offline-msg { margin-top:10px; color:#b71c1c; font-weight:700; font-size:15px; }
    .small{font-size:13px;color:#666;margin-top:6px}
    .form-actions { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }

    @media (max-width:920px){
      .container { padding:10px; }
    }
    @media (max-width:620px){
      .item-row { flex-direction:column; align-items:flex-start }
      .qty { width:100%; flex:0 0 auto }
      .sub-item { flex-direction:column; align-items:flex-start }
      .mode-row { flex-direction:column; align-items:stretch }
      .mode-amount { width:100%; flex:auto }
      .total-row { flex-direction:column; align-items:stretch }
      .qty-unit { width:100%; justify-content:flex-start; }
      .qty-unit input[type="number"], .qty-unit select, .qty-unit .unit-custom { width:40%; }
    }

    /* make touch targets larger for checkboxes (and slightly larger radios) */
    input[type="checkbox"] {
      transform: scale(1.45);
      margin-right: 10px;
      -webkit-transform: scale(1.45);
      -webkit-margin-end: 10px;
    }
    input[type="radio"] {
      transform: scale(1.25);
      margin-right: 8px;
      -webkit-transform: scale(1.25);
    }
    .cb input[type="checkbox"], .cb input[type="radio"] {
      vertical-align: middle;
    }

    /* editable label visuals */
    .editable { padding:2px 6px; border-radius:4px; cursor:text; display:inline-block; }
    .customize-mode .editable { background: #fffbe6; border:1px dashed #ffd966; }
    .editable[contenteditable="true"] { outline: 2px solid #2c7be5; background: #ffffff; }

    /* small modal panel for customization instructions & buttons */
    /* portrait-friendly popup */
    #customPanel {
      position: fixed;
      left: 50%;
      top: 90px;
      transform: translateX(-50%);
      width: 760px;
      max-width: calc(100% - 48px);
      background: white;
      border-radius:8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      padding:12px;
      z-index: 1200;
      display:none;
      max-height: calc(80vh);   /* limit height so mobile can scroll */
      overflow: auto;
      box-sizing: border-box;
    }
    #customPanel .panel-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    #customPanel .panel-row .note { flex:1; font-size:14px; color:#333; }
    #customPanel .panel-actions { display:flex; gap:8px; }
    #customPanel .close-x { position:absolute; right:10px; top:8px; background:transparent; border:none; font-size:20px; cursor:pointer; }

    /* small top-right badge showing Customize mode on */
    .custom-mode-badge {
      position: absolute; right: 16px; top: 12px; padding:6px 8px; background:#fff4cc; border-radius:6px; color:#6a4f00; font-weight:700; display:none;
    }
    .customize-mode .custom-mode-badge { display:block; }

    /* prevent pointer interactions for inputs while editing (applied when customization active) */
    .customize-mode .no-pointer { pointer-events: none; opacity: 0.7; }

    /* MOBILE-SPECIFIC: make popup portrait-shaped and centered for small screens */
    @media (max-width: 600px) {
      #customPanel {
        width: 92vw;
        max-width: 420px;
        height: 70vh;           /* portrait feel */
        max-height: 70vh;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%); /* center vertically on mobile */
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.45);
        overflow: auto;        /* allow inner scroll */
      }
      #customPanel .panel-row { flex-direction: column; align-items:stretch; gap:10px; }
      #customPanel .panel-actions { flex-wrap:wrap; justify-content:flex-end; }
      #customPanel .close-x { font-size:22px; right:6px; top:6px; }
    }

    /* delete button next to labels (hidden by default, shown in customize mode) */
    .del-btn {
      display: none;
      background: transparent;
      border: none;
      color: #b71c1c;
      font-weight: 700;
      cursor: pointer;
      padding: 2px 6px;
      margin-left: 6px;
      border-radius: 4px;
    }
    .customize-mode .del-btn { display: inline-block; }

    /* inline remove-circle used while customizing (generated by JS) */
    .remove-checkbox {
      display:inline-flex;
    }

    /* Purchased-from custom manager styling */
    #customVendorManager {
      border:1px dashed #cfcfcf;
      padding:8px;
      border-radius:6px;
      background:#fafafa;
      margin-top:8px;
    }
    #customVendorManager .vendor-list { max-height:160px; overflow:auto; margin-bottom:8px; }
    #customVendorManager .vendor-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px; border-radius:4px; background:white; margin-bottom:6px; border:1px solid #eee; }
    #customVendorManager .vendor-item button { background:#b71c1c; padding:6px 8px; border-radius:6px; border:none; font-weight:700; }
    #customVendorManager .vendor-actions { display:flex; gap:8px; align-items:center; }
    #customVendorManager input[type="text"] { margin-top:0; margin-bottom:0; }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
     <a class="sheet-link"
       href="https://docs.google.com/spreadsheets/d/1YyjZjRbePZ4fL40hKgJloSLJMzWZgW-6fFIvc-A7ELQ/edit"
       target="_blank" rel="noopener" aria-label="Open Google sheet">Google sheet</a>
    <h1>
      <span id="appTitle">Tile Purchase Entry</span>
      <span class="gear" id="gearBtn" title="Customize form">⚙️</span>
    </h1>

    <div class="custom-mode-badge">Customize mode</div>

    <!-- Customize panel (hidden by default) -->
    <div id="customPanel" role="dialog" aria-modal="true" aria-label="Customize form">
      <button class="close-x" id="panelCloseX" title="Close (Esc)">×</button>
      <strong>Customize form text</strong>
      <div style="margin-top:8px">Click any visible text label on the form to edit it directly. After editing, use <b>Apply Preview</b> to try changes locally or <b>Save (server)</b> to store the customization so it will persist next time the app loads.</div>
      <div class="panel-row">
        <div class="note">When customizing, form controls are temporarily disabled to avoid accidental clicks. Only text labels are editable.</div>
        <div class="panel-actions">
          <button id="loadDefaultBtn" type="button">Load Default</button>
          <button id="applyPreviewBtn" type="button">Apply Preview</button>
          <button id="saveServerBtn" type="button">Save (server)</button>
          <button id="cancelCustomBtn" type="button" style="background:#6c757d">Cancel</button>
        </div>
      </div>

      <!-- NEW: Add / Remove sub-item controls (includes Mode of payment option) -->
      <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
        <strong>Add / Remove Sub-items</strong>
        <div style="font-size:13px;color:#444;margin-top:6px">Add a new checkbox sub-item to a main category. While in Customize mode you'll see a red ✕ next to each sub-item label to remove it.</div>

        <div class="panel-row" style="margin-top:8px; align-items:center;">
          <select id="addCategorySelect" style="width:40%; padding:8px; font-size:14px;">
            <option value="floor">Floor Tiles</option>
            <option value="wall">Wall Tiles</option>
            <option value="san">Sanitaryware</option>
            <option value="acc">Accessories</option>
            <option value="mode">Mode of payment</option>
          </select>
          <input id="addSubLabelInput" type="text" placeholder="New sub-item label (e.g. 'Large format tiles')" style="flex:1; margin-left:8px;">
          <button id="addSubBtn" type="button" style="margin-left:8px;">Add Sub-item</button>
        </div>
        <div class="panel-row" style="margin-top:8px;">
          <div class="note">Note: IDs of dynamically added items start with <code>sub_</code> (e.g. <code>sub_floor_custom1</code>). New payment modes will be created with a checkbox named <code>modeOfPayment</code> and an amount input (data-mode-amount) so your submission logic picks them up.</div>
        </div>
      </div>
    </div>

    <!-- Purchased items with inline qty and nested subitems -->
    <label class="q-label">1. <span id="qPurchasedLabel">Purchased what (check items and enter quantity for specific sub-items)</span></label>
    <div class="checkbox-row" id="purchasedList">

      <!-- FLOOR TILES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_floor" value="Floor Tiles">
          <span class="editable" data-config-id="p_floor_label" id="label_p_floor">Floor Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_floor">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_vitrified" value="Vitrified tiles">
            <span class="editable" data-config-id="sub_floor_vitrified_label" id="label_sub_floor_vitrified">Vitrified tiles (most popular for homes/offices)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>

          <!-- NEW: Quantity + Unit group (keeps original qty id for backwards compatibility) -->
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_vitrified" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_vitrified" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_floor_vitrified" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item">
              <input type="checkbox" id="lock_floor_vitrified" /> lock
            </label>
          </div>

          <!-- Unit manager: add/remove global units -->
<div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
  <strong>Manage Units (Boxes / Pieces / Kg / custom)</strong>
  <div style="font-size:13px;color:#444;margin-top:6px">
    Add a custom unit (e.g. "Boxes (Large)"). Custom units are saved to localStorage and will show up in all unit dropdowns.
  </div>

  <div id="unitManager" style="margin-top:8px;">
    <div id="unitList" style="max-height:120px; overflow:auto; margin-bottom:8px; color:#333;">
      <!-- list generated by JS -->
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="newUnitInput" type="text" placeholder="New unit (e.g. Boxes (L))" style="flex:1;">
      <button id="addUnitBtn" type="button">Add Unit</button>
      <button id="clearUnitsBtn" type="button" title="Remove all custom units" style="background:#6c757d;color:#fff;">Clear</button>
    </div>
    <div style="font-size:12px;color:#666;margin-top:6px;">
      Note: locked unit values (per-item) are preserved separately. Removing a unit from the list does not modify locked values already stored in localStorage.
    </div>
  </div>
</div>


        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_ceramic" value="Ceramic tiles">
            <span class="editable" data-config-id="sub_floor_ceramic_label" id="label_sub_floor_ceramic">Ceramic tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_ceramic" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_ceramic" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_floor_ceramic" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_ceramic" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_porcelain" value="Porcelain tiles">
            <span class="editable" data-config-id="sub_floor_porcelain_label" id="label_sub_floor_porcelain">Porcelain tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_porcelain" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_porcelain" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_floor_porcelain" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_porcelain" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_marble" value="Marble finish tiles">
            <span class="editable" data-config-id="sub_floor_marble_label" id="label_sub_floor_marble">Marble finish tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_marble" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_marble" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_floor_marble" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_marble" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_granite" value="Granite finish tiles">
            <span class="editable" data-config-id="sub_floor_granite_label" id="label_sub_floor_granite">Granite finish tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_granite" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_granite" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_floor_granite" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_granite" /> lock</label>
          </div>
        </div>
      </div>

      <!-- WALL TILES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_wall" value="Wall Tiles">
          <span class="editable" data-config-id="p_wall_label" id="label_p_wall">Wall Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_wall">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_kitchen" value="Kitchen wall tiles (backsplash)">
            <span class="editable" data-config-id="sub_wall_kitchen_label" id="label_sub_wall_kitchen">Kitchen wall tiles (backsplash)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_kitchen" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_kitchen" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_wall_kitchen" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_wall_kitchen" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_bath" value="Bathroom wall tiles (glazed/anti-skid)">
            <span class="editable" data-config-id="sub_wall_bath_label" id="label_sub_wall_bath">Bathroom wall tiles (glazed/anti-skid)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_bath" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_bath" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_wall_bath" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_wall_bath" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_decor" value="Decorative/Designer wall tiles">
            <span class="editable" data-config-id="sub_wall_decor_label" id="label_sub_wall_decor">Decorative / designer wall tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_decor" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_decor" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_wall_decor" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_wall_decor" /> lock</label>
          </div>
        </div>
      </div>

      <!-- SANITARYWARE -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_san" value="Sanitaryware">
          <span class="editable" data-config-id="p_san_label" id="label_p_san">Sanitaryware</span>
        </label>
      </div>
      <div class="sublist" id="sublist_san">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_wash" value="Washbasins">
            <span class="editable" data-config-id="sub_san_wash_label" id="label_sub_san_wash">Washbasins</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_wash" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_wash" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_san_wash" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_san_wash" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_wc" value="WC">
            <span class="editable" data-config-id="sub_san_wc_label" id="label_sub_san_wc">WC</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_wc" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_wc" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_san_wc" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_san_wc" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_urinal" value="Urinals">
            <span class="editable" data-config-id="sub_san_urinal_label" id="label_sub_san_urinal">Urinals</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_urinal" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_urinal" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_san_urinal" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_san_urinal" /> lock</label>
          </div>
        </div>
      </div>

      <!-- ACCESSORIES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_acc" value="Accessories">
          <span class="editable" data-config-id="p_acc_label" id="label_p_acc">Accessories</span>
        </label>
      </div>
      <div class="sublist" id="sublist_acc">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_grout" value="Tile grout & adhesives">
            <span class="editable" data-config-id="sub_acc_grout_label" id="label_sub_acc_grout">Tile grout & adhesives</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_grout" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_grout" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_acc_grout" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_grout" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_spacers" value="Spacers">
            <span class="editable" data-config-id="sub_acc_spacers_label" id="label_sub_acc_spacers">Spacers</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_spacers" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_spacers" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_acc_spacers" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_spacers" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_sealants" value="Sealants">
            <span class="editable" data-config-id="sub_acc_sealants_label" id="label_sub_acc_sealants">Sealants</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_sealants" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_sealants" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_acc_sealants" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_sealants" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_chem" value="Chemicals">
            <span class="editable" data-config-id="sub_acc_chem_label" id="label_sub_acc_chem">Chemicals</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_chem" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_chem" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_acc_chem" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_chem" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_skirting" value="Skirting & border tiles">
            <span class="editable" data-config-id="sub_acc_skirting_label" id="label_sub_acc_skirting">Skirting & border tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_skirting" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_skirting" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_acc_skirting" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_skirting" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_mosaic" value="Mosaic tiles for decoration">
            <span class="editable" data-config-id="sub_acc_mosaic_label" id="label_sub_acc_mosaic">Mosaic tiles for decoration</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_mosaic" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_mosaic" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" id="unit_custom_acc_mosaic" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_mosaic" /> lock</label>
          </div>
        </div>
      </div>

      <!-- OTHERS (main) — keep simple: checked + custom name + qty -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_other" value="Others">
          <span class="editable" data-config-id="p_other_label" id="label_p_other">Others</span>
        </label>
        <div class="qty-unit">
          <input type="number" min="0" step="1" id="q_other" class="qty" placeholder="Quantity" disabled>
          <select id="unit_other" class="unit-select" disabled>
            <option value="Boxes">Boxes</option>
            <option value="Pieces">Pieces</option>
            <option value="Kg">Kg</option>
            <option value="Custom">Custom</option>
          </select>
          <input type="text" id="unit_custom_other" class="unit-custom" placeholder="Custom unit" style="display:none;">
          <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_other" /> lock</label>
        </div>
      </div>
      <div style="margin-top:6px; margin-left:6px;">
        <input id="purchasedOtherText" type="text" placeholder="If Others — specify (e.g. 'Grout, Adhesive')">
      </div>

    </div>

    <!-- Purchased from (dropdown with Customised management) -->
    <label class="q-label">Purchased from</label>
    <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
      <select id="purchasedFromSelect" style="flex:1; padding:8px; font-size:15px;">
        <option value="Delhi Tiles Company">Delhi Tiles Company</option>
        <option value="Mumbai Tiles Company">Mumbai Tiles Company</option>
        <option value="Mumbai Marble Company">Mumbai Marble Company</option>
        <!-- custom vendor options will be inserted here dynamically -->
        <option value="Customised">Customised</option>
        <option value="Other">Other</option>
      </select>
      <!-- keep id 'purchasedFrom' so existing app.js keeps working; show only when Other selected -->
      <input id="purchasedFrom" type="text" placeholder="If Other — specify vendor name" style="flex:1; display:none;">
    </div>

    <!-- custom vendor manager (hidden by default) -->
    <div id="customVendorManager" style="display:none;">
      <div style="font-weight:700; margin-bottom:6px;">Manage custom vendors</div>
      <div class="vendor-list" id="vendorList"></div>
      <div class="vendor-actions">
        <input id="newVendorInput" type="text" placeholder="Add new vendor name" style="flex:1;">
        <button id="addVendorBtn" type="button">Add</button>
      </div>
      <div style="font-size:12px;color:#555;margin-top:8px">Fixed options (Delhi/Mumbai/Mumbai Marble/Other) cannot be removed. Use this panel to add vendors specific to your shop. Click Save (server) to persist changes to the system.</div>
    </div>

    <!-- Mode of payment (checkboxes with inline amounts) -->
    <label class="q-label">Mode of payment (check modes and enter amounts for each)</label>
    <div class="checkbox-row" id="modes">
      <div class="mode-row" data-original="true">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Cash" id="mode_cash"> <span class="editable" data-config-id="mode_cash_label" id="label_mode_cash">Cash</span>
          <button class="del-btn" title="Remove mode" aria-label="Remove">✕</button>
        </label>
        <input type="number" min="0" step="0.01" id="amt_cash" class="mode-amount" placeholder="Cash Rs." disabled data-mode-amount="Cash">
      </div>
      <div class="mode-row" data-original="true">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Online" id="mode_online"> <span class="editable" data-config-id="mode_online_label" id="label_mode_online">Online</span>
          <button class="del-btn" title="Remove mode" aria-label="Remove">✕</button>
        </label>
        <input type="number" min="0" step="0.01" id="amt_online" class="mode-amount" placeholder="Online Rs." disabled data-mode-amount="Online">
      </div>
      <div class="mode-row" data-original="true">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Credit" id="mode_credit"> <span class="editable" data-config-id="mode_credit_label" id="label_mode_credit">Credit</span>
          <button class="del-btn" title="Remove mode" aria-label="Remove">✕</button>
        </label>
        <input type="number" min="0" step="0.01" id="amt_credit" class="mode-amount" placeholder="Credit Rs." disabled data-mode-amount="Credit">
      </div>
    </div>

    <!-- Total (editable) -->
    <label class="q-label">Payment paid (₹) <span style="color:red">*</span></label>
    <input id="paymentPaid" type="number" min="0" step="0.01" placeholder="Total amount" >

    <label class="q-label">Any other information</label>
    <textarea id="otherInfo" rows="2"></textarea>

    <div class="form-actions">
      <button id="submitBtn" type="button">Submit</button>
      <button id="clearBtn" type="button">Clear</button>

      <div style="margin-left:auto;font-weight:600; display:flex; gap:8px; align-items:center;">
        <div>Online:</div>
        <div id="status">online</div>
      </div>
    </div>

    <div id="msg" style="display:none"></div>
    <div id="offlineNotice" class="offline-msg" style="display:none">Connect to internet</div>
    <div class="small" style="margin-top:6px">Status: <span id="status-duplicate" style="display:inline"></span></div>
  </div>

  <script src="app.js"></script> <!-- keep your existing app.js for submission logic -->

  <script>
    // --- Config / server endpoint detection ---
    // prefer global ENDPOINT & SHARED_TOKEN from app.js if present
    const SERVER_ENDPOINT = window.ENDPOINT || "https://script.google.com/macros/s/AKfycbxZ-SbvHs7DeEYUCFqQUX2UDVhBmmvK9wfcrPApfDPe6VJUe3gFJAhbXnpDRldUVZXEvw/exec";
    const SERVER_TOKEN = window.SHARED_TOKEN || "shopSecret2025";

    // small JSONP helper used for config save/load
    function jsonpCall(url, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
        window[cbName] = function(data) {
          try { resolve(data); } finally { try { delete window[cbName]; } catch(e){} }
        };
        const full = url + (url.indexOf('?') === -1 ? '?' : '&') + 'callback=' + cbName;
        const script = document.createElement('script');
        script.src = full;
        script.onerror = function(){ reject(new Error('JSONP load error')); try{ delete window[cbName]; }catch(e){} };
        document.body.appendChild(script);
        setTimeout(() => { try{ delete window[cbName]; }catch(e){} reject(new Error('JSONP timeout')); }, timeoutMs);
      });
    }

    // --- customization logic ---
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('appContainer');
      const gear = document.getElementById('gearBtn');
      const customPanel = document.getElementById('customPanel');
      const applyPreviewBtn = document.getElementById('applyPreviewBtn');
      const saveServerBtn = document.getElementById('saveServerBtn');
      const cancelCustomBtn = document.getElementById('cancelCustomBtn');
      const loadDefaultBtn = document.getElementById('loadDefaultBtn');
      const panelCloseX = document.getElementById('panelCloseX');
      const addCategorySelect = document.getElementById('addCategorySelect');
      const addSubLabelInput = document.getElementById('addSubLabelInput');
      const addSubBtn = document.getElementById('addSubBtn');

      let customizeMode = false;
      let editingSession = false;

      // helper to register an editable element (so dynamically added ones behave like originals)
      function registerEditable(el) {
        if (!el) return;
        el.setAttribute('contenteditable','false');
        el.addEventListener('click', function(ev) {
          if (!customizeMode) return;
          if (editingSession) return;
          alert('Click "Apply Preview" in the customization panel to start editing labels.');
        });
        el.addEventListener('blur', function() {
          if (el.getAttribute('data-editing')) {
            el.contentEditable = "false";
            el.removeAttribute('data-editing');
          }
        });
        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            el.blur();
          }
        });
      }
      // register current editables (initial)
      Array.from(document.querySelectorAll('.editable')).forEach(registerEditable);

      // helper to toggle UI interactivity while customizing
      function setCustomizeMode(on) {
        customizeMode = !!on;
        container.classList.toggle('customize-mode', customizeMode);

        // disable pointer events for inputs & checkboxes to avoid accidental changes
        const interactive = container.querySelectorAll('input, textarea, button');
        interactive.forEach(el => {
          // keep the gear button & customization panel controls active
          if (el.id === 'gearBtn' || el.closest('#customPanel')) return;
          if (customizeMode) {
            el.classList.add('no-pointer');
          } else {
            el.classList.remove('no-pointer');
          }
        });

        if (customizeMode) {
          customPanel.style.display = 'block';
          // show remove buttons
          addRemoveButtons();
        } else {
          customPanel.style.display = 'none';
          // ensure we are not leaving editable state active
          endEditingSession();
          hideRemoveButtons();
        }
      }

      gear.addEventListener('click', function() {
        // toggle panel visibility / mode
        if (!customizeMode) {
          setCustomizeMode(true);
        } else {
          setCustomizeMode(false);
        }
      });

      // start editing session: make labels contentEditable and hide panel
      function startEditingSession() {
        editingSession = true;
        // make labels editable
        Array.from(document.querySelectorAll('.editable')).forEach(el => {
          el.contentEditable = "true";
          el.classList.add('editing');
          el.classList.remove('no-pointer');
        });
        customPanel.style.display = 'none';
        // put focus in first editable
        const first = document.querySelector('.editable');
        if (first) {
          first.focus();
          try {
            if (document.createRange && window.getSelection) {
              const range = document.createRange();
              range.selectNodeContents(first);
              range.collapse(false);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          } catch (e){}
        }
      }

      // end editing session: make labels non-editable
      function endEditingSession() {
        editingSession = false;
        Array.from(document.querySelectorAll('.editable')).forEach(el => {
          try { el.contentEditable = "false"; } catch(e){}
          el.classList.remove('editing');
        });
      }

      // Apply Preview: enter editing session (close panel, allow inline edits)
      applyPreviewBtn.addEventListener('click', function() {
        if (!customizeMode) setCustomizeMode(true);
        startEditingSession();
        alert('Preview: labels are now editable inline. Click any label to edit. When done click Save (server) to persist or Cancel to exit.');
      });

      // Load Default: reload page to restore defaults
      loadDefaultBtn.addEventListener('click', function(){
        if (!confirm('Reload page to restore defaults? Unsaved edits will be lost.')) return;
        window.location.reload();
      });

      // Cancel customization: exit customise mode (and editing)
      cancelCustomBtn.addEventListener('click', function() {
        if (!confirm('Exit customization mode? Unsaved edits will be lost.')) {
          return;
        }
        endEditingSession();
        setCustomizeMode(false);
      });

      // panel close X (same as cancel but leaves customise mode if editing)
      panelCloseX.addEventListener('click', function() {
        if (editingSession) {
          if (!confirm('Editing in progress. Close panel but keep edit mode? (Choose Cancel in panel to abort edits)')) {
            return;
          }
        }
        customPanel.style.display = 'none';
      });

      // Escape key handling: close panel or exit editing
      document.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') {
          if (customPanel.style.display === 'block') {
            customPanel.style.display = 'none';
            return;
          }
          if (editingSession) {
            if (confirm('Exit edit mode? Unsaved changes remain only locally.')) {
              endEditingSession();
              setCustomizeMode(false);
            }
          }
        }
      });

      // ----------------- remove/add helpers -----------------
      function makeRemoveButton() {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'remove-checkbox';
        b.title = 'Remove this item';
        b.textContent = '×';
        b.style.marginLeft = '8px';
        b.style.background = '#ff6b6b';
        b.style.color = '#fff';
        b.style.border = 'none';
        b.style.borderRadius = '50%';
        b.style.width = '26px';
        b.style.height = '26px';
        b.style.lineHeight = '20px';
        b.style.padding = '0';
        b.style.cursor = 'pointer';
        b.style.fontWeight = '700';
        b.style.display = 'inline-flex';
        b.style.alignItems = 'center';
        b.style.justifyContent = 'center';
        b.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
        return b;
      }

      function addRemoveButtons() {
        hideRemoveButtons();
        // mains
        document.querySelectorAll('.item-row').forEach(function(row) {
          if (row.querySelector('.remove-checkbox')) return;
          const btn = makeRemoveButton();
          btn.setAttribute('data-remove-role','main');
          row.appendChild(btn);
        });
        // subitems
        document.querySelectorAll('.sub-item').forEach(function(si) {
          if (si.querySelector('.remove-checkbox')) return;
          const btn = makeRemoveButton();
          btn.setAttribute('data-remove-role','sub');
          si.appendChild(btn);
        });
        // modes
        document.querySelectorAll('.mode-row').forEach(function(mr) {
          if (mr.querySelector('.remove-checkbox')) return;
          const btn = makeRemoveButton();
          btn.setAttribute('data-remove-role','mode');
          mr.appendChild(btn);
        });
      }

      function hideRemoveButtons() {
        document.querySelectorAll('.remove-checkbox').forEach(function(b){ b.remove(); });
      }

     function removeWrapperForButton(btn) {
  if (!btn) return;
  const subItem = btn.closest('.sub-item');
  const itemRow = btn.closest('.item-row');
  const modeRow = btn.closest('.mode-row');

  if (subItem) {
    if (!confirm('Remove this sub-item? This cannot be undone.')) return;
    subItem.remove();
  } else if (itemRow) {
    if (!confirm('Remove this main item and its sub-items? This cannot be undone.')) return;
    try {
      const cb = itemRow.querySelector('input[type="checkbox"].purchased, input[type="checkbox"]');
      if (cb && cb.id) {
        const parts = cb.id.split('_');
        const suffix = parts.length > 1 ? parts.slice(1).join('_') : cb.id;
        const sublistId = 'sublist_' + suffix;
        const sublist = document.getElementById(sublistId);
        if (sublist) sublist.remove();
      }
    } catch(e){}
    itemRow.remove();
  } else if (modeRow) {
    if (!confirm('Remove this payment mode? This cannot be undone.')) return;
    modeRow.remove();
  } else {
    const parent = btn.parentElement;
    if (parent) parent.remove();
  }
  // rebind behaviors after removal
  bindSubitemHandlers();
  setupMainToSubBindings();
}

// delegated click for generated remove buttons
container.addEventListener('click', function(ev) {
  const btn = ev && ev.target && ev.target.closest && ev.target.closest('.remove-checkbox');
  if (!btn) return;
  if (!customizeMode) {
    alert('Enable Customize mode to remove items.');
    return;
  }
  ev.stopPropagation(); ev.preventDefault();
  removeWrapperForButton(btn);
});


// ----------------- binding helpers -----------------
function bindSubitemHandlers() {
  // ensure change handler for each subitem (avoid duplicates)
  document.querySelectorAll('.subitem').forEach(function(sb){
    // suffix example: for id "sub_floor_vitrified" suffix = "floor_vitrified"
    const suffix = sb.id.slice(4);
    const qtyId = 'q' + sb.id.slice(3); // q_floor_vitrified
    const qtyEl = document.getElementById(qtyId);
    const unitEl = document.getElementById('unit_' + suffix);
    const unitCustomEl = document.getElementById('unit_custom_' + suffix);
    const lockEl = document.getElementById('lock_' + suffix);

    // remove old handler if present
    if (sb._custom_qty_handler) {
      sb.removeEventListener('change', sb._custom_qty_handler);
      sb._custom_qty_handler = null;
    }

    const handler = function() {
      const enabled = !!sb.checked;
      if (qtyEl) {
        qtyEl.disabled = !enabled;
        if (!enabled) qtyEl.value = '';
      }
      if (unitEl) {
        unitEl.disabled = !enabled;
        if (!enabled) { unitEl.selectedIndex = 0; }
      }
      if (unitCustomEl) {
        unitCustomEl.disabled = !enabled;
        if (!enabled) { unitCustomEl.style.display = 'none'; /* keep value for locks */ }
      }
      if (lockEl) {
        lockEl.disabled = !enabled;
        if (!enabled) { lockEl.checked = false; }
      }

      // If enabling, apply any locked unit stored in localStorage
      if (enabled) {
        try {
          const lockKey = 'unitLock_' + suffix;
          const valKey = 'unitValue_' + suffix;
          const locked = localStorage.getItem(lockKey) === '1';
          const stored = localStorage.getItem(valKey);
          if (locked && unitEl) {
            // if stored value is one of options select it, otherwise set Custom and fill text
            const opts = Array.from(unitEl.options).map(o => o.value);
            if (opts.indexOf(stored) !== -1) {
              unitEl.value = stored;
              if (unitCustomEl) unitCustomEl.style.display = 'none';
            } else if (stored) {
              unitEl.value = 'Custom';
              if (unitCustomEl) { unitCustomEl.style.display = ''; unitCustomEl.value = stored; }
            }
            if (lockEl) lockEl.checked = true;
          } else {
            // no stored lock => keep whatever UI had, but ensure custom visibility is correct
            if (unitEl && unitEl.value === 'Custom' && unitCustomEl) unitCustomEl.style.display = '';
          }
        } catch (e){}
      }
    };
    sb._custom_qty_handler = handler;
    sb.addEventListener('change', handler);
    if (qtyEl) qtyEl.disabled = !sb.checked;

    // unit change handler: show/hide custom input & if locked save new value
    if (unitEl) {
      if (unitEl._unit_change_bound) {
        unitEl.removeEventListener('change', unitEl._unit_change_bound);
      }
      const unitChange = function() {
        const v = unitEl.value;
        if (unitCustomEl) {
          if (v === 'Custom') {
            unitCustomEl.style.display = '';
            unitCustomEl.disabled = false;
            try { unitCustomEl.focus(); } catch(e){}
          } else {
            unitCustomEl.style.display = 'none';
            // do not clear unitCustomEl.value here (preserve for locks)
            unitCustomEl.disabled = true;
          }
        }
        // if lock is enabled, save selected/custom value immediately
        if (lockEl && lockEl.checked) {
          saveUnitLock(suffix);
        }
      };
      unitEl._unit_change_bound = unitChange;
      unitEl.addEventListener('change', unitChange);
      if (unitEl) unitEl.disabled = !sb.checked;
      if (unitEl && unitEl.value === 'Custom' && unitCustomEl) unitCustomEl.style.display = '';
    }

    // custom unit text input: on blur/update if lock checked save value
    if (unitCustomEl) {
      if (unitCustomEl._custom_input_bound) {
        unitCustomEl.removeEventListener('input', unitCustomEl._custom_input_bound);
      }
      const customInputHandler = function() {
        if (lockEl && lockEl.checked) saveUnitLock(suffix);
      };
      unitCustomEl._custom_input_bound = customInputHandler;
      unitCustomEl.addEventListener('input', customInputHandler);
      unitCustomEl.disabled = !sb.checked;
    }

    // lock checkbox handling
    if (lockEl) {
      if (lockEl._lock_change_bound) {
        lockEl.removeEventListener('change', lockEl._lock_change_bound);
      }
      const lockHandler = function() {
        if (lockEl.checked) {
          // save current selection (or custom)
          saveUnitLock(suffix);
          showTempMessage('Unit locked for this item.');
        } else {
          // remove saved value
          try { localStorage.removeItem('unitLock_' + suffix); localStorage.removeItem('unitValue_' + suffix); } catch(e){}
          showTempMessage('Unit unlocked for this item.');
        }
      };
      lockEl._lock_change_bound = lockHandler;
      lockEl.addEventListener('change', lockHandler);
      lockEl.disabled = !sb.checked;
    }

    // initialize visibility & lock on bind
    if (sb.checked) {
      handler();
    } else {
      // ensure unit inputs disabled when unchecked
      if (qtyEl) qtyEl.disabled = true;
      if (unitEl) unitEl.disabled = true;
      if (unitCustomEl) { unitCustomEl.disabled = true; unitCustomEl.style.display = 'none'; }
      if (lockEl) { lockEl.disabled = true; lockEl.checked = false; }
    }
  });

  // others main
  const otherMain = document.getElementById('p_other');
  const otherQty = document.getElementById('q_other');
  const otherUnit = document.getElementById('unit_other');
  const otherUnitCustom = document.getElementById('unit_custom_other');
  const otherLock = document.getElementById('lock_other');
  if (otherMain && otherQty) {
    if (otherMain._custom_other_handler) otherMain.removeEventListener('change', otherMain._custom_other_handler);
    const oh = function() {
      const enabled = otherMain.checked;
      otherQty.disabled = !enabled;
      if (!enabled) otherQty.value = '';
      if (otherUnit) {
        otherUnit.disabled = !enabled;
        if (!enabled) otherUnit.selectedIndex = 0;
      }
      if (otherUnitCustom) {
        otherUnitCustom.disabled = !enabled;
        if (!enabled) { otherUnitCustom.style.display = 'none'; /* preserve value for locks */ }
      }
      if (otherLock) {
        otherLock.disabled = !enabled;
        if (!enabled) otherLock.checked = false;
      }

      if (enabled) {
        try {
          const suffix = 'other';
          const locked = localStorage.getItem('unitLock_' + suffix) === '1';
          const stored = localStorage.getItem('unitValue_' + suffix);
          if (locked && otherUnit) {
            const opts = Array.from(otherUnit.options).map(o => o.value);
            if (opts.indexOf(stored) !== -1) {
              otherUnit.value = stored;
              if (otherUnitCustom) otherUnitCustom.style.display = 'none';
            } else if (stored) {
              otherUnit.value = 'Custom';
              if (otherUnitCustom) { otherUnitCustom.style.display = ''; otherUnitCustom.value = stored; }
            }
            if (otherLock) otherLock.checked = true;
          } else if (otherUnit && otherUnit.value === 'Custom' && otherUnitCustom) {
            otherUnitCustom.style.display = '';
          }
        } catch(e){}
      }
    };
    otherMain._custom_other_handler = oh;
    otherMain.addEventListener('change', oh);
    oh();
  }
}

function setupMainToSubBindings() {
  const mainToSub = {
    'p_floor': 'sublist_floor',
    'p_wall': 'sublist_wall',
    'p_san':  'sublist_san',
    'p_acc':  'sublist_acc'
  };
  Object.keys(mainToSub).forEach(mainId => {
    const mainCb = document.getElementById(mainId);
    const subDiv = document.getElementById(mainToSub[mainId]);
    if (!mainCb || !subDiv) return;
    if (mainCb._custom_main_toggle) mainCb.removeEventListener('change', mainCb._custom_main_toggle);
    const update = function() {
      subDiv.style.display = mainCb.checked ? 'block' : 'none';
      if (!mainCb.checked) {
        // clear and disable subitems (quantity + unit)
        subDiv.querySelectorAll('.subitem').forEach(sb => { sb.checked = false; });
        subDiv.querySelectorAll('.subqty').forEach(q => { q.value=''; q.disabled = true; });
        subDiv.querySelectorAll('.unit-select').forEach(u => { u.selectedIndex = 0; u.disabled = true; });
        subDiv.querySelectorAll('.unit-custom').forEach(uc => { uc.value=''; uc.style.display='none'; uc.disabled = true; });
        subDiv.querySelectorAll('.unit-lock input[type="checkbox"]').forEach(lk => { lk.checked = false; lk.disabled = true; });
      }
    };
    mainCb._custom_main_toggle = update;
    mainCb.addEventListener('change', update);
    update();
  });
}
      // ----- Ensure main purchased checkboxes toggle their sublists -----
// Place this after bindSubitemHandlers() and setupMainToSubBindings() in DOMContentLoaded
document.querySelectorAll('.purchased').forEach(function(cb){
  // avoid double-binding
  if (cb._main_toggle_bound) return;
  cb._main_toggle_bound = true;

  cb.addEventListener('change', function() {
    try {
      const id = this.id || '';
      const parts = id.split('_');
      const suffix = parts.length > 1 ? parts.slice(1).join('_') : id;
      const sublist = document.getElementById('sublist_' + suffix);
      if (!sublist) return;

      // show/hide the sublist
      sublist.style.display = this.checked ? 'block' : 'none';

      if (!this.checked) {
        // clear and disable nested controls when main unchecks
        sublist.querySelectorAll('.subitem').forEach(si => { si.checked = false; });
        sublist.querySelectorAll('.subqty').forEach(q => { q.value = ''; q.disabled = true; });
        sublist.querySelectorAll('.unit-select').forEach(u => { try { u.selectedIndex = 0; u.disabled = true; } catch(e){} });
        sublist.querySelectorAll('.unit-custom').forEach(uc => { uc.style.display = 'none'; uc.disabled = true; /* keep value for locks */ });
        sublist.querySelectorAll('.unit-lock input[type="checkbox"]').forEach(lk => { lk.checked = false; lk.disabled = true; });
      } else {
        // If main was checked, let bindSubitemHandlers drive enabling of qty/unit when each subitem is checked
        // but enable the selects if you prefer them active by default:
        // sublist.querySelectorAll('.unit-select').forEach(u => { u.disabled = false; });
      }
    } catch (e) { console.warn('main checkbox toggle err', e); }
  });

  // trigger initial state so sublists are correctly visible/hidden on load
  try { cb.dispatchEvent(new Event('change')); } catch(e){}
});


// generic mode checkbox -> enable its amount input (works for static & dynamic modes)
function bindModeToggle(modeCheckbox) {
  if (!modeCheckbox) return;
  if (modeCheckbox._boundModeToggle) return;
  modeCheckbox._boundModeToggle = true;
  const parent = modeCheckbox.closest('.mode-row');
  if (!parent) return;
  const amtInput = parent.querySelector('input[type="number"].mode-amount');
  modeCheckbox.addEventListener('change', function() {
    if (amtInput) {
      amtInput.disabled = !modeCheckbox.checked;
      if (!modeCheckbox.checked) amtInput.value = '';
      // recalc total when mode toggled
      recalcPaymentFromModes();
    }
  });
  if (amtInput) {
    amtInput.disabled = !modeCheckbox.checked;
    // whenever amount changes directly, recalc
    if (!amtInput._boundAmtInput) {
      amtInput.addEventListener('input', function(){ recalcPaymentFromModes(); });
      amtInput._boundAmtInput = true;
    }
  }
}

// helper to save unit lock for a given suffix
function saveUnitLock(suffix) {
  try {
    const unitEl = document.getElementById('unit_' + suffix);
    const customEl = document.getElementById('unit_custom_' + suffix);
    if (!unitEl) return;
    let val = unitEl.value;
    if (val === 'Custom' && customEl && customEl.value && customEl.value.trim()) val = customEl.value.trim();
    localStorage.setItem('unitLock_' + suffix, '1');
    localStorage.setItem('unitValue_' + suffix, val);
  } catch (e) { console.warn('saveUnitLock err', e); }
}

// helper to load locks for all unit-selects on startup
function initializeUnitLocks() {
  try {
    document.querySelectorAll('.unit-select').forEach(function(unitEl) {
      const id = unitEl.id; // e.g. unit_floor_vitrified
      if (!id || id.indexOf('unit_') !== 0) return;
      const suffix = id.slice(5);
      const lockKey = 'unitLock_' + suffix;
      const valKey = 'unitValue_' + suffix;
      const locked = localStorage.getItem(lockKey) === '1';
      const stored = localStorage.getItem(valKey);
      const customEl = document.getElementById('unit_custom_' + suffix);
      const lockEl = document.getElementById('lock_' + suffix);
      if (locked) {
        if (stored) {
          const opts = Array.from(unitEl.options).map(o => o.value);
          if (opts.indexOf(stored) !== -1) {
            unitEl.value = stored;
            if (customEl) customEl.style.display = 'none';
          } else {
            unitEl.value = 'Custom';
            if (customEl) { customEl.style.display = ''; customEl.value = stored; }
          }
        }
        if (lockEl) lockEl.checked = true;
      }
    });
  } catch (e) {}
}

// run initial binds so default items keep working
bindSubitemHandlers();
setupMainToSubBindings();
document.querySelectorAll('input[name="modeOfPayment"]').forEach(bindModeToggle);
// initialize any saved unit locks so UI reflects previous choices
initializeUnitLocks();

// ---------------- Global custom-units manager ----------------
// key used in localStorage
const GLOBAL_UNITS_KEY = 'globalUnits_v1';

// default units (keeps "Custom" available as option)
const DEFAULT_GLOBAL_UNITS = ['Boxes','Pieces','Kg','Custom'];

// load saved units (returns array, always keeps 'Custom' at end)
function loadGlobalUnits() {
  try {
    const raw = localStorage.getItem(GLOBAL_UNITS_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed) && parsed.length > 0) {
        // ensure 'Custom' present and at end
        const list = parsed.slice();
        if (list.indexOf('Custom') === -1) list.push('Custom');
        else {
          // move Custom to end
          list.splice(list.indexOf('Custom'),1);
          list.push('Custom');
        }
        return list;
      }
    }
  } catch(e){}
  return DEFAULT_GLOBAL_UNITS.slice();
}

function saveGlobalUnits(arr) {
  try {
    // keep unique and stable order, ensure 'Custom' exists at end
    const uniq = Array.from(new Set((arr || []).filter(Boolean)));
    if (uniq.indexOf('Custom') === -1) uniq.push('Custom');
    localStorage.setItem(GLOBAL_UNITS_KEY, JSON.stringify(uniq));
  } catch(e){}
}

// Add a new unit (if missing), then rebuild selects. Returns true if added.
function addGlobalUnitIfMissing(unit) {
  try {
    unit = (unit || "").toString().trim();
    if (!unit) return false;
    if (unit.toLowerCase() === 'custom') return false;
    const list = loadGlobalUnits();
    // case-insensitive dedupe
    if (list.some(u => u.toLowerCase() === unit.toLowerCase())) return false;
    // insert before 'Custom'
    const idx = list.indexOf('Custom');
    if (idx === -1) list.push(unit);
    else list.splice(idx, 0, unit);
    saveGlobalUnits(list);
    rebuildAllUnitSelects();
    return true;
  } catch(e){ console.warn('addGlobalUnitIfMissing err', e); }
  return false;
}

// Remove a custom unit (does not touch existing locked values)
function removeGlobalUnit(unit) {
  try {
    unit = (unit || "").toString().trim();
    if (!unit) return false;
    let list = loadGlobalUnits();
    list = list.filter(u => u !== unit);
    if (list.indexOf('Custom') === -1) list.push('Custom');
    saveGlobalUnits(list);
    rebuildAllUnitSelects();
    return true;
  } catch(e){ console.warn('removeGlobalUnit err', e); }
  return false;
}

// Rebuild a single select from global units; preserve previous selection when possible
function rebuildUnitSelect(sel) {
  try {
    if (!sel) return;
    const current = sel.value || '';
    const units = loadGlobalUnits();
    sel.innerHTML = '';
    units.forEach(u => {
      const o = document.createElement('option');
      o.value = u; o.textContent = u;
      sel.appendChild(o);
    });
    // if previous selected still exists, keep it, else pick first
    if (current && Array.from(sel.options).some(o=>o.value === current)) {
      sel.value = current;
    } else {
      sel.selectedIndex = 0;
    }
    // trigger change so custom input visibility updates (if handler exists)
    try { sel.dispatchEvent(new Event('change')); } catch(e){}
  } catch(e){ console.warn('rebuildUnitSelect err', e); }
}

// Rebuild all unit-selects on page
function rebuildAllUnitSelects() {
  try {
    document.querySelectorAll('.unit-select').forEach(sel => rebuildUnitSelect(sel));
  } catch(e){ console.warn('rebuildAllUnitSelects err', e); }
}

// show unit manager list UI and wire handlers (call once on DOMContentLoaded)
function initUnitManagerUI() {
  try {
    const listEl = document.getElementById('unitList');
    const input = document.getElementById('newUnitInput');
    const addBtn = document.getElementById('addUnitBtn');
    const clearBtn = document.getElementById('clearUnitsBtn');
    function renderList() {
      const units = loadGlobalUnits().slice(0);
      // remove built-in Custom for the list view
      const visible = units.filter(u => u !== 'Custom');
      if (!listEl) return;
      listEl.innerHTML = '';
      if (visible.length === 0) {
        listEl.innerHTML = '<div style="color:#666;">No custom units added yet.</div>';
        return;
      }
      visible.forEach(u => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '6px';
        row.style.borderBottom = '1px solid #eee';
        const left = document.createElement('div'); left.textContent = u;
        const right = document.createElement('div');
        const rem = document.createElement('button');
        rem.type = 'button';
        rem.textContent = 'Remove';
        rem.style.background = '#b71c1c'; rem.style.color = '#fff'; rem.style.border = 'none'; rem.style.padding = '6px 8px'; rem.style.borderRadius = '6px';
        rem.addEventListener('click', function(){
          if (!confirm('Remove unit "' + u + '" from the global list? This will not change already-locked unit values.')) return;
          removeGlobalUnit(u);
          renderList();
        });
        right.appendChild(rem);
        row.appendChild(left); row.appendChild(right);
        listEl.appendChild(row);
      });
    }

    if (addBtn) {
      addBtn.addEventListener('click', function(){
        const val = input && input.value ? input.value.trim() : '';
        if (!val) { alert('Enter custom unit label'); return; }
        if (addGlobalUnitIfMissing(val)) {
          input.value = '';
          renderList();
          showTempMessage('Added custom unit: ' + val);
        } else {
          alert('Unit already exists or invalid.');
        }
      });
    }
    if (input) {
      input.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); addBtn.click(); }});
    }
    if (clearBtn) {
      clearBtn.addEventListener('click', function(){
        if (!confirm('Remove all custom units? This will restore default units.')) return;
        // reset to default
        saveGlobalUnits(DEFAULT_GLOBAL_UNITS.slice());
        renderList();
        showTempMessage('Custom units cleared');
      });
    }

    renderList();
  } catch(e){ console.warn('initUnitManagerUI err', e); }
}

// Unified body-level listeners (single change and single input handler)
// Handles unit-select -> show custom input, mode checkbox toggles, and mode-amount recalc
document.body.addEventListener('change', function(ev) {
  const t = ev.target;
  if (!t) return;

  // UNIT SELECT: show/hide and enable custom input even when parent unchecked
  if (t.matches('.unit-select')) {
    const id = t.id || '';
    if (!id) return;
    const suffix = id.slice(5);
    const customEl = document.getElementById('unit_custom_' + suffix);
    if (!customEl) return;
    if (t.value === 'Custom') {
      customEl.style.display = '';
      customEl.disabled = false;
      try { customEl.focus(); } catch(e){}
    } else {
      customEl.style.display = 'none';
      customEl.disabled = true;
      // preserve customEl.value (used for locks)
    }
    return;
  }

  // MODE CHECKBOX (toggle): enable/disable its amount and recalc total
  if (t.matches('input[name="modeOfPayment"]')) {
    const parent = t.closest && t.closest('.mode-row');
    if (parent) {
      const amt = parent.querySelector('input.mode-amount');
      if (amt) {
        amt.disabled = !t.checked;
        if (!t.checked) amt.value = '';
      }
    }
    recalcPaymentFromModes();
    return;
  }
});

// Unified input listener: handles unit-custom typing (debounced) and mode amount changes
document.body.addEventListener('input', function(ev) {
  const t = ev.target;
  if (!t) return;

  // MODE AMOUNT -> recalc
  if (t.matches('input.mode-amount')) {
    recalcPaymentFromModes();
    return;
  }

  // UNIT CUSTOM -> add to global units and promote into select
  if (t.matches('.unit-custom')) {
    const id = t.id || '';
    if (!id || !id.startsWith('unit_custom_')) return;
    const suffix = id.slice('unit_custom_'.length);
    const value = (t.value || '').trim();
    // debounce per-element
    if (t._deb) clearTimeout(t._deb);
    t._deb = setTimeout(function() {
      t._deb = null;
      if (!value) return;
      // add to global list
      const added = addGlobalUnitIfMissing(value);
      // find select and set to new unit if present
      try {
        const sel = document.getElementById('unit_' + suffix);
        if (sel) {
          const match = Array.from(sel.options).find(o => o.value.toLowerCase() === value.toLowerCase());
          if (match) {
            sel.value = match.value;
            // hide & disable the custom input (we promoted the value into the select)
            t.style.display = 'none';
            t.disabled = true;
          } else if (added) {
            // rebuildAllUnitSelects was called, just set value
            sel.value = value;
            t.style.display = 'none';
            t.disabled = true;
          }
        }
      } catch(e){ console.warn('promote custom unit err', e); }
    }, 400);
    return;
  }
});

// ----- MODE OF PAYMENT SYNC: auto-sum mode amounts into "paymentPaid" -----
// Computes sum of enabled mode amounts and writes to #paymentPaid (rounded to 2 decimals)
function recalcPaymentFromModes() {
  try {
    const amtEls = Array.from(document.querySelectorAll('input.mode-amount'));
    let sum = 0;
    amtEls.forEach(el => {
      // only include if its linked checkbox is checked OR element has data-mode-amount and non-zero
      let include = true;
      const parent = el.closest && el.closest('.mode-row');
      if (parent) {
        const cb = parent.querySelector('input[name="modeOfPayment"], input[type="checkbox"]');
        if (cb) include = !!cb.checked;
      }
      if (!include) return;
      const v = el.value ? Number(el.value) : 0;
      if (!isNaN(v)) sum += v;
    });
    const pay = document.getElementById('paymentPaid');
    if (pay) {
      // reflect mode amounts sum in the total
      pay.value = (Math.round(sum * 100) / 100).toFixed(2);
    }
  } catch(e){ console.warn('recalcPaymentFromModes err', e); }
}

// initialize unit manager UI and rebuild selects after DOM ready/locks loaded
try {
  rebuildAllUnitSelects();
  initUnitManagerUI();
  // run recalc once on load so paymentPaid picks up any pre-filled mode amounts
  recalcPaymentFromModes();
} catch(e){ console.warn('unit patch init err', e); }

        // when select changes
        function handleSelectChange() {
          if (!sel || !txt) return;
          const val = sel.value;
          // If user selected the special 'Customised' option: open manager, revert selection to previous
          if (val === 'Customised') {
            manager.style.display = '';
            // restore previous selection (so clicking 'Customised' only opens manager)
            if (prevSelected && prevSelected !== 'Customised') {
              const match = Array.from(sel.options).find(o => o.value === prevSelected);
              if (match) sel.value = prevSelected;
            } else {
              // if no prev, select first custom vendor or first fixed
              if (customVendors.length > 0) {
                sel.value = customVendors[0];
              } else {
                sel.selectedIndex = 0;
              }
            }
            // ensure selected value reflects actual vendor
            updateHiddenPurchasedFrom();
            return;
          }

          // hide manager for other selections
          manager.style.display = (val === 'Customised') ? '' : 'none';

          // Other -> show text input for free entry
          if (val === 'Other') {
            txt.style.display = '';
            txt.value = '';
            txt.focus && txt.focus();
            txt.disabled = false;
          } else {
            // normal vendor selected -> hide text input & set its value so app.js can read
            txt.style.display = 'none';
            txt.value = val;
            txt.disabled = false;
          }
          prevSelected = sel.value;
          updateHiddenPurchasedFrom();
        }

        function updateHiddenPurchasedFrom() {
          // ensure the hidden text field (purchasedFrom) contains the final vendor name for app.js to read
          if (!sel || !txt) return;
          if (sel.value === 'Other') {
            // user must type into txt
            // leave as-is
          } else {
            // set txt to selection value
            txt.value = sel.value;
          }
        }

        // apply initial custom vendors from localStorage if present
        try {
          const local = localStorage.getItem('purchasedFromCustom');
          if (local) {
            const parsed = JSON.parse(local);
            if (parsed && Array.isArray(parsed.items)) {
              customVendors = parsed.items.slice();
              rebuildSelect(parsed.selected || '');
              renderVendorList();
            } else {
              rebuildSelect();
              renderVendorList();
            }
          } else {
            rebuildSelect();
            renderVendorList();
          }
        } catch(e){
          rebuildSelect();
          renderVendorList();
        }

        // attach events
        sel.addEventListener('change', function(){ handleSelectChange(); });
        // text input save on blur -> keep selection consistent
        txt.addEventListener('input', function(){ /* no-op; app.js reads txt when submitting */ });

        // public helper used in applyConfig path to set items & selection
        window.__applyPurchasedFromConfig = function(items, selected) {
          try {
            customVendors = Array.isArray(items) ? items.slice() : [];
            // store locally
            try { localStorage.setItem('purchasedFromCustom', JSON.stringify({ items: customVendors, selected: selected || '' })); } catch(e){}
            renderVendorList();
            rebuildSelect(selected || '');
          } catch(e){}
        };

        // expose a small local helper to let applyConfig call it
        function loadFromConfig(cfgItems, cfgSelected) {
          window.__applyPurchasedFromConfig(cfgItems, cfgSelected);
        }

        // also expose function used earlier in applyConfig
        window.applyPurchasedFromConfig = function(items, selected) {
          loadFromConfig(items, selected);
        };

      })();
      // ----------------------------------------------------------------------

    // DOMContentLoaded end
  </script>
</body>
</html>





