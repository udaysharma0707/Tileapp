<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tile Purchase Entry</title>
  <link rel="manifest" href="manifest.json">
  <style>
    html,body { height:100%; margin:0; padding:0; }
    body {
      background-image: url('./background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      font-family: Arial, sans-serif;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    .container {
      width:100%;
      max-width:920px;
      background: rgba(255,255,255,0.98);
      border-radius:10px;
      padding:14px;
      box-sizing:border-box;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      position: relative;
    }
    h1{font-size:20px;margin:0 0 10px 0; display:flex; align-items:center; gap:8px;}
    .gear {
      margin-left:auto; cursor:pointer; font-size:18px; color:#2c7be5;
    }
    .q-label{display:block;margin-top:10px;font-weight:600}
    input[type="text"], input[type="number"], select, textarea {
      width:100%; padding:8px; font-size:15px; margin-top:6px; box-sizing:border-box;
      border:1px solid #ccc; border-radius:4px;
    }
    /* main item row and nested sublist */
    .item-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .item-row label { flex:1; display:flex; align-items:center; gap:8px; }
    .qty { width:110px; flex:0 0 110px; }
    .sublist { margin-left:28px; margin-top:6px; padding-left:6px; border-left:2px solid rgba(0,0,0,0.04); display:none; }
    .sub-item { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .sub-item label { flex:1; display:flex; align-items:center; gap:8px; }
    .checkbox-row { margin-top:6px; padding:0; }
    .cb { display:block; width:100%; padding:6px 0; box-sizing:border-box; }

    /* payment inline controls */
    .mode-row { display:flex; align-items:center; gap:12px; margin-top:6px; }
    .mode-row .mode-label { flex:1; display:flex; align-items:center; gap:8px; }
    .mode-amount { width:160px; flex:0 0 160px; }
    .total-row { margin-top:8px; display:flex; gap:12px; align-items:center; }
    .total-row label { font-weight:600; }

    button{ margin-top:12px; padding:10px 14px; font-size:16px; border-radius:6px; border: none; background:#2c7be5; color:white; cursor:pointer; }
    button#clearBtn { background:#6c757d; }
    .offline-msg { margin-top:10px; color:#b71c1c; font-weight:700; font-size:15px; }
    .small{font-size:13px;color:#666;margin-top:6px}
    .form-actions { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }

    @media (max-width:920px){
      .container { padding:10px; }
    }
    @media (max-width:620px){
      .item-row { flex-direction:column; align-items:flex-start }
      .qty { width:100%; flex:0 0 auto }
      .sub-item { flex-direction:column; align-items:flex-start }
      .mode-row { flex-direction:column; align-items:stretch }
      .mode-amount { width:100%; flex:auto }
      .total-row { flex-direction:column; align-items:stretch }
    }

    /* make touch targets larger for checkboxes (and slightly larger radios) */
    input[type="checkbox"] {
      transform: scale(1.45);
      margin-right: 10px;
      -webkit-transform: scale(1.45);
      -webkit-margin-end: 10px;
    }
    input[type="radio"] {
      transform: scale(1.25);
      margin-right: 8px;
      -webkit-transform: scale(1.25);
    }
    .cb input[type="checkbox"], .cb input[type="radio"] {
      vertical-align: middle;
    }

    /* editable label visuals */
    .editable { padding:2px 6px; border-radius:4px; cursor:text; display:inline-block; }
    .customize-mode .editable { background: #fffbe6; border:1px dashed #ffd966; }
    .editable[contenteditable="true"] { outline: 2px solid #2c7be5; background: #ffffff; }

    /* small modal panel for customization instructions & buttons */
    #customPanel {
      position: fixed; top: 90px; left: 50%; transform: translateX(-50%);
      width: 760px; max-width:calc(100% - 24px);
      background: white; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      padding:12px; z-index: 1200; display:none;
    }
    #customPanel .panel-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    #customPanel .panel-row .note { flex:1; font-size:14px; color:#333; }
    #customPanel .panel-actions { display:flex; gap:8px; }
    #customPanel .close-x { position:absolute; right:10px; top:8px; background:transparent; border:none; font-size:20px; cursor:pointer; }

    /* small top-right badge showing Customize mode on */
    .custom-mode-badge {
      position: absolute; right: 16px; top: 12px; padding:6px 8px; background:#fff4cc; border-radius:6px; color:#6a4f00; font-weight:700; display:none;
    }
    .customize-mode .custom-mode-badge { display:block; }

    /* prevent pointer interactions for inputs while editing (applied when customization active) */
    .customize-mode .no-pointer { pointer-events: none; opacity: 0.7; }

  </style>
</head>
<body>
  <div class="container" id="appContainer">
     <a class="sheet-link"
       href="https://docs.google.com/spreadsheets/d/1YyjZjRbePZ4fL40hKgJloSLJMzWZgW-6fFIvc-A7ELQ/edit"
       target="_blank" rel="noopener" aria-label="Open Google sheet">Google sheet</a>
    <h1>
      <span id="appTitle">Tile Purchase Entry</span>
      <span class="gear" id="gearBtn" title="Customize form">⚙️</span>
    </h1>

    <div class="custom-mode-badge">Customize mode</div>

    <!-- Customize panel (hidden by default) -->
    <div id="customPanel" role="dialog" aria-modal="true" aria-label="Customize form">
      <button class="close-x" id="panelCloseX" title="Close (Esc)">×</button>
      <strong>Customize form text</strong>
      <div style="margin-top:8px">Click any visible text label on the form to edit it directly. After editing, use <b>Apply Preview</b> to try changes locally or <b>Save (server)</b> to store the customization so it will persist next time the app loads.</div>
      <div class="panel-row">
        <div class="note">When customizing, form controls are temporarily disabled to avoid accidental clicks. Only text labels are editable.</div>
        <div class="panel-actions">
          <button id="loadDefaultBtn" type="button">Load Default</button>
          <button id="applyPreviewBtn" type="button">Apply Preview</button>
          <button id="saveServerBtn" type="button">Save (server)</button>
          <button id="cancelCustomBtn" type="button" style="background:#6c757d">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Purchased items with inline qty and nested subitems -->
    <label class="q-label">1. <span id="qPurchasedLabel">Purchased what (check items and enter quantity for specific sub-items)</span></label>
    <div class="checkbox-row" id="purchasedList">

      <!-- FLOOR TILES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_floor" value="Floor Tiles">
          <span class="editable" data-config-id="p_floor_label" id="label_p_floor">Floor Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_floor">
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_floor_vitrified" value="Vitrified tiles">
            <span class="editable" data-config-id="sub_floor_vitrified_label" id="label_sub_floor_vitrified">Vitrified tiles (most popular for homes/offices)</span>
          </label>
          <input type="number" min="0" step="1" id="q_floor_vitrified" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_floor_ceramic" value="Ceramic tiles">
            <span class="editable" data-config-id="sub_floor_ceramic_label" id="label_sub_floor_ceramic">Ceramic tiles</span>
          </label>
          <input type="number" min="0" step="1" id="q_floor_ceramic" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_floor_porcelain" value="Porcelain tiles">
            <span class="editable" data-config-id="sub_floor_porcelain_label" id="label_sub_floor_porcelain">Porcelain tiles</span>
          </label>
          <input type="number" min="0" step="1" id="q_floor_porcelain" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_floor_marble" value="Marble finish tiles">
            <span class="editable" data-config-id="sub_floor_marble_label" id="label_sub_floor_marble">Marble finish tiles</span>
          </label>
          <input type="number" min="0" step="1" id="q_floor_marble" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_floor_granite" value="Granite finish tiles">
            <span class="editable" data-config-id="sub_floor_granite_label" id="label_sub_floor_granite">Granite finish tiles</span>
          </label>
          <input type="number" min="0" step="1" id="q_floor_granite" class="subqty qty" placeholder="How many" disabled>
        </div>
      </div>

      <!-- WALL TILES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_wall" value="Wall Tiles">
          <span class="editable" data-config-id="p_wall_label" id="label_p_wall">Wall Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_wall">
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_wall_kitchen" value="Kitchen wall tiles (backsplash)">
            <span class="editable" data-config-id="sub_wall_kitchen_label" id="label_sub_wall_kitchen">Kitchen wall tiles (backsplash)</span>
          </label>
          <input type="number" min="0" step="1" id="q_wall_kitchen" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_wall_bath" value="Bathroom wall tiles (glazed/anti-skid)">
            <span class="editable" data-config-id="sub_wall_bath_label" id="label_sub_wall_bath">Bathroom wall tiles (glazed/anti-skid)</span>
          </label>
          <input type="number" min="0" step="1" id="q_wall_bath" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_wall_decor" value="Decorative/Designer wall tiles">
            <span class="editable" data-config-id="sub_wall_decor_label" id="label_sub_wall_decor">Decorative / designer wall tiles</span>
          </label>
          <input type="number" min="0" step="1" id="q_wall_decor" class="subqty qty" placeholder="How many" disabled>
        </div>
      </div>

      <!-- SANITARYWARE -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_san" value="Sanitaryware">
          <span class="editable" data-config-id="p_san_label" id="label_p_san">Sanitaryware</span>
        </label>
      </div>
      <div class="sublist" id="sublist_san">
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_san_wash" value="Washbasins">
            <span class="editable" data-config-id="sub_san_wash_label" id="label_sub_san_wash">Washbasins</span>
          </label>
          <input type="number" min="0" step="1" id="q_san_wash" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_san_wc" value="WC">
            <span class="editable" data-config-id="sub_san_wc_label" id="label_sub_san_wc">WC</span>
          </label>
          <input type="number" min="0" step="1" id="q_san_wc" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_san_urinal" value="Urinals">
            <span class="editable" data-config-id="sub_san_urinal_label" id="label_sub_san_urinal">Urinals</span>
          </label>
          <input type="number" min="0" step="1" id="q_san_urinal" class="subqty qty" placeholder="How many" disabled>
        </div>
      </div>

      <!-- ACCESSORIES -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_acc" value="Accessories">
          <span class="editable" data-config-id="p_acc_label" id="label_p_acc">Accessories</span>
        </label>
      </div>
      <div class="sublist" id="sublist_acc">
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_acc_grout" value="Tile grout & adhesives">
            <span class="editable" data-config-id="sub_acc_grout_label" id="label_sub_acc_grout">Tile grout & adhesives</span>
          </label>
          <input type="number" min="0" step="1" id="q_acc_grout" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_acc_spacers" value="Spacers">
            <span class="editable" data-config-id="sub_acc_spacers_label" id="label_sub_acc_spacers">Spacers</span>
          </label>
          <input type="number" min="0" step="1" id="q_acc_spacers" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_acc_sealants" value="Sealants">
            <span class="editable" data-config-id="sub_acc_sealants_label" id="label_sub_acc_sealants">Sealants</span>
          </label>
          <input type="number" min="0" step="1" id="q_acc_sealants" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_acc_chem" value="Chemicals">
            <span class="editable" data-config-id="sub_acc_chem_label" id="label_sub_acc_chem">Chemicals</span>
          </label>
          <input type="number" min="0" step="1" id="q_acc_chem" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_acc_skirting" value="Skirting & border tiles">
            <span class="editable" data-config-id="sub_acc_skirting_label" id="label_sub_acc_skirting">Skirting & border tiles</span>
          </label>
          <input type="number" min="0" step="1" id="q_acc_skirting" class="subqty qty" placeholder="How many" disabled>
        </div>
        <div class="sub-item">
          <label><input type="checkbox" class="subitem" id="sub_acc_mosaic" value="Mosaic tiles for decoration">
            <span class="editable" data-config-id="sub_acc_mosaic_label" id="label_sub_acc_mosaic">Mosaic tiles for decoration</span>
          </label>
          <input type="number" min="0" step="1" id="q_acc_mosaic" class="subqty qty" placeholder="How many" disabled>
        </div>
      </div>

      <!-- OTHERS (main) — keep simple: checked + custom name + qty -->
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_other" value="Others">
          <span class="editable" data-config-id="p_other_label" id="label_p_other">Others</span>
        </label>
        <input type="number" min="0" step="1" id="q_other" class="qty" placeholder="How many" disabled>
      </div>
      <div style="margin-top:6px; margin-left:6px;">
        <input id="purchasedOtherText" type="text" placeholder="If Others — specify (e.g. 'Grout, Adhesive')">
      </div>

    </div>

    <!-- Purchased from -->
    <label class="q-label">Purchased from</label>
    <input id="purchasedFrom" type="text" placeholder="Vendor name">

    <!-- Mode of payment (checkboxes with inline amounts) -->
    <label class="q-label">Mode of payment (check modes and enter amounts for each)</label>
    <div class="checkbox-row" id="modes">
      <div class="mode-row">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Cash" id="mode_cash"> <span class="editable" data-config-id="mode_cash_label" id="label_mode_cash">Cash</span></label>
        <input type="number" min="0" step="0.01" id="amt_cash" class="mode-amount" placeholder="Cash Rs." disabled>
      </div>
      <div class="mode-row">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Online" id="mode_online"> <span class="editable" data-config-id="mode_online_label" id="label_mode_online">Online</span></label>
        <input type="number" min="0" step="0.01" id="amt_online" class="mode-amount" placeholder="Online Rs." disabled>
      </div>
      <div class="mode-row">
        <label class="mode-label"><input type="checkbox" name="modeOfPayment" value="Credit" id="mode_credit"> <span class="editable" data-config-id="mode_credit_label" id="label_mode_credit">Credit</span></label>
        <input type="number" min="0" step="0.01" id="amt_credit" class="mode-amount" placeholder="Credit Rs." disabled>
      </div>
    </div>

    <!-- Total (editable) -->
    <label class="q-label">Payment paid (₹) <span style="color:red">*</span></label>
    <input id="paymentPaid" type="number" min="0" step="0.01" placeholder="Total amount" >

    <label class="q-label">Any other information</label>
    <textarea id="otherInfo" rows="2"></textarea>

    <div class="form-actions">
      <button id="submitBtn" type="button">Submit</button>
      <button id="clearBtn" type="button">Clear</button>

      <div style="margin-left:auto;font-weight:600; display:flex; gap:8px; align-items:center;">
        <div>Online:</div>
        <div id="status">online</div>
      </div>
    </div>

    <div id="msg" style="display:none"></div>
    <div id="offlineNotice" class="offline-msg" style="display:none">Connect to internet</div>
    <div class="small" style="margin-top:6px">Status: <span id="status-duplicate" style="display:inline"></span></div>
  </div>

  <script src="app.js"></script> <!-- keep your existing app.js for submission logic -->

  <script>
    // --- Config / server endpoint detection ---
    // prefer global ENDPOINT & SHARED_TOKEN from app.js if present
    const SERVER_ENDPOINT = window.ENDPOINT || "https://script.google.com/macros/s/AKfycbyLNi2uoDJj7kvm26JxmO29C10K0_x4t6rtaTJoUFwmdCCZVvPqAnegFQ3e8zCFUSfaCg/exec";
    const SERVER_TOKEN = window.SHARED_TOKEN || "shopSecret2025";

    // small JSONP helper used for config save/load
    function jsonpCall(url, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
        window[cbName] = function(data) {
          try { resolve(data); } finally { try { delete window[cbName]; } catch(e){} }
        };
        const full = url + (url.indexOf('?') === -1 ? '?' : '&') + 'callback=' + cbName;
        const script = document.createElement('script');
        script.src = full;
        script.onerror = function(){ reject(new Error('JSONP load error')); try{ delete window[cbName]; }catch(e){} };
        document.body.appendChild(script);
        setTimeout(() => { try{ delete window[cbName]; }catch(e){} reject(new Error('JSONP timeout')); }, timeoutMs);
      });
    }

    // --- customization logic ---
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('appContainer');
      const gear = document.getElementById('gearBtn');
      const customPanel = document.getElementById('customPanel');
      const applyPreviewBtn = document.getElementById('applyPreviewBtn');
      const saveServerBtn = document.getElementById('saveServerBtn');
      const cancelCustomBtn = document.getElementById('cancelCustomBtn');
      const loadDefaultBtn = document.getElementById('loadDefaultBtn');
      const panelCloseX = document.getElementById('panelCloseX');

      let customizeMode = false;
      let editingSession = false;

      // collect all editable spans
      const editableEls = Array.from(document.querySelectorAll('.editable'));

      // helper to toggle UI interactivity while customizing
      function setCustomizeMode(on) {
        customizeMode = !!on;
        container.classList.toggle('customize-mode', customizeMode);

        // disable pointer events for inputs & checkboxes to avoid accidental changes
        const interactive = container.querySelectorAll('input, textarea, button');
        interactive.forEach(el => {
          // keep the gear button & customization panel controls active
          if (el.id === 'gearBtn' || el.closest('#customPanel')) return;
          if (customizeMode) {
            el.classList.add('no-pointer');
          } else {
            el.classList.remove('no-pointer');
          }
        });

        if (customizeMode) {
          // show panel
          customPanel.style.display = 'block';
        } else {
          customPanel.style.display = 'none';
          // ensure we are not leaving editable state active
          endEditingSession();
        }
      }

      gear.addEventListener('click', function() {
        // toggle panel visibility / mode
        if (!customizeMode) {
          setCustomizeMode(true);
        } else {
          // if already in customize mode but not editing, close panel and exit
          setCustomizeMode(false);
        }
      });

      // start editing session: make labels contentEditable and hide panel
      function startEditingSession() {
        editingSession = true;
        // make labels editable
        editableEls.forEach(el => {
          el.contentEditable = "true";
          el.classList.add('editing');
          // remove no-pointer on editable spans so they remain clickable even though inputs are blocked
          el.classList.remove('no-pointer');
        });
        // hide the panel so user can interact with labels
        customPanel.style.display = 'none';
        // put focus in first editable
        const first = editableEls[0];
        if (first) {
          first.focus();
          // place caret at end
          try {
            if (document.createRange && window.getSelection) {
              const range = document.createRange();
              range.selectNodeContents(first);
              range.collapse(false);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          } catch (e){}
        }
      }

      // end editing session: make labels non-editable
      function endEditingSession() {
        editingSession = false;
        editableEls.forEach(el => {
          try { el.contentEditable = "false"; } catch(e){}
          el.classList.remove('editing');
        });
      }

      // Clicking an editable span starts inline editing only when in customizeMode AND editingSession active (we trigger editingSession via Apply Preview)
      editableEls.forEach(el => {
        el.setAttribute('contenteditable','false');
        el.addEventListener('click', function(ev) {
          if (!customizeMode) return;
          // if the user already applied preview (editingSession true), allow inline click (we already set contentEditable)
          if (editingSession) {
            // nothing — element is already editable
            return;
          }
          // if panel is open, clicking the label should not start edit. We expect user to press Apply Preview first.
          // Give a hint:
          alert('Click "Apply Preview" in the customization panel to start editing labels.');
        });
        // finish editing on blur
        el.addEventListener('blur', function() {
          if (el.getAttribute('data-editing')) {
            el.contentEditable = "false";
            el.removeAttribute('data-editing');
          }
        });
        // Enter to finish editing
        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            el.blur();
          }
        });
      });

      // Apply Preview: enter editing session (close panel, allow inline edits)
      applyPreviewBtn.addEventListener('click', function() {
        // ensure customize mode is on
        if (!customizeMode) setCustomizeMode(true);
        startEditingSession();
        alert('Preview: labels are now editable inline. Click any label to edit. When done click Save (server) to persist or Cancel to exit.');
      });

      // Load Default: reload page to restore defaults
      loadDefaultBtn.addEventListener('click', function(){
        if (!confirm('Reload page to restore defaults? Unsaved edits will be lost.')) return;
        window.location.reload();
      });

      // Cancel customization: exit customize mode (and editing)
      cancelCustomBtn.addEventListener('click', function() {
        if (!confirm('Exit customization mode? Unsaved edits will be lost.')) {
          return;
        }
        endEditingSession();
        setCustomizeMode(false);
      });

      // panel close X (same as cancel)
      panelCloseX.addEventListener('click', function() {
        // if currently in editing session, closing panel shouldn't kill edits; instead ask user
        if (editingSession) {
          if (!confirm('Editing in progress. Close panel but keep edit mode? (Choose Cancel in panel to abort edits)')) {
            return;
          }
        }
        // close panel but keep customize mode on (so user can re-open)
        customPanel.style.display = 'none';
      });

      // Escape key handling: close panel or exit editing
      document.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') {
          if (customPanel.style.display === 'block') {
            // close the panel (but keep customizeMode active)
            customPanel.style.display = 'none';
            return;
          }
          if (editingSession) {
            // exit editing session
            if (confirm('Exit edit mode? Unsaved changes remain only locally.')) {
              endEditingSession();
              setCustomizeMode(false);
            }
          }
        }
      });

      // Build config object from current DOM (map by data-config-id -> text)
      function buildConfigObject() {
        const cfg = { labels: {}, title: '' };
        cfg.title = (document.getElementById('appTitle')||{textContent:''}).textContent.trim();
        editableEls.forEach(el => {
          const key = el.getAttribute('data-config-id') || el.id || null;
          if (key) cfg.labels[key] = el.textContent.trim();
        });
        return cfg;
      }

      // Save server: send config via JSONP action=saveConfig
      saveServerBtn.addEventListener('click', async function(){
        // finish any inline editing first
        endEditingSession();
        const cfg = buildConfigObject();
        const cfgStr = JSON.stringify(cfg);
        const url = SERVER_ENDPOINT + '?action=saveConfig&token=' + encodeURIComponent(SERVER_TOKEN) + '&config=' + encodeURIComponent(cfgStr);
        try {
          saveServerBtn.disabled = true; saveServerBtn.textContent = 'Saving...';
          const resp = await jsonpCall(url, 20000);
          saveServerBtn.disabled = false; saveServerBtn.textContent = 'Save (server)';
          if (resp && resp.success) {
            alert('Customization saved on server.');
            setCustomizeMode(false);
          } else {
            console.error('save resp', resp);
            alert('Save failed. Server returned error. Check console.');
          }
        } catch (err) {
          console.error('save err', err);
          alert('Save to server failed. Please ensure ENDPOINT & SHARED_TOKEN in app.js are correct and you are online.');
          saveServerBtn.disabled = false; saveServerBtn.textContent = 'Save (server)';
        }
      });

      // On load: try to fetch saved config and apply
      (async function tryLoadConfig(){
        try {
          const url = SERVER_ENDPOINT + '?action=getConfig&token=' + encodeURIComponent(SERVER_TOKEN);
          const resp = await jsonpCall(url, 15000);
          if (resp && resp.success && resp.config) {
            applyConfig(resp.config);
          } else {
            // no config found or error; ignore
          }
        } catch (e) {
          console.warn('Could not load config:', e);
        }
      })();

      // apply config object (labels map)
      function applyConfig(cfg) {
        if (!cfg) return;
        if (cfg.title) {
          const t = document.getElementById('appTitle');
          if (t) t.textContent = cfg.title;
        }
        if (cfg.labels) {
          Object.keys(cfg.labels).forEach(key => {
            const sel = '[data-config-id="' + key + '"]';
            const el = document.querySelector(sel) || document.getElementById(key);
            if (el) el.textContent = cfg.labels[key];
          });
        }
      }

      // Expose helper for debugging
      window.getCurrentCustomization = function(){ return buildConfigObject(); };

      // make nested sublists show/hide when main toggles (existing behavior)
      const mainToSub = {
        'p_floor': 'sublist_floor',
        'p_wall': 'sublist_wall',
        'p_san':  'sublist_san',
        'p_acc':  'sublist_acc'
      };
      Object.keys(mainToSub).forEach(mainId => {
        const mainCb = document.getElementById(mainId);
        const subDiv = document.getElementById(mainToSub[mainId]);
        if (!mainCb || !subDiv) return;
        function update() {
          subDiv.style.display = mainCb.checked ? 'block' : 'none';
          if (!mainCb.checked) {
            subDiv.querySelectorAll('.subitem').forEach(sb => { sb.checked = false; });
            subDiv.querySelectorAll('.subqty').forEach(q => { q.value=''; q.disabled = true; });
          }
        }
        mainCb.addEventListener('change', update);
        update();
      });

      // generic subitem checkbox -> enable its qty input
      document.querySelectorAll('.subitem').forEach(function(subCb) {
        const id = subCb.id;
        const qtyId = 'q' + id.slice(3);
        const qtyEl = document.getElementById(qtyId);
        subCb.addEventListener('change', function() {
          if (qtyEl) {
            qtyEl.disabled = !subCb.checked;
            if (!subCb.checked) qtyEl.value = '';
          }
        });
        if (qtyEl) qtyEl.disabled = !subCb.checked;
      });

      // Others main checkbox -> enable its qty
      const otherMain = document.getElementById('p_other');
      const otherQty = document.getElementById('q_other');
      if (otherMain && otherQty) {
        function updOther() {
          otherQty.disabled = !otherMain.checked;
          if (!otherMain.checked) otherQty.value = '';
        }
        otherMain.addEventListener('change', updOther);
        updOther();
      }

    }); // DOMContentLoaded end
  </script>
</body>
</html>



