<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tile Purchase Entry</title>
  <link rel="manifest" href="manifest.json">
  <style>
    html,body { height:100%; margin:0; padding:0; }
    body {
      background-image: url('./background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      font-family: Arial, sans-serif;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    .container {
      width:100%;
      max-width:920px;
      background: rgba(255,255,255,0.98);
      border-radius:10px;
      padding:14px;
      box-sizing:border-box;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      position: relative;
    }
    h1{font-size:20px;margin:0 0 10px 0; display:flex; align-items:center; gap:8px;}
    .gear {
      margin-left:auto; cursor:pointer; font-size:18px; color:#2c7be5;
    }
    .q-label{display:block;margin-top:10px;font-weight:600}
    input[type="text"], input[type="number"], select, textarea {
      width:100%; padding:8px; font-size:15px; margin-top:6px; box-sizing:border-box;
      border:1px solid #ccc; border-radius:4px;
    }
    /* main item row and nested sublist */
    .item-row { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .item-row label { flex:1; display:flex; align-items:center; gap:8px; }
    .qty { width:110px; flex:0 0 110px; }
    .sublist { margin-left:28px; margin-top:6px; padding-left:6px; border-left:2px solid rgba(0,0,0,0.04); display:none; }
    .sub-item { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .sub-item label { flex:1; display:flex; align-items:center; gap:8px; }
    .checkbox-row { margin-top:6px; padding:0; }
    .cb { display:block; width:100%; padding:6px 0; box-sizing:border-box; }

    /* quantity + unit inline controls */
    .qty-unit {
      display:flex;
      gap:6px;
      align-items:center;
      min-width:280px;
      justify-content:flex-end;
    }
    .qty-unit input[type="number"] { width:90px; padding:6px; font-size:14px; }
    .qty-unit select { width:120px; padding:6px; font-size:14px; }
    .qty-unit .unit-custom { width:110px; padding:6px; font-size:14px; display:none; }
    .unit-lock {
      display:inline-flex;
      align-items:center;
      gap:4px;
      margin-left:6px;
    }
    .unit-lock input[type="checkbox"] { transform: scale(1.25); margin:0; }

    /* payment inline controls */
    .mode-row { display:flex; align-items:center; gap:12px; margin-top:6px; }
    .mode-row .mode-label { flex:1; display:flex; align-items:center; gap:8px; }
    .mode-amount { width:160px; flex:0 0 160px; }
    .total-row { margin-top:8px; display:flex; gap:12px; align-items:center; }
    .total-row label { font-weight:600; }

    button{ margin-top:12px; padding:10px 14px; font-size:16px; border-radius:6px; border: none; background:#2c7be5; color:white; cursor:pointer; }
    button#clearBtn { background:#6c757d; }
    .offline-msg { margin-top:10px; color:#b71c1c; font-weight:700; font-size:15px; }
    .small{font-size:13px;color:#666;margin-top:6px}
    .form-actions { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }

    @media (max-width:920px){
      .container { padding:10px; }
    }
    @media (max-width:620px){
      .item-row { flex-direction:column; align-items:flex-start }
      .qty { width:100%; flex:0 0 auto }
      .sub-item { flex-direction:column; align-items:flex-start }
      .mode-row { flex-direction:column; align-items:stretch }
      .mode-amount { width:100%; flex:auto }
      .total-row { flex-direction:column; align-items:stretch }
      .qty-unit { width:100%; justify-content:flex-start; }
      .qty-unit input[type="number"], .qty-unit select, .qty-unit .unit-custom { width:40%; }
    }

    /* make touch targets larger for checkboxes (and slightly larger radios) */
    input[type="checkbox"] {
      transform: scale(1.45);
      margin-right: 10px;
      -webkit-transform: scale(1.45);
      -webkit-margin-end: 10px;
    }
    input[type="radio"] {
      transform: scale(1.25);
      margin-right: 8px;
      -webkit-transform: scale(1.25);
    }
    .cb input[type="checkbox"], .cb input[type="radio"] {
      vertical-align: middle;
    }

    /* editable label visuals */
    .editable { padding:2px 6px; border-radius:4px; cursor:text; display:inline-block; }
    .customize-mode .editable { background: #fffbe6; border:1px dashed #ffd966; }
    .editable[contenteditable="true"] { outline: 2px solid #2c7be5; background: #ffffff; }

    /* small modal panel for customization instructions & buttons */
    /* portrait-friendly popup */
    #customPanel {
      position: fixed;
      left: 50%;
      top: 90px;
      transform: translateX(-50%);
      width: 760px;
      max-width: calc(100% - 48px);
      background: white;
      border-radius:8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      padding:12px;
      z-index: 1200;
      display:none;
      max-height: calc(80vh);   /* limit height so mobile can scroll */
      overflow: auto;
      box-sizing: border-box;
    }
    #customPanel .panel-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    #customPanel .panel-row .note { flex:1; font-size:14px; color:#333; }
    #customPanel .panel-actions { display:flex; gap:8px; }
    #customPanel .close-x { position:absolute; right:10px; top:8px; background:transparent; border:none; font-size:20px; cursor:pointer; }
    
    /* NEW: Unit list styling */
    #unitList {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .unit-tag {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 14px;
    }
    .unit-tag button {
      margin: 0;
      margin-left: 6px;
      padding: 2px 4px;
      font-size: 12px;
      line-height: 1;
      background: #dc3545;
      color: white;
      border-radius: 3px;
    }

    /* small top-right badge showing Customize mode on */
    .custom-mode-badge {
      position: absolute; right: 16px; top: 12px; padding:6px 8px; background:#fff4cc; border-radius:6px; color:#6a4f00; font-weight:700; display:none;
    }
    .customize-mode .custom-mode-badge { display:block; }

    /* prevent pointer interactions for inputs while editing (applied when customization active) */
    .customize-mode .no-pointer { pointer-events: none; opacity: 0.7; }

    /* MOBILE-SPECIFIC: make popup portrait-shaped and centered for small screens */
    @media (max-width: 600px) {
      #customPanel {
        width: 92vw;
        max-width: 420px;
        height: 70vh;           /* portrait feel */
        max-height: 70vh;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%); /* center vertically on mobile */
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.45);
        overflow: auto;        /* allow inner scroll */
      }
      #customPanel .panel-row { flex-direction: column; align-items:stretch; gap:10px; }
      #customPanel .panel-actions { flex-wrap:wrap; justify-content:flex-end; }
      #customPanel .close-x { font-size:22px; right:6px; top:6px; }
    }

    /* delete button next to labels (hidden by default, shown in customize mode) */
    .del-btn {
      display: none;
      background: transparent;
      border: none;
      color: #b71c1c;
      font-weight: 700;
      cursor: pointer;
      padding: 2px 6px;
      margin-left: 6px;
      border-radius: 4px;
    }
    .customize-mode .del-btn { display: inline-block; }

    /* inline remove-circle used while customizing (generated by JS) */
    .remove-checkbox {
      display:inline-flex;
    }

    /* Purchased-from custom manager styling */
    #customVendorManager {
      border:1px dashed #cfcfcf;
      padding:8px;
      border-radius:6px;
      background:#fafafa;
      margin-top:8px;
    }
    #customVendorManager .vendor-list { max-height:160px; overflow:auto; margin-bottom:8px; }
    #customVendorManager .vendor-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px; border-radius:4px; background:white; margin-bottom:6px; border:1px solid #eee; }
    #customVendorManager .vendor-item button { background:#b71c1c; padding:6px 8px; border-radius:6px; border:none; font-weight:700; }
    #customVendorManager .vendor-actions { display:flex; gap:8px; align-items:center; }
    #customVendorManager input[type="text"] { margin-top:0; margin-bottom:0; }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
     <a class="sheet-link"
       href="https://docs.google.com/spreadsheets/d/1YyjZjRbePZ4fL40hKgJloSLJMzWZgW-6fFIvc-A7ELQ/edit"
       target="_blank" rel="noopener" aria-label="Open Google sheet">Google sheet</a>
    <h1>
      <span id="appTitle">Tile Purchase Entry</span>
      <span class="gear" id="gearBtn" title="Customize form">⚙️</span>
    </h1>

    <div class="custom-mode-badge">Customize mode</div>

    <div id="customPanel" role="dialog" aria-modal="true" aria-label="Customize form">
      <button class="close-x" id="panelCloseX" title="Close (Esc)">×</button>
      <strong>Customize form text</strong>
      <div style="margin-top:8px">Click any visible text label on the form to edit it directly. After editing, use <b>Apply Preview</b> to try changes locally or <b>Save (server)</b> to store the customization so it will persist next time the app loads.</div>
      <div class="panel-row">
        <div class="note">When customizing, form controls are temporarily disabled to avoid accidental clicks. Only text labels are editable.</div>
        <div class="panel-actions">
          <button id="loadDefaultBtn" type="button">Load Default</button>
          <button id="applyPreviewBtn" type="button">Apply Preview</button>
          <button id="saveServerBtn" type="button">Save (server)</button>
          <button id="cancelCustomBtn" type="button" style="background:#6c757d">Cancel</button>
        </div>
      </div>

      <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
        <strong>Add / Remove Sub-items</strong>
        <div style="font-size:13px;color:#444;margin-top:6px">Add a new checkbox sub-item to a main category. While in Customize mode you'll see a red ✕ next to each sub-item label to remove it.</div>
        
        <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
          <strong>Manage Units of Measure (global)</strong>
          <div style="font-size:13px;color:#444;margin-top:6px">
            Add custom units that will be available in all unit dropdowns throughout the form.
          </div>

          <div class="panel-row" style="margin-top:8px; align-items:center;">
            <input id="newUnitInput" type="text" placeholder="Enter new unit name" style="flex:1;" maxlength="20">
            <button id="addUnitBtn" type="button" style="margin-left:8px;">Add Unit</button>
          </div>

          <div id="unitList" style="margin-top:8px; max-height:160px; overflow:auto; padding: 4px 0;">
            </div>
        </div>
        <div class="panel-row" style="margin-top:8px; align-items:center;">
          <select id="addCategorySelect" style="width:40%; padding:8px; font-size:14px;">
            <option value="floor">Floor Tiles</option>
            <option value="wall">Wall Tiles</option>
            <option value="san">Sanitaryware</option>
            <option value="acc">Accessories</option>
            <option value="mode">Mode of payment</option>
          </select>
          <input id="addSubLabelInput" type="text" placeholder="New sub-item label (e.g. 'Large format tiles')" style="flex:1; margin-left:8px;">
          <button id="addSubBtn" type="button" style="margin-left:8px;">Add Sub-item</button>
        </div>
        <div class="panel-row" style="margin-top:8px;">
          <div class="note">Note: IDs of dynamically added items start with <code>sub_</code> (e.g. <code>sub_floor_custom1</code>). New payment modes will be created with a checkbox named <code>modeOfPayment</code> and an amount input (data-mode-amount) so your submission logic picks them up.</div>
        </div>
      </div>
    </div>

    <label class="q-label">1. <span id="qPurchasedLabel">Purchased what (check items and enter quantity for specific sub-items)</span></label>
    <div class="checkbox-row" id="purchasedList">

      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_floor" value="Floor Tiles">
          <span class="editable" data-config-id="p_floor_label" id="label_p_floor">Floor Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_floor">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_vitrified" value="Vitrified tiles">
            <span class="editable" data-config-id="sub_floor_vitrified_label" id="label_sub_floor_vitrified">Vitrified tiles (most popular for homes/offices)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>

          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_vitrified" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_vitrified" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_vitrified" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item">
              <input type="checkbox" id="lock_floor_vitrified" /> lock
            </label>
          </div>

        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_ceramic" value="Ceramic tiles">
            <span class="editable" data-config-id="sub_floor_ceramic_label" id="label_sub_floor_ceramic">Ceramic tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_ceramic" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_ceramic" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_ceramic" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_ceramic" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_porcelain" value="Porcelain tiles">
            <span class="editable" data-config-id="sub_floor_porcelain_label" id="label_sub_floor_porcelain">Porcelain tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_porcelain" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_porcelain" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_porcelain" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_porcelain" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_marble" value="Marble finish tiles">
            <span class="editable" data-config-id="sub_floor_marble_label" id="label_sub_floor_marble">Marble finish tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_marble" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_marble" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_marble" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_marble" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_floor_granite" value="Granite finish tiles">
            <span class="editable" data-config-id="sub_floor_granite_label" id="label_sub_floor_granite">Granite finish tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_floor_granite" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_floor_granite" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_floor_granite" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_floor_granite" /> lock</label>
          </div>
        </div>
      </div>

      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_wall" value="Wall Tiles">
          <span class="editable" data-config-id="p_wall_label" id="label_p_wall">Wall Tiles</span>
        </label>
      </div>
      <div class="sublist" id="sublist_wall">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_kitchen" value="Kitchen wall tiles (backsplash)">
            <span class="editable" data-config-id="sub_wall_kitchen_label" id="label_sub_wall_kitchen">Kitchen wall tiles (backsplash)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_kitchen" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_kitchen" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_wall_kitchen" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_wall_kitchen" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_bath" value="Bathroom wall tiles (glazed/anti-skid)">
            <span class="editable" data-config-id="sub_wall_bath_label" id="label_sub_wall_bath">Bathroom wall tiles (glazed/anti-skid)</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_bath" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_bath" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_wall_bath" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_wall_bath" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_wall_decor" value="Decorative/Designer wall tiles">
            <span class="editable" data-config-id="sub_wall_decor_label" id="label_sub_wall_decor">Decorative / designer wall tiles</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_wall_decor" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_wall_decor" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_wall_decor" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_wall_decor" /> lock</label>
          </div>
        </div>
      </div>

      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_san" value="Sanitaryware">
          <span class="editable" data-config-id="p_san_label" id="label_p_san">Sanitaryware</span>
        </label>
      </div>
      <div class="sublist" id="sublist_san">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_wash" value="Washbasins">
            <span class="editable" data-config-id="sub_san_wash_label" id="label_sub_san_wash">Washbasins</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_wash" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_wash" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_san_wash" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_san_wash" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_wc" value="WC">
            <span class="editable" data-config-id="sub_san_wc_label" id="label_sub_san_wc">WC</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_wc" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_wc" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_san_wc" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_san_wc" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_san_urinal" value="Urinals">
            <span class="editable" data-config-id="sub_san_urinal_label" id="label_sub_san_urinal">Urinals</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_san_urinal" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_san_urinal" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_san_urinal" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_san_urinal" /> lock</label>
          </div>
        </div>
      </div>

      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_acc" value="Accessories">
          <span class="editable" data-config-id="p_acc_label" id="label_p_acc">Accessories</span>
        </label>
      </div>
      <div class="sublist" id="sublist_acc">
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_grout" value="Tile grout & adhesives">
            <span class="editable" data-config-id="sub_acc_grout_label" id="label_sub_acc_grout">Tile grout & adhesives</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_grout" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_grout" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_grout" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_grout" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_spacers" value="Spacers">
            <span class="editable" data-config-id="sub_acc_spacers_label" id="label_sub_acc_spacers">Spacers</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_spacers" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_spacers" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_spacers" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_spacers" /> lock</label>
          </div>
        </div>
        <div class="sub-item" data-original="true">
          <label><input type="checkbox" class="subitem" id="sub_acc_mosaic" value="Mosaic tiles for decoration">
            <span class="editable" data-config-id="sub_acc_mosaic_label" id="label_sub_acc_mosaic">Mosaic tiles for decoration</span>
            <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
          </label>
          <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_acc_mosaic" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_acc_mosaic" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_acc_mosaic" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_acc_mosaic" /> lock</label>
          </div>
        </div>
      </div>
      
      <div class="item-row">
        <label class="cb">
          <input type="checkbox" class="purchased" id="p_other" value="Others">
          <span class="editable" data-config-id="p_other_label" id="label_p_other">Others (Non-tile/sanitary items)</span>
          <button class="del-btn" title="Remove sub-item" aria-label="Remove">✕</button>
        </label>
        <div class="qty-unit">
            <input type="number" min="0" step="1" id="q_other" class="subqty qty" placeholder="Quantity" disabled>
            <select id="unit_other" class="unit-select" disabled>
              <option value="Boxes">Boxes</option>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
            </select>
            <input type="text" id="unit_custom_other" class="unit-custom" placeholder="Custom unit" style="display:none;">
            <label class="unit-lock" title="Lock unit for this item"><input type="checkbox" id="lock_other" /> lock</label>
        </div>
      </div>
    </div>

    <label class="q-label" style="margin-top:16px;">2. <span id="qPurchasedFromLabel">Purchased from (vendor name)</span></label>
    <div id="vendorRadioGroup">
      </div>

    <label class="q-label" style="margin-top:16px;">3. <span id="qPaymentLabel">Mode of Payment & Amount</span></label>
    <div id="paymentModes" class="checkbox-row">
      <div class="mode-row" data-mode-id="mode_cash" data-original="true">
        <label class="mode-label cb">
          <input type="checkbox" name="modeOfPayment" id="mode_cash" value="Cash">
          <span class="editable" data-config-id="mode_cash_label" id="label_mode_cash">Cash</span>
          <button class="del-btn" title="Remove payment mode" aria-label="Remove">✕</button>
        </label>
        <input type="number" min="0" step="0.01" id="modeAmount_cash" data-mode-amount="Cash" class="mode-amount no-pointer" placeholder="Amount (Rs.)" disabled>
      </div>
      <div class="mode-row" data-mode-id="mode_online" data-original="true">
        <label class="mode-label cb">
          <input type="checkbox" name="modeOfPayment" id="mode_online" value="Online">
          <span class="editable" data-config-id="mode_online_label" id="label_mode_online">Online (UPI/Transfer)</span>
          <button class="del-btn" title="Remove payment mode" aria-label="Remove">✕</button>
        </label>
        <input type="number" min="0" step="0.01" id="modeAmount_online" data-mode-amount="Online" class="mode-amount no-pointer" placeholder="Amount (Rs.)" disabled>
      </div>
      <div class="mode-row" data-mode-id="mode_credit" data-original="true">
        <label class="mode-label cb">
          <input type="checkbox" name="modeOfPayment" id="mode_credit" value="Credit">
          <span class="editable" data-config-id="mode_credit_label" id="label_mode_credit">Credit/Card</span>
          <button class="del-btn" title="Remove payment mode" aria-label="Remove">✕</button>
        </label>
        <input type="number" min="0" step="0.01" id="modeAmount_credit" data-mode-amount="Credit" class="mode-amount no-pointer" placeholder="Amount (Rs.)" disabled>
      </div>
    </div>

    <div class="total-row">
      <label for="paymentPaid" style="flex:1;"><span id="qTotalPaidLabel">Total Paid (Rs.)</span></label>
      <input type="number" min="0" step="0.01" id="paymentPaid" class="mode-amount" placeholder="Total Paid (auto-synced)" style="width:160px; flex:0 0 160px;">
    </div>
    <div class="small">Enter the total amount paid. It auto-updates from individual mode amounts.</div>

    <label class="q-label" style="margin-top:16px;">4. <span id="qOtherInfoLabel">Other Information / Notes</span></label>
    <textarea id="otherInfo" rows="3" placeholder="Add any details about the purchase (e.g., transport, special discount, item description for 'Others')"></textarea>

    <div class="form-actions">
      <button id="submitBtn" type="button">Submit Entry</button>
      <button id="clearBtn" type="button">Clear Form</button>
      <span class="small" style="margin-top:0;">Last Serial: <span id="lastSerial">N/A</span></span>
    </div>
    <div id="submitMessage" class="offline-msg" style="display:none;"></div>

    <div class="small" style="margin-top:12px;">App v2.0 - Client Timestamp: <span id="clientTsDisplay"></span></div>

  </div>

  <script>
    // --- Configuration and Constants ---
    const ENDPOINT = 'YOUR_APPS_SCRIPT_URL_HERE'; // Replace with your deployed Google Apps Script URL
    const DEFAULT_UNITS = ['Boxes', 'Pieces', 'Kg'];
    let globalUnits = [];
    const LOCAL_STORAGE_KEY_UNITS = 'globalUnits_v1';
    
    // Vendor persistence (reused from your previous logic)
    const LOCAL_STORAGE_KEY_VENDORS = 'purchasedFromCustom';
    let customVendors = [];

    // --- Utility Functions ---

    /** Get element by ID safely */
    const $ = id => document.getElementById(id);

    /** Generate a submission ID */
    function makeSubmissionId() {
      return `s_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`;
    }

    /** Simple JSONP request (assuming server returns JSONP callback(data)) */
    function jsonpRequest(url, callbackName) {
      const script = document.createElement('script');
      script.src = url;
      script.onerror = () => {
        // Handle error/timeout
        $('submitMessage').textContent = 'Server communication error or timeout.';
        $('submitMessage').style.display = 'block';
        setTimeout(() => $('submitMessage').style.display = 'none', 5000);
      };
      document.head.appendChild(script);
      
      // Clean up script tag after response (success/error)
      window[callbackName] = (data) => {
        delete window[callbackName];
        document.head.removeChild(script);
        // Call the data handler if provided, otherwise the response itself is the result
        return data; 
      };
      return window[callbackName]; // Return the function stub for the response
    }

    // A simplified wrapper to send data or config to the server
    function sendToServerJSONP(params, callback) {
        const callbackName = 'jsonpCallback_' + Date.now();
        params.callback = callbackName;
        
        let queryString = Object.keys(params)
            .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
            .join('&');

        const url = `${ENDPOINT}?${queryString}`;

        $('submitMessage').textContent = 'Sending data...';
        $('submitMessage').style.display = 'block';

        window[callbackName] = (data) => {
            $('submitMessage').style.display = 'none';
            if (callback) callback(data);
        };

        jsonpRequest(url, callbackName);
    }
    
    // --- Unit Management Functions (NEW/MODIFIED) ---

    /** Load globalUnits array from localStorage */
    function loadGlobalUnits() {
        try {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY_UNITS);
            globalUnits = stored ? JSON.parse(stored).filter(u => u && typeof u === 'string').map(u => u.trim()) : [];
        } catch (e) {
            console.error('Error loading global units:', e);
            globalUnits = [];
        }
    }

    /** Save globalUnits array to localStorage */
    function saveGlobalUnits() {
        localStorage.setItem(LOCAL_STORAGE_KEY_UNITS, JSON.stringify(globalUnits));
    }

    /** Renders the list of custom units in the customization panel */
    function renderUnitList() {
        const unitListContainer = $('unitList');
        if (!unitListContainer) return;

        unitListContainer.innerHTML = '';
        if (globalUnits.length === 0) {
            unitListContainer.innerHTML = '<div style="font-style:italic; color:#666;">No custom units added yet.</div>';
            return;
        }

        globalUnits.forEach(unit => {
            const tag = document.createElement('div');
            tag.className = 'unit-tag';
            tag.textContent = unit;

            const removeBtn = document.createElement('button');
            removeBtn.textContent = '✕';
            removeBtn.title = `Remove unit: ${unit}`;
            removeBtn.onclick = () => {
                removeGlobalUnit(unit);
            };

            tag.appendChild(removeBtn);
            unitListContainer.appendChild(tag);
        });
    }

    /** Adds a unit to the global list */
    function addGlobalUnit(unit) {
        unit = unit.trim();
        if (!unit || unit.length > 20) return alert('Unit name is required and must be 20 characters or less.');
        
        // Combine defaults and current customs for case-insensitive check
        const allCurrentUnits = [...DEFAULT_UNITS, ...globalUnits].map(u => u.toLowerCase());

        if (allCurrentUnits.includes(unit.toLowerCase())) {
            $('newUnitInput').value = '';
            return alert(`Unit "${unit}" already exists.`);
        }

        globalUnits.push(unit);
        saveGlobalUnits();
        renderUnitList();
        rebuildAllUnitSelects();
        $('newUnitInput').value = '';
    }

    /** Removes a unit from the global list */
    function removeGlobalUnit(unitToRemove) {
        if (!confirm(`Are you sure you want to remove the unit "${unitToRemove}"? This will be removed from all dropdowns.`)) {
            return;
        }
        globalUnits = globalUnits.filter(unit => unit !== unitToRemove);
        saveGlobalUnits();
        renderUnitList();
        rebuildAllUnitSelects();
    }

    /** Rebuilds all unit select dropdowns on the page */
    function rebuildAllUnitSelects() {
        const allSelects = document.querySelectorAll('.unit-select');
        const availableUnits = [...DEFAULT_UNITS, ...globalUnits];

        allSelects.forEach(select => {
            const suffix = select.id.replace('unit_', '');
            const lockedValue = localStorage.getItem(`unitValue_${suffix}`);
            const currentSelection = select.value;
            
            // 1. Clear existing options
            select.innerHTML = '';
            
            // 2. Add all available options (defaults + global custom)
            availableUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                select.appendChild(option);
            });
            
            // 3. Handle Backward Compatibility for a Locked, Missing Custom Unit
            if (lockedValue && !availableUnits.includes(lockedValue)) {
                // If the locked value isn't in the list (old/unmanaged custom value), temporarily add it to this select.
                const tempOption = document.createElement('option');
                tempOption.value = lockedValue;
                tempOption.textContent = lockedValue + ' (Custom)';
                select.appendChild(tempOption);
                
                // Also show the custom input for this item so the user can see/edit it
                const customInput = $(`unit_custom_${suffix}`);
                if (customInput) customInput.style.display = 'inline';
            } else {
                 // Hide the custom input if the locked value is now a managed global unit or a default one.
                const customInput = $(`unit_custom_${suffix}`);
                if (customInput) customInput.style.display = 'none';
            }
            
            // 4. Restore selection: preference order: lockedValue > currentSelection > first option
            if (lockedValue) {
                 select.value = lockedValue;
            } else if (currentSelection && availableUnits.includes(currentSelection)) {
                select.value = currentSelection;
            } else if (select.options.length > 0) {
                 select.value = select.options[0].value;
            }

            // Bind the change handler again (in case dynamic elements were created)
            bindUnitSelectHandler(select);
        });
    }
    
    /** Handler for when a unit is selected */
    function bindUnitSelectHandler(selectElement) {
        // Remove old handler to prevent duplicates, then add new one
        selectElement.removeEventListener('change', handleUnitSelectChange);
        selectElement.addEventListener('change', handleUnitSelectChange);
    }
    
    function handleUnitSelectChange(event) {
        const select = event.target;
        const suffix = select.id.replace('unit_', '');
        const unitCustomInput = $(`unit_custom_${suffix}`);
        const unitLockCheckbox = $(`lock_${suffix}`);
        const selectedValue = select.value;

        // Hide custom input if a standard/global unit is selected
        if (unitCustomInput) unitCustomInput.style.display = 'none';

        // Check if the selected unit is a hardcoded default or a global unit
        const isStandardOrGlobal = [...DEFAULT_UNITS, ...globalUnits].includes(selectedValue);

        // If a locked unit is being changed, clear the lock unless the *new* value is being locked.
        if (unitLockCheckbox && unitLockCheckbox.checked) {
            // Uncheck lock if the value changes from the locked value.
            // But for now, we'll let the lock persist until the unitLock handler runs.
            // The logic to save/clear the lock is in the lock handler.
        }

        // The old custom logic (typing into a custom box) has been replaced by the global unit manager.
        // The custom input remains solely for backward compatibility with *old* locked values that haven't been migrated.
        // It's hidden unless a non-global, non-default locked value is present (handled in rebuildAllUnitSelects).
    }
    
    /** Saves the unit lock setting to localStorage (Lock checkbox handler) */
    function saveUnitLock(suffix) {
        const lockCheckbox = $(`lock_${suffix}`);
        const unitSelect = $(`unit_${suffix}`);
        const unitCustomInput = $(`unit_custom_${suffix}`);
        
        if (!lockCheckbox || !unitSelect || !unitCustomInput) return;

        if (lockCheckbox.checked) {
            let unitValue = unitSelect.value;
            
            // Check if it's a backward compatibility custom input showing
            if (unitCustomInput.style.display !== 'none' && unitCustomInput.value.trim()) {
                 unitValue = unitCustomInput.value.trim();
                 // If the user locks a new custom value, we should attempt to add it globally
                 addGlobalUnit(unitValue);
            }
            
            // Save the locked state and the actual value
            localStorage.setItem(`unitLock_${suffix}`, 'true');
            localStorage.setItem(`unitValue_${suffix}`, unitValue);
            
            // Rebuild all selects just in case a new unit was added or to normalize the current one
            rebuildAllUnitSelects(); 
            // After rebuild, ensure the select is set to the locked value (it should be)
            unitSelect.value = unitValue;
            
        } else {
            // Lock is unchecked, clear persistence keys
            localStorage.removeItem(`unitLock_${suffix}`);
            localStorage.removeItem(`unitValue_${suffix}`);
            // Force a refresh of selects to hide the custom input if needed
            rebuildAllUnitSelects(); 
        }
        
        // Re-enable/re-check the lock after rebuild
        lockCheckbox.checked = localStorage.getItem(`unitLock_${suffix}`) === 'true';
    }

    /** Restores unit lock settings on load */
    function initializeUnitLocks() {
        document.querySelectorAll('input[id^="lock_"]').forEach(lockCheckbox => {
            const suffix = lockCheckbox.id.replace('lock_', '');
            const isLocked = localStorage.getItem(`unitLock_${suffix}`) === 'true';
            lockCheckbox.checked = isLocked;
            
            // The unit select value is handled by rebuildAllUnitSelects,
            // which respects the unitValue_<suffix> storage item.
            
            lockCheckbox.onchange = () => saveUnitLock(suffix);
        });
    }

    // --- Other Existing Logic (Snipped for brevity, but assumed to be here) ---

    // ... (rest of your existing app.js functions like: )
    // setupMainToSubBindings()
    // bindSubitemHandlers()
    // collectFormData()
    // doSubmitFlow()
    // recalcPaymentFromModes()
    // bindModeToggle()
    // applyConfig()
    // buildConfigObject()
    // loadSavedConfig()
    // ...

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. New Unit Logic Initialization
        loadGlobalUnits();
        renderUnitList();
        
        // 2. Rebuild selects *before* restoring locks (so locks can select correct option)
        rebuildAllUnitSelects();
        
        // 3. Restore locks
        initializeUnitLocks(); 

        // 4. Bind Unit Management Events
        const newUnitInput = $('newUnitInput');
        const addUnitBtn = $('addUnitBtn');

        if (addUnitBtn) {
            addUnitBtn.addEventListener('click', () => {
                addGlobalUnit(newUnitInput.value);
            });
        }
        if (newUnitInput) {
            newUnitInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addGlobalUnit(newUnitInput.value);
                }
            });
        }
        
        // --- Other Existing Initialization (Re-bind existing functions) ---
        
        // The following calls would normally exist in your app.js:
        // setupMainToSubBindings(); // To show/hide sublists
        // bindSubitemHandlers();    // To enable qty/unit fields
        // bindModeToggle();         // To enable/disable mode amounts
        // initializeUnitLocks();    // (Already moved above for better ordering)
        // loadSavedConfig();        // To load server config
        // ...
        
        // Set client timestamp for debugging (optional)
        $('clientTsDisplay').textContent = new Date().toISOString();

        // Placeholder for existing event listeners (submit, clear, gear/customize)
        // ...
    });

    // Dummy functions for remaining required structure (replace with your full app.js)
    function setupMainToSubBindings() { /* Your existing function */ }
    function bindSubitemHandlers() { /* Your existing function */ }
    function bindModeToggle() { /* Your existing function */ }
    function loadSavedConfig() { /* Your existing function */ }

  </script>
</body>
</html>
